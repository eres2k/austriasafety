<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Injury & Illness Analysis Tool - Amazon Austria WHS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #232F3E 0%, #37475A 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .control-panel h2 {
            color: #232F3E;
            margin-bottom: 15px;
        }
        
        .button-group {
            margin-bottom: 15px;
        }
        
        button, input[type="file"] {
            background: #FF9900;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input[type="file"] {
            background: #232F3E;
            margin-right: 10px;
            font-family: inherit;
        }
        
        input[type="file"]::-webkit-file-upload-button {
            background: #FF9900;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
            font-family: inherit;
        }
        
        input[type="file"]::-webkit-file-upload-button:hover {
            background: #e88600;
        }
        
        input[type="file"]::file-selector-button {
            background: #FF9900;
            color: white;
            border: none;
            padding: 5px 15px;
            border-radius: 3px;
            cursor: pointer;
            margin-right: 10px;
            font-family: inherit;
        }
        
        input[type="file"]::file-selector-button:hover {
            background: #e88600;
        }
        
        button:hover, input[type="file"]:hover {
            background: #e88600;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }
        
        .card h3 {
            color: #232F3E;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }
        
        .metric {
            font-size: 3rem;
            font-weight: bold;
            color: #FF9900;
            margin: 10px 0;
        }
        
        .sub-metric {
            font-size: 1rem;
            color: #666;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 10px;
        }
        
        .data-table {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #232F3E;
            color: white;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 600;
            color: #232F3E;
        }
        
        select, input[type="date"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .risk-matrix {
            display: grid;
            grid-template-columns: 60px repeat(5, 1fr);
            grid-template-rows: repeat(6, 60px);
            gap: 2px;
            margin-top: 20px;
        }
        
        .matrix-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .matrix-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .matrix-label {
            background: #232F3E;
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .risk-low { background: #4CAF50; }
        .risk-medium { background: #FFC107; }
        .risk-high { background: #FF5722; }
        .risk-critical { background: #B71C1C; }
        
        .tabs {
            display: flex;
            background: white;
            border-radius: 10px 10px 0 0;
            overflow: hidden;
            margin-top: 20px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            background: #f0f0f0;
            border-right: 1px solid #ddd;
            transition: background 0.3s;
        }
        
        .tab:hover {
            background: #e0e0e0;
        }
        
        .tab.active {
            background: white;
            color: #FF9900;
            font-weight: 600;
        }
        
        .tab-content {
            background: white;
            padding: 20px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }
        
        .export-options {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .timeline-item {
            border-left: 3px solid #FF9900;
            padding-left: 20px;
            margin-bottom: 20px;
            position: relative;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: #FF9900;
        }
        
        .severity-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 5px;
        }
        
        .severity-low { background: #4CAF50; color: white; }
        .severity-medium { background: #FFC107; color: #333; }
        .severity-high { background: #FF5722; color: white; }
        .severity-critical { background: #B71C1C; color: white; }
        .severity-a { background: #B71C1C; color: white; }
        .severity-b { background: #FF5722; color: white; }
        .severity-c { background: #FFC107; color: #333; }
        .severity-d { background: #4CAF50; color: white; }
        .severity-unknown { background: #9E9E9E; color: white; }
        
        .recordable-yes { background: #FF5722; color: white; }
        .recordable-no { background: #4CAF50; color: white; }
        
        #pdfPreview {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Injury & Illness Analysis Tool</h1>
        <p>Amazon Austria WHS - Data Analytics Platform</p>
    </div>
    
    <div class="container">
        <div class="control-panel">
            <h2>Data Management</h2>
            <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
               <strong>📌 Quick Start:</strong> Click "Choose File" to upload your Injury & Illness CSV file, or try "Test with Sample Data" to see the dashboard in action.
<br><small>Supports CSV files with injury/illness tracking data including severity, body parts, causes, recordability, and OTR status.</small>
            </div>
            
            <div class="button-group">
                <div style="display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 10px;">
                    <label style="font-weight: bold; min-width: 100px;">CSV File:</label>
                    <input type="file" id="csvInput" accept=".csv" onchange="handleFileUpload(event)" style="flex: 1; padding: 10px; font-size: 16px;">
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="exportToExcel()">📊 Export to Excel</button>
                    <button onclick="generatePDFReport()">📄 Generate PDF Report</button>
                    <button onclick="refreshDashboard()">🔄 Refresh Dashboard</button>
                    <button onclick="testWithSampleData()">🧪 Test with Sample Data</button>
                    <button onclick="debugInfo()" style="background: #666;">🐛 Debug Info</button>
                </div>
            </div>
            <div id="statusMessage" style="margin-top: 10px; padding: 10px; background: #f0f0f0; border-radius: 5px; display: none;"></div>
            
            <div class="filter-section">
                 <div class="filter-group">
                    <label>Site:</label>
                    <select id="siteFilter">
                        <option value="">All Sites</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Severity:</label>
                    <select id="severityFilter">
                        <option value="">All Severities</option>
                        <option value="A">A - Critical</option>
                        <option value="B">B - High</option>
                        <option value="C">C - Medium</option>
                        <option value="D">D - Low</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Recordable:</label>
                    <select id="recordableFilter">
                        <option value="">All Cases</option>
                        <option value="1">Recordable Only</option>
                        <option value="0">Non-Recordable Only</option>
                    </select>
                </div>
               <div class="filter-group">
    <label>OTR (On The Road):</label>
    <select id="otrFilter">
        <option value="">All</option>
        <option value="yes">Yes</option>
        <option value="no">No</option>
    </select>
</div>
               
                <div class="filter-group">
                    <label>Date From:</label>
                    <input type="date" id="dateFrom">
                </div>
                <div class="filter-group">
                    <label>Date To:</label>
                    <input type="date" id="dateTo">
                </div>
            </div>
        </div>
        
        <div class="dashboard" id="dashboard">
            <div class="card">
                <h3>Total Incidents</h3>
                <div class="metric" id="totalCount">0</div>
                <div class="sub-metric">Year to Date</div>
            </div>
            
            <div class="card">
                <h3>Recordable Cases</h3>
                <div class="metric" id="recordableCount">0</div>
                <div class="sub-metric">OSHA Recordable</div>
            </div>
            
            <div class="card">
                <h3>Lost Time Cases</h3>
                <div class="metric" id="lostTimeCount">0</div>
                <div class="sub-metric">DAFW Cases</div>
            </div>
            
          <div class="card">
    <h3>Days Away From Work (DAFW) Analysis</h3>
    <div class="sub-metric" id="totalDafwDays" style="margin-bottom: 10px; text-align: center;">Total: 0 days lost</div>
    <div class="chart-container">
        <canvas id="dafwChart"></canvas>
    </div>
</div>
            
            <div class="card">
                <h3>Chart 1</h3>
                <select id="chart1Select" onchange="updateChart(1)" style="width: 100%; margin-bottom: 10px;">
                    <option value="severity">Severity Distribution</option>
                    <option value="rootCause">Root Causes</option>
                    <option value="bodyPart">Body Parts Affected</option>
                    <option value="processPath">Process Paths</option>
                    <option value="contributingFactors">Contributing Factors</option>      
                    <option value="otrAnalysis">OTR Analysis</option>
                </select>
                <div class="chart-container">
                    <canvas id="customChart1"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>Chart 2</h3>
                <select id="chart2Select" onchange="updateChart(2)" style="width: 100%; margin-bottom: 10px;">
                    <option value="bodyPart">Body Parts Affected</option>
                    <option value="severity">Severity Distribution</option>
                    <option value="rootCause">Root Causes</option>
                    <option value="processPath">Process Paths</option>
                    <option value="contributingFactors">Contributing Factors</option>      
                    <option value="otrAnalysis">OTR Analysis</option>
                </select>
                <div class="chart-container">
                    <canvas id="customChart2"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>Chart 3: Site Analysis</h3>
                <select id="chart3Select" onchange="updateChart(3)" style="width: 100%; margin-bottom: 10px;">
                    <option value="site">Site Comparison</option>
                    <option value="recordableRate">Recordable Rate by Site</option>
                    <option value="severityBySite">Severity by Site</option>
                </select>
                <div class="chart-container">
                    <canvas id="customChart3"></canvas>
                </div>
            </div>
            
            <div class="card">
                <h3>Chart 4: Trends</h3>
                <select id="chart4Select" onchange="updateChart(4)" style="width: 100%; margin-bottom: 10px;">
                    <option value="trend">Monthly Trend</option>
                    <option value="recordableTrend">Recordable Trend</option>
                    <option value="dafwTrend">Lost Time Trend</option>
                </select>
                <div class="chart-container">
                    <canvas id="customChart4"></canvas>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('overview')">Overview</div>
            <div class="tab" onclick="switchTab('riskMatrix')">Risk Matrix</div>
            <div class="tab" onclick="switchTab('timeline')">Timeline</div>
            <div class="tab" onclick="switchTab('analytics')">Advanced Analytics</div>
            <div class="tab" onclick="switchTab('actions')">Action Items</div>
        </div>
        
        <div class="tab-content">
            <div id="overview" class="tab-panel">
                <h3>Recent Injury & Illness Cases</h3>
                <div class="data-table">
                    <table id="dataTable">
                        <thead>
                            <tr>
                             <th>Case Number</th>
<th>Date</th>
<th>Site</th>
<th>Body Part</th>
<th>Type</th>
<th>Severity</th>
<th>Recordable</th>
<th>OTR</th>
<th>DAFW Days</th>
<th>Root Cause</th>
<th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr>
                                <td colspan="11" class="loading">
                                    No data loaded. Please import a CSV file.<br>
                                    <small>Expected format: Injury & Illness tracking CSV with severity, body parts, recordability, and cause analysis.</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="riskMatrix" class="tab-panel hidden">
                <h3>Risk Assessment Matrix</h3>
                <p>Click on any cell to view incidents in that risk category</p>
                <div class="risk-matrix" id="riskMatrixGrid">
                    <!-- Matrix will be generated dynamically -->
                </div>
            </div>
            
            <div id="timeline" class="tab-panel hidden">
                <h3>Injury & Illness Timeline</h3>
                <div id="timelineContent">
                    <p class="loading">Timeline will be displayed after data is loaded.</p>
                </div>
            </div>
            
            <div id="analytics" class="tab-panel hidden">
                <h3>Advanced Analytics</h3>
                <div class="dashboard">
                    <div class="card">
                        <h3>Recordable Rate Trend</h3>
                        <p>OSHA recordable rate over time</p>
                        <div class="chart-container">
                            <canvas id="recordableRateTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Body Part Heat Map</h3>
                        <div class="chart-container">
                            <canvas id="bodyPartHeatMapChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="actions" class="tab-panel hidden">
                <h3>Action Items & Recommendations</h3>
                <div id="actionItems">
                    <p class="loading">Action items will be generated based on the data analysis.</p>
                </div>
            </div>
        </div>
        
        <div class="export-options">
            <h3>Export Options</h3>
            <button onclick="exportDashboard()">📸 Export Dashboard as Image</button>
            <button onclick="generatePDFReport()">📑 Export PDF Report</button>
            <button onclick="exportRawData()">💾 Export Raw Data</button>
        </div>
    </div>
    
    <div class="overlay" id="overlay" onclick="closePDFPreview()"></div>
    <div id="pdfPreview">
        <h3>PDF Report Preview</h3>
        <div id="pdfContent"></div>
        <button onclick="closePDFPreview()">Close</button>
    </div>
    
    <script>
        // Global variables
        let rawData = [];
        let filteredData = [];
        let charts = {};
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Injury & Illness Analysis Tool loaded');
            setupEventListeners();
            initializeCharts();
            createRiskMatrix();
            console.log('Initialization complete. Ready to import data.');
        });
        
        // Setup event listeners
        function setupEventListeners() {
            const csvInput = document.getElementById('csvInput');
            if (csvInput) {
                csvInput.removeEventListener('change', handleFileUpload);
                csvInput.addEventListener('change', handleFileUpload);
            }
            
            // Filter listeners
            const filters = ['severityFilter', 'otrFilter', 'recordableFilter', 'siteFilter', 'dateFrom', 'dateTo'];
            filters.forEach(filterId => {
                const element = document.getElementById(filterId);
                if (element) {
                    element.addEventListener('change', applyFilters);
                }
            });
        }
        
        // Handle CSV file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (file) {
                console.log('File selected:', file.name);
                
                const tableBody = document.getElementById('tableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="11" class="loading">Processing CSV file...</td></tr>';
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    parseCSV(e.target.result);
                };
                reader.readAsText(file);
            }
        }
        
        // Parse CSV data
        function parseCSV(csvText) {
            try {
                showStatus('Parsing CSV data...', 'info');
                
                Papa.parse(csvText, {
                    header: true,
                    dynamicTyping: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        rawData = results.data;
                        console.log(`Loaded ${rawData.length} rows of data`);
                        
                        processData();
                        populateFilters();
                        applyFilters();
                        
                        showStatus(`Successfully loaded ${rawData.length} injury & illness records!`, 'success');
                    },
                    error: function(error) {
                        console.error('CSV parsing failed:', error);
                        showStatus('Failed to parse CSV file.', 'error');
                    }
                });
            } catch (error) {
                console.error('Error in parseCSV:', error);
                showStatus('Error processing CSV file: ' + error.message, 'error');
            }
        }
        
        // Show status messages
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('statusMessage');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.style.display = 'block';
                
                switch(type) {
                    case 'success':
                        statusDiv.style.background = '#d4edda';
                        statusDiv.style.color = '#155724';
                        break;
                    case 'error':
                        statusDiv.style.background = '#f8d7da';
                        statusDiv.style.color = '#721c24';
                        break;
                    case 'warning':
                        statusDiv.style.background = '#fff3cd';
                        statusDiv.style.color = '#856404';
                        break;
                    default:
                        statusDiv.style.background = '#d1ecf1';
                        statusDiv.style.color = '#0c5460';
                }
                
                if (type !== 'error') {
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
            }
        }
        
        // Process and enhance data

function processData() {
    rawData.forEach((row, index) => {
        try {
            // Parse dates
            if (row.incident_date) {
                row.parsedDate = new Date(row.incident_date);
            }
            
            // Standardize severity
            row.standardSeverity = standardizeSeverity(row.severity || row.potential_severity);
            
            // Ensure recordable is numeric
            row.recordable = parseInt(row.recordable) || 0;
            
            // Ensure DAFW days is numeric
            row.total_dafw_days = parseInt(row.total_dafw_days) || 0;
            
            // Generate case ID if not present
            if (!row.case_number) {
                row.case_number = `CASE-${index + 1}`;
            }
            
            // Extract body part
            row.bodyPart = row.initial_info_principal_body_part || row.initial_info_detailed_body_part || 'Unknown';

            // Extract OTR status from initial_info_incident_on_the_road column
            // Handle boolean values first (from Papa Parse with dynamicTyping)
            if (row.initial_info_incident_on_the_road === true) {
                row.otr = 'yes';
            } else if (row.initial_info_incident_on_the_road === false) {
                row.otr = 'no';
            } else {
                // Handle string values and other cases
                row.otr = row.initial_info_incident_on_the_road || 'no';
                if (typeof row.otr === 'string') {
                    row.otr = row.otr.toLowerCase();
                }
                // Normalize various string OTR values to yes/no
                if (row.otr === '1' || row.otr === 'true' || row.otr === 'yes' || row.otr === 'y') {
                    row.otr = 'yes';
                } else {
                    row.otr = 'no';
                }
            }

            // Extract root cause
            row.rootCause = row.rca_primary_cause || 'Under Investigation';
            
        } catch (error) {
            console.error(`Error processing row ${index}:`, error);
        }
    });
}

// Standardize severity levels - This should be OUTSIDE processData function
function standardizeSeverity(severity) {
    if (!severity) return 'Unknown';
    const severityStr = String(severity).toUpperCase().trim();
    
    // Handle A-D severity scale
    if (severityStr === 'A') return 'A';
    if (severityStr === 'B') return 'B';
    if (severityStr === 'C') return 'C';
    if (severityStr === 'D') return 'D';
    
    // Fallback for other formats
    const lower = severityStr.toLowerCase();
    if (lower.includes('critical') || lower.includes('severe')) return 'A';
    if (lower.includes('high') || lower.includes('major')) return 'B';
    if (lower.includes('medium') || lower.includes('moderate')) return 'C';
    if (lower.includes('low') || lower.includes('minor')) return 'D';
    
    return 'Unknown';
}
        
        // Populate filter dropdowns
        function populateFilters() {
    
            
            // Site
            const sites = [...new Set(rawData.map(row => row.site).filter(Boolean))];
            const siteFilter = document.getElementById('siteFilter');
            siteFilter.innerHTML = '<option value="">All Sites</option>';
            sites.forEach(site => {
                siteFilter.innerHTML += `<option value="${site}">${site}</option>`;
            });
        }
        
        // Apply filters
        function applyFilters() {
            if (rawData.length === 0) return;
            
            const siteFilter = document.getElementById('siteFilter').value;
            const severityFilter = document.getElementById('severityFilter').value;
            const recordableFilter = document.getElementById('recordableFilter').value;

            const otrFilter = document.getElementById('otrFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            
            filteredData = rawData.filter(row => {
                if (severityFilter && row.standardSeverity !== severityFilter) return false;
                if (otrFilter && row.otr !== otrFilter) return false;
                if (recordableFilter !== '' && row.recordable != recordableFilter) return false;
                if (siteFilter && row.site !== siteFilter) return false;
                
                if (dateFrom || dateTo) {
                    const rowDate = row.parsedDate;
                    if (!rowDate || isNaN(rowDate)) return false;
                    
                    if (dateFrom && rowDate < new Date(dateFrom)) return false;
                    if (dateTo && rowDate > new Date(dateTo)) return false;
                }
                
                return true;
            });
            
            console.log(`Filtered data: ${filteredData.length} of ${rawData.length} records`);
            
            updateDashboard();
            updateTable();
            updateCharts();
        }
        
        // Update dashboard metrics
        function updateDashboard() {
            document.getElementById('totalCount').textContent = filteredData.length;
            
            const recordableCount = filteredData.filter(row => row.recordable === 1).length;
            document.getElementById('recordableCount').textContent = recordableCount;
            
            const lostTimeCount = filteredData.filter(row => row.total_dafw_days > 0).length;
            document.getElementById('lostTimeCount').textContent = lostTimeCount;
        }
        
        // Update data table
        function updateTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="loading">No data matches the current filters.</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.slice(0, 10).map(row => {
                const caseNumber = row.case_number || 'N/A';
                const date = row.incident_date || 'N/A';
                const site = row.site || 'N/A';
                const bodyPart = (row.bodyPart || 'N/A').substring(0, 20);
                const type = (row.type || 'N/A').substring(0, 15);
                const severity = row.standardSeverity || 'Unknown';
                const recordable = row.recordable === 1 ? 'Yes' : 'No';
                const dafwDays = row.total_dafw_days || 0;
                const otr = row.otr === 'yes' ? 'Yes' : 'No';
                const rootCause = (row.rootCause || 'N/A').substring(0, 20);
                
                return `
                    <tr>
                        <td>${caseNumber}</td>
                        <td>${date}</td>
                        <td>${site}</td>
                        <td title="${row.bodyPart || ''}">${bodyPart}${bodyPart.length >= 20 ? '...' : ''}</td>
                        <td title="${row.type || ''}">${type}${type.length >= 15 ? '...' : ''}</td>
                        <td><span class="severity-badge severity-${severity.toLowerCase()}">${severity}</span></td>
                        <td><span class="severity-badge recordable-${recordable.toLowerCase()}">${recordable}</span></td>
                        <td><span class="severity-badge ${otr === 'Yes' ? 'recordable-yes' : 'recordable-no'}">${otr}</span></td>
                        <td>${dafwDays}</td>
                        <td title="${row.rootCause || ''}">${rootCause}${rootCause.length >= 20 ? '...' : ''}</td>
                        <td>
                            <button onclick="viewDetails('${caseNumber.replace(/'/g, "\\'")}')">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        // Initialize charts
// Initialize charts
function initializeCharts() {
    // Initialize DAFW chart
    const dafwCtx = document.getElementById('dafwChart');
    if (dafwCtx) {
        charts.dafw = new Chart(dafwCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: ['#4CAF50', '#FFC107', '#FF9900', '#FF5722', '#B71C1C', '#37475A']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((value / total) * 100).toFixed(1);
                                return `${label}: ${value} cases (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
            
            // Initialize customizable charts
            for (let i = 1; i <= 4; i++) {
                const ctx = document.getElementById(`customChart${i}`).getContext('2d');
                charts[`custom${i}`] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            console.log('Charts initialized');
        }
        // Update OTR analysis chart
function updateOTRAnalysisChart(chart) {
    const otrCounts = {
        'Yes': filteredData.filter(r => r.otr === 'yes').length,
        'No': filteredData.filter(r => r.otr === 'no').length
    };
    
    // Set chart type and options
    chart.config.type = 'doughnut';
    
    chart.options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: true,
                position: 'bottom'
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const label = context.label || '';
                        const value = context.parsed || 0;
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${label}: ${value} (${percentage}%)`;
                    }
                }
            }
        }
    };
    
    // Set data
    chart.data = {
        labels: ['On The Road', 'Not On The Road'],
        datasets: [{
            data: [otrCounts.Yes, otrCounts.No],
            backgroundColor: ['#FF5722', '#4CAF50'],
            label: 'Cases'
        }]
    };
    
    chart.update();
}
        // Update specific chart based on selection
        function updateChart(chartNumber) {
            const selectElement = document.getElementById(`chart${chartNumber}Select`);
            const chartType = selectElement.value;
            const chartKey = `custom${chartNumber}`;
            let chart = charts[chartKey];
            
            if (!chart || filteredData.length === 0) {
                console.log(`Cannot update chart ${chartNumber}: chart exists=${!!chart}, data count=${filteredData.length}`);
                return;
            }
            
            console.log(`Updating chart ${chartNumber} to type: ${chartType}`);
            
            // Store the canvas reference
            const canvas = chart.canvas;
            
            // Destroy the old chart
            chart.destroy();
            
            // Create new chart with minimal configuration
            charts[chartKey] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Get the new chart reference
            chart = charts[chartKey];
            
            // Update with the selected chart type
            switch(chartType) {
                case 'severity':
                    updateSeverityChart(chart);
                    break;
                case 'bodyPart':
                    updateBodyPartAnalysisChart(chart);
                    break;
                case 'rootCause':
                    updateRootCauseChart(chart);
                    break;
                case 'site':
                    updateSiteChart(chart);
                    break;
                case 'trend':
                    updateTrendChart(chart);
                    break;
                case 'processPath':
                    updateProcessPathChart(chart);
                    break;
                case 'contributingFactors':
                    updateContributingFactorsChart(chart);
                    break;
                case 'recordableRate':
                    updateRecordableRateChart(chart);
                    break;
                case 'severityBySite':
                    updateSeverityBySiteChart(chart);
                    break;
                case 'recordableTrend':
                    updateRecordableTrendChart(chart);
                    break;
                case 'dafwTrend':
                    updateDAFWTrendChart(chart);
                    break;
                case 'impactType':
                    updateImpactTypeChart(chart);
                    break;
                    case 'otrAnalysis':
    updateOTRAnalysisChart(chart);
    break;
            }
        }
        
        // Update severity distribution chart
        function updateSeverityChart(chart) {
            const severityCounts = {
                'A': filteredData.filter(r => r.standardSeverity === 'A').length,
                'B': filteredData.filter(r => r.standardSeverity === 'B').length,
                'C': filteredData.filter(r => r.standardSeverity === 'C').length,
                'D': filteredData.filter(r => r.standardSeverity === 'D').length
            };
            
            const nonZero = Object.entries(severityCounts).filter(([_, count]) => count > 0);
            
            // Set chart type and options
            chart.config.type = 'doughnut';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: nonZero.map(([severity]) => `Severity ${severity}`),
                datasets: [{
                    data: nonZero.map(([, count]) => count),
                    backgroundColor: nonZero.map(([severity]) => {
                        const colorMap = {
                            'A': '#B71C1C',
                            'B': '#FF5722',
                            'C': '#FFC107',
                            'D': '#4CAF50'
                        };
                        return colorMap[severity];
                    }),
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update body part analysis chart
        function updateBodyPartAnalysisChart(chart) {
            const bodyPartCounts = {};
            filteredData.forEach(row => {
                const part = row.bodyPart || 'Unknown';
                bodyPartCounts[part] = (bodyPartCounts[part] || 0) + 1;
            });
            
            const topBodyParts = Object.entries(bodyPartCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Set to horizontal bar chart
            chart.config.type = 'bar';
            
            // Configure options
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            };
            
            // Clear and set data
            chart.data = {
                labels: topBodyParts.map(([part]) => 
                    part.length > 30 ? part.substring(0, 30) + '...' : part
                ),
                datasets: [{
                    data: topBodyParts.map(([, count]) => count),
                    backgroundColor: '#232F3E',
                    borderColor: '#232F3E',
                    borderWidth: 1,
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update root cause chart
        function updateRootCauseChart(chart) {
            const rootCauseCounts = {};
            filteredData.forEach(row => {
                const cause = row.rootCause || 'Under Investigation';
                rootCauseCounts[cause] = (rootCauseCounts[cause] || 0) + 1;
            });
            
            const topCauses = Object.entries(rootCauseCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            // Set chart type and options
            chart.config.type = 'bar';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: topCauses.map(([cause]) => cause),
                datasets: [{
                    data: topCauses.map(([, count]) => count),
                    backgroundColor: '#37475A',
                    borderColor: '#37475A',
                    borderWidth: 1,
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update impact type chart
        function updateImpactTypeChart(chart) {
            const impactCounts = {};
            filteredData.forEach(row => {
                const impact = row.initial_info_impact_type_primary || 'Unknown';
                impactCounts[impact] = (impactCounts[impact] || 0) + 1;
            });
            
            const topImpacts = Object.entries(impactCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            // Set chart type and options
            chart.config.type = 'pie';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right'
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: topImpacts.map(([impact]) => impact),
                datasets: [{
                    data: topImpacts.map(([, count]) => count),
                    backgroundColor: [
                        '#FF9900', '#232F3E', '#37475A', '#FF5722', '#4CAF50', '#2196F3'
                    ],
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update trend chart
        function updateTrendChart(chart) {
            const monthlyData = {};
            filteredData.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate)) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            // Set chart type and options
            chart.config.type = 'line';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    data: sortedMonths.map(m => monthlyData[m]),
                    borderColor: '#FF9900',
                    backgroundColor: 'rgba(255, 153, 0, 0.1)',
                    tension: 0.3,
                    label: 'Total Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update recordable trend chart
        function updateRecordableTrendChart(chart) {
            const monthlyRecordable = {};
            filteredData.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate) && row.recordable === 1) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyRecordable[monthKey] = (monthlyRecordable[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyRecordable).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            // Set chart type and options
            chart.config.type = 'line';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    data: sortedMonths.map(m => monthlyRecordable[m] || 0),
                    borderColor: '#FF5722',
                    backgroundColor: 'rgba(255, 87, 34, 0.1)',
                    tension: 0.3,
                    label: 'Recordable Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update DAFW trend chart
        function updateDAFWTrendChart(chart) {
            const monthlyDAFW = {};
            filteredData.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate) && row.total_dafw_days > 0) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyDAFW[monthKey] = (monthlyDAFW[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyDAFW).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            // Set chart type and options
            chart.config.type = 'line';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    data: sortedMonths.map(m => monthlyDAFW[m] || 0),
                    borderColor: '#B71C1C',
                    backgroundColor: 'rgba(183, 28, 28, 0.1)',
                    tension: 0.3,
                    label: 'Lost Time Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update site comparison chart
        function updateSiteChart(chart) {
            const siteCounts = {};
            filteredData.forEach(row => {
                const site = row.site || 'Unknown';
                siteCounts[site] = (siteCounts[site] || 0) + 1;
            });
            
            const sites = Object.entries(siteCounts)
                .sort((a, b) => b[1] - a[1]);
            
            // Set chart type and options
            chart.config.type = 'bar';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: sites.map(([site]) => site),
                datasets: [{
                    data: sites.map(([, count]) => count),
                    backgroundColor: sites.map((_, i) => 
                        i % 2 === 0 ? '#FF9900' : '#232F3E'
                    ),
                    borderWidth: 1,
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update recordable rate by site chart
        function updateRecordableRateChart(chart) {
            const siteData = {};
            filteredData.forEach(row => {
                const site = row.site || 'Unknown';
                if (!siteData[site]) {
                    siteData[site] = { total: 0, recordable: 0 };
                }
                siteData[site].total++;
                if (row.recordable === 1) {
                    siteData[site].recordable++;
                }
            });
            
            const siteRates = Object.entries(siteData)
                .map(([site, data]) => ({
                    site,
                    rate: ((data.recordable / data.total) * 100).toFixed(1)
                }))
                .sort((a, b) => b.rate - a.rate);
            
            // Set chart type and options
            chart.config.type = 'bar';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: siteRates.map(s => s.site),
                datasets: [{
                    data: siteRates.map(s => parseFloat(s.rate)),
                    backgroundColor: '#FF5722',
                    borderWidth: 1,
                    label: 'Recordable Rate %'
                }]
            };
            
            chart.update();
        }
        
        // Update process path chart
        function updateProcessPathChart(chart) {
            const pathCounts = {};
            filteredData.forEach(row => {
                const path = row.initial_info_process_path || 'Unknown';
                pathCounts[path] = (pathCounts[path] || 0) + 1;
            });
            
            const topPaths = Object.entries(pathCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            // Set chart type and options
            chart.config.type = 'bar';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true
                    },
                    y: {
                        beginAtZero: true
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: topPaths.map(([path]) => path),
                datasets: [{
                    data: topPaths.map(([, count]) => count),
                    backgroundColor: '#37475A',
                    borderColor: '#37475A',
                    borderWidth: 1,
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update contributing factors chart
        function updateContributingFactorsChart(chart) {
            const factorCounts = {};
            filteredData.forEach(row => {
                const factor = row.rca_contributing_factor_category || 'Unknown';
                factorCounts[factor] = (factorCounts[factor] || 0) + 1;
            });
            
            const topFactors = Object.entries(factorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            // Set chart type and options
            chart.config.type = 'doughnut';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'right'
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: topFactors.map(([factor]) => factor),
                datasets: [{
                    data: topFactors.map(([, count]) => count),
                    backgroundColor: [
                        '#FF9900', '#232F3E', '#37475A', '#FF5722', '#4CAF50', '#2196F3'
                    ],
                    label: 'Cases'
                }]
            };
            
            chart.update();
        }
        
        // Update severity by site chart
        function updateSeverityBySiteChart(chart) {
            const siteData = {};
            filteredData.forEach(row => {
                const site = row.site || 'Unknown';
                if (!siteData[site]) {
                    siteData[site] = { A: 0, B: 0, C: 0, D: 0 };
                }
                if (row.standardSeverity && siteData[site][row.standardSeverity] !== undefined) {
                    siteData[site][row.standardSeverity]++;
                }
            });
            
            const sites = Object.keys(siteData).sort();
            
            // Set chart type and options
            chart.config.type = 'bar';
            
            chart.options = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true
                    }
                },
                scales: {
                    x: {
                        stacked: true
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true
                    }
                }
            };
            
            // Set data
            chart.data = {
                labels: sites,
                datasets: [
                    {
                        label: 'Severity A',
                        data: sites.map(site => siteData[site].A),
                        backgroundColor: '#B71C1C'
                    },
                    {
                        label: 'Severity B',
                        data: sites.map(site => siteData[site].B),
                        backgroundColor: '#FF5722'
                    },
                    {
                        label: 'Severity C',
                        data: sites.map(site => siteData[site].C),
                        backgroundColor: '#FFC107'
                    },
                    {
                        label: 'Severity D',
                        data: sites.map(site => siteData[site].D),
                        backgroundColor: '#4CAF50'
                    }
                ]
            };
            
            chart.update();
        }
        
     // Update charts with data
function updateCharts() {
    if (filteredData.length === 0) return;
    
    // Update DAFW chart
    if (charts.dafw) {
        const dafwRanges = {
            '0 Days (No Lost Time)': 0,
            '1-3 Days': 0,
            '4-7 Days': 0,
            '8-14 Days': 0,
            '15-30 Days': 0,
            '30+ Days': 0
        };
        
        let totalDafwDays = 0;
        
        filteredData.forEach(row => {
            const days = row.total_dafw_days || 0;
            totalDafwDays += days;
            
            if (days === 0) {
                dafwRanges['0 Days (No Lost Time)']++;
            } else if (days <= 3) {
                dafwRanges['1-3 Days']++;
            } else if (days <= 7) {
                dafwRanges['4-7 Days']++;
            } else if (days <= 14) {
                dafwRanges['8-14 Days']++;
            } else if (days <= 30) {
                dafwRanges['15-30 Days']++;
            } else {
                dafwRanges['30+ Days']++;
            }
        });
        
        // Update total DAFW days display
        const totalDafwElement = document.getElementById('totalDafwDays');
        if (totalDafwElement) {
            totalDafwElement.textContent = `Total: ${totalDafwDays} days lost`;
        }
        
        // Clear and set new data
        charts.dafw.data.labels = [];
        charts.dafw.data.datasets = [];
        
        // Filter out ranges with zero cases for cleaner visualization
        const nonZeroRanges = Object.entries(dafwRanges).filter(([_, count]) => count > 0);
        
        charts.dafw.data.labels = nonZeroRanges.map(([range]) => range);
        charts.dafw.data.datasets.push({
            data: nonZeroRanges.map(([, count]) => count),
            backgroundColor: ['#4CAF50', '#FFC107', '#FF9900', '#FF5722', '#B71C1C', '#37475A'],
            label: 'Cases'
        });
        charts.dafw.update();
    }
    
    // Update customizable charts
    for (let i = 1; i <= 4; i++) {
        updateChart(i);
    }
}

// Create risk matrix
function createRiskMatrix() {
            const matrix = document.getElementById('riskMatrixGrid');
            const severityLabels = ['', 'A', 'B', 'C', 'D', 'Negligible'];
            const likelihoodLabels = ['', 'Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];
            
            for (let s = 0; s < 6; s++) {
                for (let l = 0; l < 6; l++) {
                    const cell = document.createElement('div');
                    
                    if (s === 0 && l === 0) {
                        cell.className = 'matrix-label';
                        cell.textContent = 'S/L';
                    } else if (s === 0) {
                        cell.className = 'matrix-label';
                        cell.textContent = likelihoodLabels[l];
                    } else if (l === 0) {
                        cell.className = 'matrix-label';
                        cell.textContent = severityLabels[s];
                    } else {
                        const risk = calculateMatrixRisk(6-s, l);
                        cell.className = `matrix-cell risk-${getRiskLevel(risk)}`;
                        cell.textContent = '0';
                        cell.dataset.severity = severityLabels[s];
                        cell.dataset.likelihood = likelihoodLabels[l];
                        cell.onclick = () => showMatrixIncidents(severityLabels[s], likelihoodLabels[l]);
                    }
                    
                    matrix.appendChild(cell);
                }
            }
        }
        
        // Calculate risk for matrix cell
        function calculateMatrixRisk(severity, likelihood) {
            return severity * likelihood;
        }
        
        // Get risk level from score
        function getRiskLevel(score) {
            if (score <= 5) return 'low';
            if (score <= 10) return 'medium';
            if (score <= 15) return 'high';
            return 'critical';
        }
        
        // Show incidents for matrix cell
        function showMatrixIncidents(severity, likelihood) {
            const incidents = filteredData.filter(row => 
                row.standardSeverity === severity && 
                row.initial_risk_assessment_likeliness === likelihood
            );
            
            alert(`Found ${incidents.length} cases with ${severity} severity and ${likelihood} likelihood`);
        }
        
        // Switch tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            document.getElementById(tabName).classList.remove('hidden');
            
            if (tabName === 'timeline') {
                loadTimeline();
            } else if (tabName === 'analytics') {
                loadAdvancedAnalytics();
            } else if (tabName === 'actions') {
                loadActionItems();
            }
        }
        
        // Load timeline view
        function loadTimeline() {
            const timelineContent = document.getElementById('timelineContent');
            const recentIncidents = filteredData
                .sort((a, b) => {
                    const dateA = new Date(a.incident_date || a.created_at);
                    const dateB = new Date(b.incident_date || b.created_at);
                    return dateB - dateA;
                })
                .slice(0, 10);
            
            timelineContent.innerHTML = recentIncidents.map(incident => `
                <div class="timeline-item">
                    <h4>${incident.case_number}</h4>
                    <p><strong>Date:</strong> ${incident.incident_date || 'N/A'}</p>
                    <p><strong>Site:</strong> ${incident.site || 'N/A'}</p>
                    <p><strong>Body Part:</strong> ${incident.bodyPart || 'N/A'}</p>
                    <p><strong>Type:</strong> ${incident.type || 'N/A'}</p>
                    <p><strong>Severity:</strong> ${incident.standardSeverity || 'N/A'}</p>
                    <p><strong>Recordable:</strong> ${incident.recordable === 1 ? 'Yes' : 'No'}</p>
                    <p><strong>DAFW Days:</strong> ${incident.total_dafw_days || 0}</p>
                    <p><strong>Description:</strong> ${incident.initial_info_incident_description || 'No description'}</p>
                    <p><strong>Root Cause:</strong> ${incident.rootCause || 'Under investigation'}</p>
                </div>
            `).join('');
        }
        
        // Load advanced analytics
        function loadAdvancedAnalytics() {
            if (!charts.recordableRateTrend) {
                const recordableRateTrendCtx = document.getElementById('recordableRateTrendChart').getContext('2d');
                charts.recordableRateTrend = new Chart(recordableRateTrendCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Recordable Rate',
                            data: [],
                            borderColor: '#FF5722',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            if (!charts.bodyPartHeatMap) {
                const bodyPartHeatMapCtx = document.getElementById('bodyPartHeatMapChart').getContext('2d');
                charts.bodyPartHeatMap = new Chart(bodyPartHeatMapCtx, {
                    type: 'bar',
                    data: {
                        labels: [],
                        datasets: []
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            x: {
                                stacked: true,
                                beginAtZero: true
                            },
                            y: {
                                stacked: true
                            }
                        }
                    }
                });
            }
            
            updateAdvancedAnalytics();
        }
        
        // Update advanced analytics
        function updateAdvancedAnalytics() {
            // Recordable rate trend
            const monthlyRates = {};
            const monthlyTotals = {};
            
            filteredData.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate)) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyTotals[monthKey]) {
                        monthlyTotals[monthKey] = 0;
                        monthlyRates[monthKey] = 0;
                    }
                    monthlyTotals[monthKey]++;
                    if (row.recordable === 1) {
                        monthlyRates[monthKey]++;
                    }
                }
            });
            
            const sortedMonths = Object.keys(monthlyTotals).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            charts.recordableRateTrend.data.labels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                return `${monthNames[parseInt(month)-1]} ${year}`;
            });
            charts.recordableRateTrend.data.datasets[0].data = sortedMonths.map(m => 
                ((monthlyRates[m] / monthlyTotals[m]) * 100).toFixed(1)
            );
            charts.recordableRateTrend.update();
            
            // Body part heat map by severity
            const bodyPartSeverity = {};
            filteredData.forEach(row => {
                const part = row.bodyPart || 'Unknown';
                if (!bodyPartSeverity[part]) {
                    bodyPartSeverity[part] = { A: 0, B: 0, C: 0, D: 0 };
                }
                if (row.standardSeverity && bodyPartSeverity[part][row.standardSeverity] !== undefined) {
                    bodyPartSeverity[part][row.standardSeverity]++;
                }
            });
            
            const topBodyParts = Object.entries(bodyPartSeverity)
                .map(([part, severities]) => ({
                    part,
                    total: Object.values(severities).reduce((a, b) => a + b, 0),
                    severities
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 8);
            
            charts.bodyPartHeatMap.data.labels = topBodyParts.map(bp => bp.part);
            charts.bodyPartHeatMap.data.datasets = [
                {
                    label: 'Severity A',
                    data: topBodyParts.map(bp => bp.severities.A),
                    backgroundColor: '#B71C1C'
                },
                {
                    label: 'Severity B',
                    data: topBodyParts.map(bp => bp.severities.B),
                    backgroundColor: '#FF5722'
                },
                {
                    label: 'Severity C',
                    data: topBodyParts.map(bp => bp.severities.C),
                    backgroundColor: '#FFC107'
                },
                {
                    label: 'Severity D',
                    data: topBodyParts.map(bp => bp.severities.D),
                    backgroundColor: '#4CAF50'
                }
            ];
            charts.bodyPartHeatMap.update();
        }
        
        // Load action items
        function loadActionItems() {
            const actionContent = document.getElementById('actionItems');
            const criticalIncidents = filteredData.filter(r => 
                r.standardSeverity === 'A' || r.standardSeverity === 'B' || r.recordable === 1
            );
            
            const actions = generateActionItems(criticalIncidents);
            
            actionContent.innerHTML = `
                <h4>Immediate Actions Required (${actions.immediate.length})</h4>
                <ul>
                    ${actions.immediate.map(action => `<li>${action}</li>`).join('')}
                </ul>
                
                <h4>Short-term Actions (${actions.shortTerm.length})</h4>
                <ul>
                    ${actions.shortTerm.map(action => `<li>${action}</li>`).join('')}
                </ul>
                
                <h4>Long-term Improvements (${actions.longTerm.length})</h4>
                <ul>
                    ${actions.longTerm.map(action => `<li>${action}</li>`).join('')}
                </ul>
            `;
        }
        
        // Generate action items
        function generateActionItems(criticalIncidents) {
            const actions = {
                immediate: [],
                shortTerm: [],
                longTerm: []
            };
            
            // Analyze recordable cases
            const recordableCount = filteredData.filter(r => r.recordable === 1).length;
            if (recordableCount > 5) {
                actions.immediate.push(`Review and address ${recordableCount} recordable cases immediately`);
            }
            
            // Analyze DAFW cases
            const dafwCases = filteredData.filter(r => r.total_dafw_days > 0);
            if (dafwCases.length > 0) {
                const totalDaysLost = dafwCases.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
                actions.immediate.push(`Address ${dafwCases.length} lost time cases (${totalDaysLost} total days lost)`);
            }
            
            // Body part analysis
            const bodyPartCounts = {};
            filteredData.forEach(r => {
                if (r.bodyPart && r.standardSeverity !== 'D') {
                    bodyPartCounts[r.bodyPart] = (bodyPartCounts[r.bodyPart] || 0) + 1;
                }
            });
            
            Object.entries(bodyPartCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .forEach(([part, count]) => {
                    if (count > 3) {
                        actions.shortTerm.push(`Implement ergonomic improvements for "${part}" injuries (${count} cases)`);
                    }
                });
            
            // Site-specific actions
            const siteCounts = {};
            criticalIncidents.forEach(r => {
                if (r.site) {
                    siteCounts[r.site] = (siteCounts[r.site] || 0) + 1;
                }
            });
            
            Object.entries(siteCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .forEach(([site, count]) => {
                    if (count > 3) {
                        actions.immediate.push(`Conduct safety audit at "${site}" (${count} critical cases)`);
                    }
                });
            
            // Root cause actions
            const rootCauseCounts = {};
            criticalIncidents.forEach(r => {
                if (r.rootCause) {
                    rootCauseCounts[r.rootCause] = (rootCauseCounts[r.rootCause] || 0) + 1;
                }
            });
            
            Object.entries(rootCauseCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .forEach(([cause, count]) => {
                    actions.longTerm.push(`Develop prevention program for "${cause}" root cause (${count} cases)`);
                });
            
            return actions;
        }
        
        // Export to Excel
        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('No data to export. Please load data first.');
                return;
            }
            
            const wb = XLSX.utils.book_new();
            
            // Main data sheet
            const ws = XLSX.utils.json_to_sheet(filteredData);
            XLSX.utils.book_append_sheet(wb, ws, "Injury Illness Data");
            
            // Summary sheet
            const recordableCount = filteredData.filter(r => r.recordable === 1).length;
            const lostTimeCount = filteredData.filter(r => r.total_dafw_days > 0).length;
            const totalDaysLost = filteredData.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
            
            const summary = [
                ['Injury & Illness Analysis Summary'],
                ['Generated on:', new Date().toLocaleString()],
                [''],
                ['Total Incidents:', filteredData.length],
                ['Recordable Cases:', recordableCount],
                ['Lost Time Cases:', lostTimeCount],
                ['Total Days Lost:', totalDaysLost],
                [''],
                ['Severity Distribution:'],
                ['A - Critical:', filteredData.filter(r => r.standardSeverity === 'A').length],
                ['B - High:', filteredData.filter(r => r.standardSeverity === 'B').length],
                ['C - Medium:', filteredData.filter(r => r.standardSeverity === 'C').length],
                ['D - Low:', filteredData.filter(r => r.standardSeverity === 'D').length]
            ];
            const ws2 = XLSX.utils.aoa_to_sheet(summary);
            XLSX.utils.book_append_sheet(wb, ws2, "Summary");
            
            XLSX.writeFile(wb, `InjuryIllnessAnalysis_${new Date().toISOString().split('T')[0]}.xlsx`);
        }
        
        // Generate PDF Report
function generatePDFReport() {
    if (filteredData.length === 0) {
        alert('No data to generate report. Please load data first.');
        return;
    }
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Helper functions for Amazon orange color
    const setOrangeColor = () => doc.setTextColor(255, 153, 0);
    const setDarkColor = () => doc.setTextColor(35, 47, 62);
    const setGrayColor = () => doc.setTextColor(100, 100, 100);
    
    // Add Amazon logo area (orange bar at top)
    doc.setFillColor(255, 153, 0);
    doc.rect(0, 0, 210, 25, 'F');
    
    // Title on orange background
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text('Injury & Illness Analysis Report', 105, 15, { align: 'center' });
    
    // Subtitle
    doc.setFontSize(14);
    doc.setFont(undefined, 'normal');
    const selectedSite = document.getElementById('siteFilter').value;
    const siteName = selectedSite || 'All Sites - Austria Region';
    doc.text(siteName, 105, 22, { align: 'center' });
    
    // Report info section
    doc.setFillColor(245, 245, 245);
    doc.rect(0, 25, 210, 20, 'F');
    
    setDarkColor();
    doc.setFontSize(10);
    doc.text(`Report Generated: ${new Date().toLocaleString('en-GB')}`, 15, 35);
    doc.text(`Period: ${getReportPeriod()}`, 15, 40);
    doc.text(`Total Incidents: ${filteredData.length}`, 120, 35);
    doc.text(`Generated for: EHS Manager`, 120, 40);
    
    // Executive Summary Box
    let yPos = 55;
    doc.setFillColor(255, 249, 240);
    doc.rect(10, yPos, 190, 55, 'F');
    doc.setDrawColor(255, 153, 0);
    doc.setLineWidth(0.5);
    doc.rect(10, yPos, 190, 55);
    
    setDarkColor();
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('Executive Summary', 15, yPos + 8);
    
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    const recordableCount = filteredData.filter(r => r.recordable === 1).length;
    const lostTimeCount = filteredData.filter(r => r.total_dafw_days > 0).length;
    const totalDaysLost = filteredData.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
    const recordableRate = filteredData.length > 0 ? ((recordableCount / filteredData.length) * 100).toFixed(1) : '0';
    const otrCount = filteredData.filter(r => r.otr === 'yes').length;
    
    doc.text(`• Total Injury & Illness Cases: ${filteredData.length}`, 15, yPos + 18);
    doc.text(`• OSHA Recordable Cases: ${recordableCount} (${recordableRate}% of total)`, 15, yPos + 25);
    doc.text(`• Lost Time Cases (DAFW): ${lostTimeCount} cases, ${totalDaysLost} total days lost`, 15, yPos + 32);
    doc.text(`• On The Road (OTR) Incidents: ${otrCount}`, 15, yPos + 39);
    doc.text(`• Most Affected Body Part: ${getTopBodyPart()}`, 15, yPos + 46);
    
    // Key Metrics Dashboard
    yPos = 120;
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    setDarkColor();
    doc.text('Key Performance Indicators', 15, yPos);
    
    // Create 4 metric boxes
    yPos += 10;
    const boxWidth = 45;
    const boxHeight = 25;
    const metrics = [
        { label: 'Total Cases', value: filteredData.length, color: [35, 47, 62] },
        { label: 'Recordable', value: recordableCount, color: [255, 87, 34] },
        { label: 'Lost Time', value: lostTimeCount, color: [183, 28, 28] },
        { label: 'Days Lost', value: totalDaysLost, color: [255, 153, 0] }
    ];
    
    metrics.forEach((metric, index) => {
        const xPos = 10 + (index * (boxWidth + 2));
        
        // Box background
        doc.setFillColor(250, 250, 250);
        doc.rect(xPos, yPos, boxWidth, boxHeight, 'F');
        
        // Colored top bar
        doc.setFillColor(...metric.color);
        doc.rect(xPos, yPos, boxWidth, 3, 'F');
        
        // Metric value
        doc.setFontSize(20);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(...metric.color);
        doc.text(metric.value.toString(), xPos + boxWidth/2, yPos + 14, { align: 'center' });
        
        // Label
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        setGrayColor();
        doc.text(metric.label, xPos + boxWidth/2, yPos + 20, { align: 'center' });
    });
    
    // Severity Distribution Chart
    yPos = 165;
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    setDarkColor();
    doc.text('Severity Distribution Analysis', 15, yPos);
    
    yPos += 10;
    const severityData = [
        { level: 'A - Critical', count: filteredData.filter(r => r.standardSeverity === 'A').length, color: [183, 28, 28] },
        { level: 'B - High', count: filteredData.filter(r => r.standardSeverity === 'B').length, color: [255, 87, 34] },
        { level: 'C - Medium', count: filteredData.filter(r => r.standardSeverity === 'C').length, color: [255, 193, 7] },
        { level: 'D - Low', count: filteredData.filter(r => r.standardSeverity === 'D').length, color: [76, 175, 80] }
    ];
    
    const maxCount = Math.max(...severityData.map(s => s.count), 1);
    severityData.forEach((sev, index) => {
        const barY = yPos + (index * 12);
        const barWidth = (sev.count / maxCount) * 120;
        const percentage = filteredData.length > 0 ? ((sev.count / filteredData.length) * 100).toFixed(1) : '0';
        
        // Label
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        setDarkColor();
        doc.text(sev.level, 15, barY + 5);
        
        // Bar
        doc.setFillColor(...sev.color);
        doc.rect(55, barY, barWidth || 1, 8, 'F');
        
        // Count and percentage
        doc.setFontSize(9);
        setGrayColor();
        doc.text(`${sev.count} (${percentage}%)`, 180, barY + 5);
    });
    
    // Top Body Parts Table
    yPos = 230;
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    setDarkColor();
    doc.text('Top 5 Affected Body Parts', 15, yPos);
    
    const bodyPartCounts = {};
    filteredData.forEach(row => {
        const part = row.bodyPart || 'Unknown';
        bodyPartCounts[part] = (bodyPartCounts[part] || 0) + 1;
    });
    
    const topBodyParts = Object.entries(bodyPartCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5);
    
    // Table headers
    yPos += 8;
    doc.setFillColor(35, 47, 62);
    doc.rect(15, yPos, 180, 8, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(10);
    doc.setFont(undefined, 'bold');
    doc.text('Body Part', 20, yPos + 5);
    doc.text('Cases', 130, yPos + 5);
    doc.text('Rate', 155, yPos + 5);
    doc.text('Severity', 175, yPos + 5);
    
    // Table rows
    yPos += 8;
    doc.setFont(undefined, 'normal');
    topBodyParts.forEach(([part, count], index) => {
        if (index % 2 === 0) {
            doc.setFillColor(250, 250, 250);
            doc.rect(15, yPos, 180, 7, 'F');
        }
        
        setDarkColor();
        doc.setFontSize(9);
        const shortPart = part.length > 40 ? part.substring(0, 40) + '...' : part;
        doc.text(shortPart, 20, yPos + 5);
        doc.text(count.toString(), 130, yPos + 5);
        
        // Calculate percentage
        const percentage = ((count / filteredData.length) * 100).toFixed(1);
        doc.text(`${percentage}%`, 155, yPos + 5);
        
        // Average severity indicator
        const avgSeverity = getBodyPartAverageSeverity(part);
        const severityColor = getSeverityColor(avgSeverity);
        doc.setFillColor(...severityColor);
        doc.circle(180, yPos + 3.5, 2, 'F');
        
        yPos += 7;
    });
    
    // Footer for page 1
    doc.setFontSize(8);
    setGrayColor();
    doc.text('Amazon WHS - Injury & Illness Analysis Tool', 105, 285, { align: 'center' });
    doc.text('Page 1 of 2', 195, 285);
    
    // Add new page for detailed analysis
    doc.addPage();
    
    // Header for page 2
    doc.setFillColor(255, 153, 0);
    doc.rect(0, 0, 210, 15, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.text('Root Cause Analysis & Action Plan', 105, 10, { align: 'center' });
    
    // Root Cause Analysis
    yPos = 30;
    setDarkColor();
    doc.setFontSize(14);
    doc.text('Primary Root Causes', 15, yPos);
    
    const rootCauseCounts = {};
    filteredData.forEach(row => {
        const cause = row.rootCause || 'Under Investigation';
        rootCauseCounts[cause] = (rootCauseCounts[cause] || 0) + 1;
    });
    
    const topCauses = Object.entries(rootCauseCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 6);
    
    yPos += 10;
    topCauses.forEach(([cause, count], index) => {
        const percentage = ((count / filteredData.length) * 100).toFixed(1);
        
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const shortCause = cause.length > 30 ? cause.substring(0, 30) + '...' : cause;
        doc.text(`${shortCause}:`, 20, yPos);
        
        // Progress bar
        const barWidth = (count / filteredData.length) * 100;
        doc.setFillColor(255, 153, 0);
        doc.rect(80, yPos - 4, barWidth, 4, 'F');
        doc.setDrawColor(200, 200, 200);
        doc.rect(80, yPos - 4, 100, 4);
        
        doc.text(`${count} (${percentage}%)`, 185, yPos);
        
        yPos += 8;
    });
    
    // OTR Analysis Section
    yPos += 10;
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    setDarkColor();
    doc.text('On The Road (OTR) Analysis', 15, yPos);
    
    yPos += 8;
    const otrYes = filteredData.filter(r => r.otr === 'yes').length;
    const otrNo = filteredData.filter(r => r.otr === 'no').length;
    const otrPercentage = filteredData.length > 0 ? ((otrYes / filteredData.length) * 100).toFixed(1) : '0';
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.text(`OTR Incidents: ${otrYes} (${otrPercentage}%)`, 20, yPos);
    doc.text(`Non-OTR Incidents: ${otrNo} (${100 - parseFloat(otrPercentage)}%)`, 110, yPos);
    
    // Action Recommendations
    yPos += 20;
    doc.setFillColor(255, 249, 240);
    doc.rect(10, yPos, 190, 90, 'F');
    doc.setDrawColor(255, 153, 0);
    doc.setLineWidth(0.5);
    doc.rect(10, yPos, 190, 90);
    
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    setOrangeColor();
    doc.text('Recommended Actions', 15, yPos + 8);
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    setDarkColor();
    
    const criticalIncidents = filteredData.filter(r => 
        r.standardSeverity === 'A' || r.standardSeverity === 'B' || r.recordable === 1
    );
    const actions = generateActionItems(criticalIncidents);
    const recommendations = [];
    
    // Generate specific recommendations
    if (recordableCount > 5) {
        recommendations.push(`Immediate safety stand-down required for ${recordableCount} recordable cases`);
    }
    if (lostTimeCount > 0) {
        recommendations.push(`Review return-to-work programs for ${lostTimeCount} DAFW cases`);
    }
    if (otrYes > 2) {
        recommendations.push(`Implement driver safety training to address ${otrYes} OTR incidents`);
    }
    
    // Add top body part recommendation
    const topBodyPart = getTopBodyPart();
    if (topBodyPart !== 'N/A') {
        recommendations.push(`Ergonomic assessment needed for "${topBodyPart}" injuries`);
    }
    
    // Add top root cause recommendation
    if (topCauses.length > 0 && topCauses[0][1] > 2) {
        recommendations.push(`Address "${topCauses[0][0]}" root cause (${topCauses[0][1]} cases)`);
    }
    
    let recY = yPos + 18;
    recommendations.slice(0, 6).forEach((rec, index) => {
        if (recY > yPos + 85) return; // Stay within box
        doc.text(`${index + 1}. ${rec}`, 15, recY, { maxWidth: 180 });
        recY += 12;
    });
    
    // Trend Summary
    yPos = 200;
    doc.setFontSize(14);
    doc.setFont(undefined, 'bold');
    setDarkColor();
    doc.text('Monthly Trend Summary', 15, yPos);
    
    yPos += 8;
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    const trendSummary = getMonthlyTrendSummary();
    doc.text(trendSummary, 15, yPos, { maxWidth: 180 });
    
    // Site-specific metrics if filtered
    if (selectedSite) {
        yPos += 20;
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${selectedSite} Specific Metrics:`, 15, yPos);
        
        yPos += 8;
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        const siteRecordableRate = recordableCount > 0 ? ((recordableCount / filteredData.length) * 200000 / 40).toFixed(2) : '0.00';
        doc.text(`• Estimated TRIR: ${siteRecordableRate} (per 200,000 hours)`, 20, yPos);
        doc.text(`• DAFW Rate: ${(lostTimeCount / filteredData.length * 100).toFixed(1)}%`, 20, yPos + 7);
    }
    
    // Footer
    doc.setFontSize(8);
    setGrayColor();
    doc.text('Amazon WHS - Injury & Illness Analysis Tool', 105, 285, { align: 'center' });
    doc.text('Page 2 of 2', 195, 285);
    
    // Save the PDF
    doc.save(`InjuryIllnessReport_${selectedSite || 'AllSites'}_${new Date().toISOString().split('T')[0]}.pdf`);
    
    showStatus('Professional PDF report generated successfully!', 'success');
}

// Helper functions for PDF generation
function getReportPeriod() {
    if (filteredData.length === 0) return 'No data';
    
    const dates = filteredData
        .map(r => r.parsedDate)
        .filter(d => d && !isNaN(d))
        .sort((a, b) => a - b);
    
    if (dates.length === 0) return 'Date range not available';
    
    const start = dates[0].toLocaleDateString('en-GB');
    const end = dates[dates.length - 1].toLocaleDateString('en-GB');
    
    return `${start} - ${end}`;
}

function getTopBodyPart() {
    const bodyPartCounts = {};
    filteredData.forEach(row => {
        const part = row.bodyPart || 'Unknown';
        bodyPartCounts[part] = (bodyPartCounts[part] || 0) + 1;
    });
    
    const sorted = Object.entries(bodyPartCounts).sort((a, b) => b[1] - a[1]);
    return sorted.length > 0 ? sorted[0][0] : 'N/A';
}

function getBodyPartAverageSeverity(bodyPart) {
    const partIncidents = filteredData.filter(r => r.bodyPart === bodyPart);
    
    let severityScore = 0;
    let count = 0;
    
    partIncidents.forEach(incident => {
        const severityMap = { 'A': 4, 'B': 3, 'C': 2, 'D': 1 };
        if (severityMap[incident.standardSeverity]) {
            severityScore += severityMap[incident.standardSeverity];
            count++;
        }
    });
    
    return count > 0 ? severityScore / count : 0;
}

function getSeverityColor(avgSeverity) {
    if (avgSeverity >= 3.5) return [183, 28, 28]; // Red
    if (avgSeverity >= 2.5) return [255, 87, 34]; // Orange
    if (avgSeverity >= 1.5) return [255, 193, 7]; // Yellow
    return [76, 175, 80]; // Green
}

function getMonthlyTrendSummary() {
    const monthlyData = {};
    filteredData.forEach(row => {
        if (row.parsedDate && !isNaN(row.parsedDate)) {
            const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
            monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
        }
    });
    
    const sortedMonths = Object.keys(monthlyData).sort();
    if (sortedMonths.length < 2) return 'Insufficient data for trend analysis.';
    
    const recentMonth = monthlyData[sortedMonths[sortedMonths.length - 1]];
    const previousMonth = monthlyData[sortedMonths[sortedMonths.length - 2]];
    const change = ((recentMonth - previousMonth) / previousMonth * 100).toFixed(1);
    
    return `Most recent month shows ${recentMonth} incidents, ${change > 0 ? 'an increase' : 'a decrease'} of ${Math.abs(change)}% from the previous month. Average monthly incidents: ${(Object.values(monthlyData).reduce((a, b) => a + b, 0) / sortedMonths.length).toFixed(1)}.`;
}
        
        function refreshDashboard() {
            if (rawData.length > 0) {
                applyFilters();
                showStatus('Dashboard refreshed successfully!', 'success');
            } else {
                alert('No data loaded. Please import a CSV file first.');
            }
        }
        
        function exportDashboard() {
            showStatus('Capturing dashboard...', 'info');
            
            html2canvas(document.getElementById('dashboard')).then(canvas => {
                const link = document.createElement('a');
                link.download = `Dashboard_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showStatus('Dashboard exported as image!', 'success');
            });
        }
        
        function exportRawData() {
            if (filteredData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const csv = convertToCSV(filteredData);
            downloadCSV(csv, 'injury_illness_filtered_data.csv');
        }
        
        function convertToCSV(data) {
            if (data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => 
                headers.map(header => {
                    const value = row[header] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',')
            );
            
            return [csvHeaders, ...csvRows].join('\n');
        }
        
        function downloadCSV(csv, filename) {
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function viewDetails(caseNumber) {
            const incident = filteredData.find(r => r.case_number === caseNumber);
            if (incident) {
                const details = `Injury & Illness Details:
                
Case Number: ${caseNumber}
Date: ${incident.incident_date || 'N/A'}
Time: ${incident.incident_time || 'N/A'}
Site: ${incident.site || 'N/A'}
Region: ${incident.region || 'N/A'}

Body Part: ${incident.bodyPart || 'N/A'}
Type: ${incident.type || 'N/A'}
Severity: ${incident.standardSeverity || 'N/A'}
Recordable: ${incident.recordable === 1 ? 'Yes' : 'No'}

DAFW Days: ${incident.total_dafw_days || 0}
RWA Days: ${incident.total_rwa_days || 0}

Description: ${incident.initial_info_incident_description || 'No description available'}

Root Cause: ${incident.rootCause || 'Under investigation'}
Contributing Factors: ${incident.rca_contributing_factor_category || 'N/A'}

Status: ${incident.status || 'N/A'}`;
                
                alert(details);
            }
        }
        
        function closePDFPreview() {
            document.getElementById('pdfPreview').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        
        // Test with sample data
        function testWithSampleData() {
            showStatus('Loading sample injury data...', 'info');
            
            rawData = [
                {
                    case_number: 'INJ-VIE-202401-001',
                    incident_date: '2024-01-15',
                    incident_time: '10:30 AM',
                    site: 'Vienna DC1',
                    region: 'EU',
                    country: 'Austria',
                    initial_info_principal_body_part: 'Back - Lower',
                    initial_info_detailed_body_part: 'Lumbar Region',
                    type: 'Strain/Sprain',
                    severity: 'B',
                    potential_severity: 'B',
                    recordable: 1,
                    total_dafw_days: 5,
                    total_rwa_days: 10,
                    initial_info_incident_description: 'Associate lifted heavy box improperly',
                    rca_primary_cause: 'Human Error',
                    rca_contributing_factor_category: 'Process Gap',
                    initial_info_impact_type_primary: 'Lifting/Lowering',
                    initial_info_process_path: 'Stow',
                    initial_info_incident_on_the_road: 'no',
                    status: 'Closed',
                    created_at: '2024-01-15',
                    initial_risk_assessment_likeliness: 'Likely'
                },
                {
                    case_number: 'INJ-VIE-202401-002',
                    incident_date: '2024-01-20',
                    incident_time: '2:15 PM',
                    site: 'Vienna DC1',
                    region: 'EU',
                    country: 'Austria',
                    initial_info_principal_body_part: 'Hand',
                    initial_info_detailed_body_part: 'Fingers',
                    type: 'Cut/Laceration',
                    severity: 'C',
                    potential_severity: 'C',
                    recordable: 0,
                    total_dafw_days: 0,
                    total_rwa_days: 0,
                    initial_info_incident_description: 'Minor cut from box cutter',
                    rca_primary_cause: 'Equipment',
                    rca_contributing_factor_category: 'PPE',
                    initial_info_impact_type_primary: 'Cut/Puncture',
                    initial_info_process_path: 'Pack',
                    initial_info_incident_on_the_road: 'no',
                    status: 'Closed',
                    created_at: '2024-01-20',
                    initial_risk_assessment_likeliness: 'Possible'
                },
                {
                    case_number: 'INJ-GRZ-202402-003',
                    incident_date: '2024-02-01',
                    incident_time: '9:00 AM',
                    site: 'Graz FC',
                    region: 'EU',
                    country: 'Austria',
                    initial_info_principal_body_part: 'Ankle',
                    initial_info_detailed_body_part: 'Left Ankle',
                    type: 'Slip/Trip/Fall',
                    severity: 'A',
                    potential_severity: 'A',
                    recordable: 1,
                    total_dafw_days: 30,
                    total_rwa_days: 60,
                    initial_info_incident_description: 'Slipped on wet floor, ankle fracture',
                    rca_primary_cause: 'Environment',
                    rca_contributing_factor_category: 'Housekeeping',
                    initial_info_impact_type_primary: 'Fall - Same Level',
                    initial_info_process_path: 'General Facility',
                    initial_info_incident_on_the_road: 'no',
                    status: 'Open',
                    created_at: '2024-02-01',
                    initial_risk_assessment_likeliness: 'Unlikely'
                },
                {
                    case_number: 'INJ-VIE-202402-004',
                    incident_date: '2024-02-15',
                    incident_time: '11:45 AM',
                    site: 'Vienna DC2',
                    region: 'EU',
                    country: 'Austria',
                    initial_info_principal_body_part: 'Shoulder',
                    initial_info_detailed_body_part: 'Right Shoulder',
                    type: 'Repetitive Motion',
                    severity: 'C',
                    potential_severity: 'B',
                    recordable: 1,
                    total_dafw_days: 0,
                    total_rwa_days: 14,
                    initial_info_incident_description: 'Shoulder pain from repetitive scanning',
                    rca_primary_cause: 'Ergonomics',
                    rca_contributing_factor_category: 'Work Design',
                    initial_info_impact_type_primary: 'Repetitive Motion',
                    initial_info_process_path: 'Pick',
                    initial_info_incident_on_the_road: 'no',
                    status: 'Open',
                    created_at: '2024-02-15',
                    initial_risk_assessment_likeliness: 'Almost Certain'
                },
                {
                    case_number: 'INJ-VIE-202402-005',
                    incident_date: '2024-02-20',
                    incident_time: '3:30 PM',
                    site: 'Vienna DC1',
                    region: 'EU',
                    country: 'Austria',
                    initial_info_principal_body_part: 'Head',
                    initial_info_detailed_body_part: 'Forehead',
                    type: 'Struck By',
                    severity: 'B',
                    potential_severity: 'A',
                    recordable: 1,
                    total_dafw_days: 2,
                    total_rwa_days: 5,
                    initial_info_incident_description: 'Struck by falling package from conveyor',
                    rca_primary_cause: 'Equipment Failure',
                    rca_contributing_factor_category: 'Maintenance',
                    initial_info_impact_type_primary: 'Struck By Object',
                    initial_info_process_path: 'Sortation',
                    initial_info_incident_on_the_road: 'no',
                    status: 'Closed',
                    created_at: '2024-02-20',
                    initial_risk_assessment_likeliness: 'Rare'
                },
                {
                    case_number: 'INJ-VIE-202403-006',
                    incident_date: '2024-03-05',
                    incident_time: '8:00 AM',
                    site: 'Vienna DC1',
                    region: 'EU',
                    country: 'Austria',
                    initial_info_principal_body_part: 'Multiple Body Parts',
                    initial_info_detailed_body_part: 'Head, Arms',
                    type: 'Vehicle Accident',
                    severity: 'A',
                    potential_severity: 'A',
                    recordable: 1,
                    total_dafw_days: 15,
                    total_rwa_days: 30,
                    initial_info_incident_description: 'Delivery vehicle accident on highway',
                    rca_primary_cause: 'Human Error',
                    rca_contributing_factor_category: 'Training',
                    initial_info_impact_type_primary: 'Vehicle Collision',
                    initial_info_process_path: 'Transportation',
                    initial_info_incident_on_the_road: 'yes',
                    status: 'Open',
                    created_at: '2024-03-05',
                    initial_risk_assessment_likeliness: 'Unlikely'
                }
            ];
            
            console.log('Sample data loaded:', rawData.length, 'records');
            processData();
            populateFilters();
            applyFilters();
            showStatus('Sample injury data loaded successfully! You can now explore the dashboard.', 'success');
        }
        
        // Debug information
        function debugInfo() {
            const info = {
                'Browser': navigator.userAgent,
                'Papa Parse loaded': typeof Papa !== 'undefined',
                'XLSX loaded': typeof XLSX !== 'undefined',
                'Chart.js loaded': typeof Chart !== 'undefined',
                'jsPDF loaded': typeof jsPDF !== 'undefined',
                'html2canvas loaded': typeof html2canvas !== 'undefined',
                'File input exists': document.getElementById('csvInput') !== null,
                'Raw data count': rawData.length,
                'Filtered data count': filteredData.length
            };
            
            console.log('Debug Information:', info);
            alert('Debug Info (check console for details):\n\n' + 
                  Object.entries(info).map(([key, value]) => `${key}: ${value}`).join('\n'));
        }
    </script>
</body>
</html>
