<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon WHS Austria - SIFA Begehungen Audit Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .hidden { display: none; }
        section { margin-bottom: 20px; }
        .question { margin-bottom: 10px; }
        .critical { color: red; font-weight: bold; }
        button { margin-right: 10px; }
        #audit-form { max-width: 800px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- JSZip for ZIP export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Netlify Identity for User Management -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
    <h1>Amazon WHS Austria - SIFA Begehungen auf dem Shopfloor</h1>
    <p>Willkommen zum Safety Audit Tool, inspiriert von SafetyCulture. Loggen Sie sich ein, um Audits durchzuführen.</p>

    <!-- Login Section -->
    <section id="login-section">
        <button onclick="netlifyIdentity.open('login')">Login</button>
        <button onclick="netlifyIdentity.open('signup')">Registrieren</button>
    </section>

    <!-- Audit Form Section -->
    <section id="audit-section" class="hidden">
        <h2>Audit Durchführen</h2>
        <form id="audit-form">
            <!-- Audit Info -->
            <label for="audit-date">Datum/Zeit:</label>
            <input type="datetime-local" id="audit-date" required><br><br>
            <label for="audit-location">Location:</label>
            <input type="text" id="audit-location" value="DVI1" required><br><br>
            <label for="audit-area">Area:</label>
            <input type="text" id="audit-area" value="N/A"><br><br>
            <label for="audit-shift">Shift:</label>
            <input type="text" id="audit-shift" value="Spätschicht"><br><br>

            <!-- Questions will be dynamically added here -->
            <div id="questions-container"></div>

            <button type="button" onclick="submitAudit()">Audit Abschicken</button>
            <button type="button" onclick="exportPDF()">Als PDF Exportieren</button>
        </form>
    </section>

    <!-- Admin Section -->
    <section id="admin-section" class="hidden">
        <h2>Admin Panel</h2>
        <button onclick="viewArchives()">Archiv Anzeigen</button>
        <button onclick="exportZIP()">Archiv als ZIP Exportieren</button>
        <div id="archive-table"></div>
    </section>

    <script>
        // Netlify Identity Setup
        netlifyIdentity.on('init', user => {
            if (user) {
                currentUser = user;
                currentRole = user.app_metadata.roles ? user.app_metadata.roles[0] : 'User'; // Assume roles set in Identity
                showAuditSection();
                if (currentRole === 'Admin') {
                    document.getElementById('admin-section').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
            }
        });
        netlifyIdentity.on('login', user => {
            currentUser = user;
            currentRole = user.app_metadata.roles ? user.app_metadata.roles[0] : 'User';
            showAuditSection();
            if (currentRole === 'Admin') {
                document.getElementById('admin-section').classList.remove('hidden');
            }
        });
        netlifyIdentity.on('logout', () => {
            currentUser = null;
            currentRole = null;
            location.reload();
        });

        let currentUser = null;
        let currentRole = null;

        function showAuditSection() {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('audit-section').classList.remove('hidden');
            loadQuestions();
        }

        // Questions from PDF (reconstructed with OCR fixes)
        const sections = [
            {
                title: '1. ALLGEMEINE SICHERHEIT',
                questions: [
                    { id: '1.1', text: 'Sind Sicherheitshinweise und Fluchtwegpläne deutlich sichtbar?', critical: true },
                    { id: '1.2', text: 'Sind alle Notausgänge frei und gut gekennzeichnet?', critical: true },
                    { id: '1.3', text: 'Ist die Erste Hilfe Ausstattung vollständig und erreichbar?', critical: true },
                    { id: '1.4', text: 'Ist die Notfallausrüstung (Augenspülung, Feuerlöscher) zugänglich?', critical: false },
                    { id: '1.5', text: 'Tragen alle Mitarbeiter die korrekte PSA?', critical: false },
                    { id: '1.6', text: 'Tragen die Mitarbeiter Badges sichtbar?', critical: false },
                    { id: '1.7', text: 'Entsprechen Freizeitkleidung den Sicherheitsvorschriften?', critical: false },
                    { id: '1.8', text: 'Sind aktuelle Arbeitsanweisungen verfügbar?', critical: false }
                ]
            },
            // ... (rest of sections as before, omitted for brevity)
        ];

        function loadQuestions() {
            const container = document.getElementById('questions-container');
            sections.forEach(section => {
                const sectionElem = document.createElement('h3');
                sectionElem.textContent = section.title;
                container.appendChild(sectionElem);
                section.questions.forEach(q => {
                    const div = document.createElement('div');
                    div.classList.add('question');
                    if (q.critical) div.classList.add('critical');
                    div.innerHTML = `
                        <label>${q.id}: ${q.text} ${q.critical ? '(CRITICAL)' : ''}</label><br>
                        <input type="radio" name="${q.id}" value="YES"> Ja
                        <input type="radio" name="${q.id}" value="NO"> Nein
                        <input type="radio" name="${q.id}" value="NO RESPONSE"> Keine Antwort<br>
                    `;
                    container.appendChild(div);
                });
            });
        }

        async function submitAudit() {
            const form = document.getElementById('audit-form');
            const data = {
                date: document.getElementById('audit-date').value,
                location: document.getElementById('audit-location').value,
                area: document.getElementById('audit-area').value,
                shift: document.getElementById('audit-shift').value,
                answers: {},
                user: currentUser.email
            };

            // Collect answers
            sections.flatMap(s => s.questions).forEach(q => {
                const selected = form.querySelector(`input[name="${q.id}"]:checked`);
                data.answers[q.id] = selected ? selected.value : 'NO RESPONSE';
            });

            // Calculate score
            const totalItems = Object.keys(data.answers).length;
            const passed = Object.values(data.answers).filter(a => a === 'YES').length;
            const criticalFails = sections.flatMap(s => s.questions).filter(q => q.critical && data.answers[q.id] === 'NO').length;
            data.score = {
                overall: Math.round((passed / totalItems) * 100),
                passed: passed,
                total: totalItems,
                criticalFails: criticalFails
            };

            // Save to Netlify Blobs via Function
            const response = await fetch('/.netlify/functions/save-audit', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Authorization': `Bearer ${currentUser.token.access_token}` }
            });
            if (response.ok) {
                alert('Audit gespeichert! Score: ' + data.score.overall + '%');
            } else {
                alert('Fehler beim Speichern.');
            }
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Amazon WHS Austria Audit Report', 10, 10);
            // Add content (simplified)
            doc.save('audit-report.pdf');
        }

        async function viewArchives() {
            if (currentRole !== 'Admin') return alert('Nur für Admin');
            const response = await fetch('/.netlify/functions/get-audits', {
                headers: { 'Authorization': `Bearer ${currentUser.token.access_token}` }
            });
            const audits = await response.json();
            const table = document.getElementById('archive-table');
            table.innerHTML = '<table><tr><th>Date</th><th>Score</th><th>User</th></tr>' + 
                audits.map(a => `<tr><td>${a.date}</td><td>${a.score.overall}%</td><td>${a.user}</td></tr>`).join('') + 
                '</table>';
        }

        async function exportZIP() {
            if (currentRole !== 'Admin') return alert('Nur für Admin');
            const response = await fetch('/.netlify/functions/get-audits', {
                headers: { 'Authorization': `Bearer ${currentUser.token.access_token}` }
            });
            const audits = await response.json();
            const zip = new JSZip();
            audits.forEach((audit, index) => {
                zip.file(`audit_${index}.json`, JSON.stringify(audit));
            });
            const content = await zip.generateAsync({type: 'blob'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(content);
            a.download = 'audits_archive.zip';
            a.click();
        }

        // Deployment Instructions:
        // 1. Erstelle ein Netlify-Projekt und aktiviere Netlify Identity für User Management (füge Rollen wie 'User', 'Admin' hinzu).
        // 2. Installiere @netlify/blobs via npm (package.json hinzufügen).
        // 3. Erstelle Netlify Functions in /netlify/functions/:

        // save-audit.js
        /*
        import { getStore } from "@netlify/blobs";
        import { v4 as uuid } from "uuid"; // npm install uuid

        export default async (req) => {
          const body = await req.json();
          const auditsStore = getStore("audits");
          const key = `audit-${uuid()}`;
          await auditsStore.setJSON(key, body);
          return new Response(JSON.stringify({ key }), { status: 200 });
        };
        */

        // get-audits.js
        /*
        import { getStore } from "@netlify/blobs";

        export default async () => {
          const auditsStore = getStore("audits");
          const { keys } = await auditsStore.list();
          const audits = await Promise.all(keys.map(async (key) => await auditsStore.get(key, { type: "json" })));
          return new Response(JSON.stringify(audits), { status: 200 });
        };
        */

        // Für Auth in Functions: Verwende context.identity für Überprüfung.
        // Deploye auf Netlify; Functions werden automatisch erkannt.
    </script>
</body>
</html>
