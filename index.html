<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff9900">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="icon-192.svg">
    <link rel="apple-touch-icon" href="icon-192.svg">
    <title>WHS Safety Audit - Amazon Austria</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #ff9900;
            --primary-dark: #e88b00;
            --primary-light: #ffb84d;
            --secondary: #232f3e;
            --secondary-light: #37475a;
            --success: #00d97e;
            --danger: #dc3545;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --white: #ffffff;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 16px rgba(0,0,0,0.15);
            --shadow-xl: 0 8px 32px rgba(0,0,0,0.2);
            --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            --gradient-secondary: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-light) 100%);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f0f2f5;
            color: var(--dark);
            line-height: 1.5;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            touch-action: pan-y;
        }

        /* Enhanced App Container */
        .app {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            background: linear-gradient(to bottom, #f0f2f5 0%, #e9ecef 100%);
        }

        /* Enhanced Header */
        .app-header {
            background: var(--white);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            height: 65px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-logo svg {
            width: 36px;
            height: 36px;
        }

        .header-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--secondary);
            display: flex;
            flex-direction: column;
            line-height: 1.2;
        }

        .header-subtitle {
            font-size: 0.75rem;
            font-weight: 400;
            color: var(--gray);
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.875rem;
            margin-right: 0.5rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: var(--danger);
            animation: none;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .icon-btn {
            background: none;
            border: none;
            padding: 0.75rem;
            cursor: pointer;
            border-radius: 50%;
            color: var(--gray);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            position: relative;
        }

        .icon-btn:hover {
            background-color: var(--light);
            transform: scale(1.05);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        .icon-btn.primary {
            color: var(--primary);
        }

        .notification-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: var(--white);
            font-size: 0.65rem;
            padding: 2px 5px;
            border-radius: 10px;
            font-weight: 600;
        }

        /* Enhanced Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 env(safe-area-inset-bottom);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            color: var(--gray);
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            top: -2px;
            left: 20%;
            right: 20%;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 3px 3px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { width: 0; left: 50%; right: 50%; }
            to { left: 20%; right: 20%; }
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 0.25rem;
            transition: transform 0.3s ease;
        }

        .nav-item:active .nav-icon {
            transform: scale(0.9);
        }

        .nav-label {
            font-size: 0.75rem;
            font-weight: 500;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding-bottom: 70px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Enhanced Login Screen */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
            background: var(--gradient-primary);
            position: relative;
            overflow: hidden;
        }

        .login-screen::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(-30px, -30px) rotate(120deg); }
            66% { transform: translate(30px, -30px) rotate(240deg); }
        }

        .login-card {
            background: var(--white);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            margin: 0 auto;
            width: 100%;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.1));
        }

        .login-logo h1 {
            color: var(--secondary);
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
        }

        .login-logo p {
            color: var(--gray);
            font-size: 0.875rem;
        }

        /* Enhanced Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--secondary);
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .form-control {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 2px solid #e1e4e8;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background-color: var(--white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 153, 0, 0.1);
            transform: translateY(-2px);
        }

        .form-input-icon {
            position: absolute;
            right: 1rem;
            top: 2.5rem;
            color: var(--gray);
            pointer-events: none;
        }

        /* Enhanced Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            width: 100%;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 153, 0, 0.4);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--dark);
        }

        .btn-secondary:hover {
            background: #e9ecef;
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--gradient-primary);
            color: var(--white);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);
            color: var(--white);
        }

        .btn-sm {
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
        }

        .btn-icon {
            padding: 0.625rem;
            width: auto;
            border-radius: 50%;
        }

        /* Enhanced Cards */
        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .card:hover::before {
            transform: scaleX(1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Enhanced Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 1rem;
        }

        .stat-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 100%;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0.1;
            border-radius: 50%;
            transition: all 0.6s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .stat-card:hover::before {
            top: -25%;
            right: -25%;
            width: 150%;
            height: 150%;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 1rem;
            color: var(--primary);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
            position: relative;
            z-index: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--gray);
            margin-top: 0.5rem;
            font-weight: 500;
        }

        .stat-trend {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: var(--success);
        }

        .stat-trend.down {
            color: var(--danger);
        }

        /* Enhanced Audit Questions */
        .question-container {
            padding: 1rem;
        }

        .section-header {
            background: linear-gradient(135deg, var(--light) 0%, #e9ecef 100%);
            padding: 1.25rem;
            margin: -1rem -1rem 1.5rem -1rem;
            border-bottom: 3px solid var(--primary);
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 0;
            width: 60px;
            height: 3px;
            background: var(--secondary);
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .question-card {
            background: var(--white);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .question-card.critical {
            border-left: 4px solid var(--danger);
            background: linear-gradient(to right, rgba(220, 53, 69, 0.05) 0%, transparent 100%);
        }

        .question-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .question-number {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.875rem;
            background: rgba(255, 153, 0, 0.1);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
        }

        .critical-badge {
            background: var(--danger);
            color: var(--white);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .question-text {
            color: var(--dark);
            margin-bottom: 1rem;
            line-height: 1.6;
            font-size: 1.0625rem;
        }

        .basis-text {
            font-size: 0.8125rem;
            color: var(--gray);
            font-style: italic;
            margin-bottom: 1rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border-radius: 8px;
            border-left: 3px solid var(--primary);
        }

        .answer-section {
            margin-top: 1.5rem;
        }

        .answer-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .answer-btn {
            padding: 1rem;
            border: 2px solid #e1e4e8;
            background: var(--white);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .answer-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .answer-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: var(--white);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
        }

        .answer-btn.selected.no {
            border-color: var(--danger);
            background: var(--danger);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .answer-btn.selected.na {
            border-color: var(--gray);
            background: var(--gray);
            box-shadow: 0 4px 12px rgba(108, 117, 125, 0.3);
        }

        /* Comment and Photo Section */
        .comment-section {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 12px;
            display: none;
        }

        .comment-section.active {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .comment-textarea {
            width: 100%;
            min-height: 80px;
            padding: 0.75rem;
            border: 2px solid #e1e4e8;
            border-radius: 8px;
            font-size: 0.875rem;
            resize: vertical;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .comment-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
        }

        .photo-section {
            margin-top: 1rem;
        }

        .photo-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .photo-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            background: #f0f2f5;
            cursor: pointer;
        }

        .photo-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
        }

        .add-photo-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border: 2px dashed var(--primary);
            background: rgba(255, 153, 0, 0.05);
            border-radius: 8px;
            color: var(--primary);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .add-photo-btn:hover {
            background: rgba(255, 153, 0, 0.1);
            transform: translateY(-2px);
        }

        .toggle-extras-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--light);
            border: none;
            border-radius: 8px;
            color: var(--secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0.5rem;
        }

        .toggle-extras-btn:hover {
            background: #e9ecef;
        }

        .toggle-extras-btn.active {
            background: var(--primary);
            color: var(--white);
        }

        /* Enhanced Progress Bar */
        .progress-container {
            position: sticky;
            top: 65px;
            background: var(--white);
            padding: 1.25rem;
            z-index: 100;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            backdrop-filter: blur(10px);
            background: rgba(255,255,255,0.95);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            color: var(--secondary);
            font-weight: 500;
        }

        .progress-bar {
            height: 10px;
            background: var(--light);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        /* Enhanced FAB */
        .fab {
            position: fixed;
            bottom: 90px;
            right: 1.5rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: var(--white);
            border: none;
            box-shadow: 0 4px 20px rgba(255, 153, 0, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 30px rgba(255, 153, 0, 0.5);
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* Enhanced Audit List */
        .audit-list {
            padding: 1rem;
        }

        .audit-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
            -webkit-overflow-scrolling: touch;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            background: var(--white);
            border: 2px solid #e1e4e8;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            white-space: nowrap;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-chip.active {
            background: var(--primary);
            color: var(--white);
            border-color: var(--primary);
        }

        .audit-item {
            background: var(--white);
            border-radius: 16px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .audit-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .audit-item:hover {
            transform: translateX(8px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        }

        .audit-item:hover::before {
            transform: scaleY(1);
        }

        .audit-item:active {
            transform: scale(0.98);
        }

        .audit-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .audit-location {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.25rem;
        }

        .audit-score {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            line-height: 1;
        }

        .audit-score.high {
            color: var(--success);
        }

        .audit-score.medium {
            color: var(--warning);
        }

        .audit-score.low {
            color: var(--danger);
        }

        .audit-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--gray);
        }

        .audit-meta-item {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .audit-meta-item svg {
            width: 16px;
            height: 16px;
        }

        .audit-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--light);
        }

        /* User Management */
        .user-list {
            padding: 1rem;
        }

        .user-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            background: var(--white);
            border-radius: 12px;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        .user-item:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            margin-right: 1rem;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.25rem;
        }

        .user-email {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .user-role {
            padding: 0.25rem 0.75rem;
            background: var(--light);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--secondary);
        }

        .user-role.admin {
            background: rgba(255, 153, 0, 0.1);
            color: var(--primary);
        }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 3rem;
            gap: 1rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s cubic-bezier(0.68, -0.55, 0.265, 1.55) infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--gray);
            font-size: 0.875rem;
        }

        /* Enhanced Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .alert-success {
            background: linear-gradient(135deg, rgba(0, 217, 126, 0.1) 0%, rgba(0, 217, 126, 0.05) 100%);
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .alert-danger {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(220, 53, 69, 0.05) 100%);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .alert-info {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.1) 0%, rgba(23, 162, 184, 0.05) 100%);
            color: var(--info);
            border-left: 4px solid var(--info);
        }

        /* Enhanced Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--white);
            border-radius: 24px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px) scale(0.9);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-xl);
        }

        .modal.active .modal-content {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--light);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
        }

        .modal-subtitle {
            font-size: 0.875rem;
            color: var(--gray);
            margin-top: 0.25rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 2rem;
        }

        /* Enhanced Toast Notifications */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 3000;
            pointer-events: none;
        }

        .toast {
            background: var(--white);
            border-radius: 12px;
            padding: 1rem 1.25rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-xl);
            min-width: 280px;
            max-width: 400px;
            transform: translateX(400px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            pointer-events: all;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.125rem;
        }

        .toast-message {
            font-size: 0.875rem;
            color: var(--gray);
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.success .toast-icon {
            color: var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        .toast.error .toast-icon {
            color: var(--danger);
        }

        .toast.info {
            border-left: 4px solid var(--info);
        }

        .toast.info .toast-icon {
            color: var(--info);
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 3rem 1.5rem;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 1.5rem;
            color: var(--gray);
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .empty-state-text {
            color: var(--gray);
            margin-bottom: 1.5rem;
        }

        /* Search Bar */
        .search-bar {
            position: relative;
            margin: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.875rem 1rem 0.875rem 3rem;
            border: 2px solid #e1e4e8;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--white);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(255, 153, 0, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            color: var(--gray);
            pointer-events: none;
        }

        /* Action Sheets */
        .action-sheet {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--white);
            border-radius: 24px 24px 0 0;
            padding: 1.5rem;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2500;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
        }

        .action-sheet.active {
            transform: translateY(0);
        }

        .action-sheet-handle {
            width: 40px;
            height: 4px;
            background: var(--gray);
            border-radius: 2px;
            margin: 0 auto 1.5rem;
            opacity: 0.3;
        }

        .action-sheet-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--secondary);
            margin-bottom: 1rem;
            text-align: center;
        }

        .action-sheet-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .action-sheet-option {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-sheet-option:hover {
            background: var(--light);
        }

        .action-sheet-option-icon {
            width: 24px;
            height: 24px;
            color: var(--primary);
        }

        .action-sheet-option-text {
            flex: 1;
            font-weight: 500;
        }

        /* Demo Accounts */
        .demo-accounts {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e1e4e8;
            font-size: 0.875rem;
            color: var(--gray);
            text-align: center;
        }

        .demo-accounts h4 {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--secondary);
        }

        .demo-accounts p {
            margin: 0.25rem 0;
            font-family: monospace;
        }

        /* Responsive */
        @media (min-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .answer-buttons {
                display: flex;
                justify-content: flex-start;
                gap: 1rem;
            }
            
            .answer-btn {
                width: auto;
                padding: 0.875rem 2.5rem;
            }

            .photo-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .modal-content {
                max-width: 600px;
            }
        }

        @media (min-width: 1024px) {
            .main-content {
                max-width: 1200px;
                margin: 0 auto;
            }
            
            .audit-list,
            .user-list,
            .question-container {
                max-width: 800px;
                margin: 0 auto;
            }
        }

        /* Print Styles */
        @media print {
            .app-header,
            .bottom-nav,
            .fab,
            .btn,
            .icon-btn {
                display: none !important;
            }
            
            .main-content {
                padding-bottom: 0;
            }
            
            .card {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* Icons */
        .icon {
            width: 24px;
            height: 24px;
            display: inline-block;
            vertical-align: middle;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--gray); }
        .text-small { font-size: 0.875rem; }
        .text-xs { font-size: 0.75rem; }
        .font-medium { font-weight: 500; }
        .font-semibold { font-weight: 600; }
        .font-bold { font-weight: 700; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .p-1 { padding: 0.5rem; }
        .p-2 { padding: 1rem; }
        .p-3 { padding: 1.5rem; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
        .w-full { width: 100%; }
        .overflow-hidden { overflow: hidden; }
        .cursor-pointer { cursor: pointer; }
    </style>
</head>
<body>
    <div class="app">
        <!-- Login Screen -->
        <div id="loginScreen" class="login-screen">
            <div class="login-card">
                <div class="login-logo">
                    <svg viewBox="0 0 192 192" fill="none">
                        <rect width="192" height="192" rx="32" fill="#FF9900"/>
                        <path d="M96 40C119.196 40 138 58.804 138 82C138 100.054 125.473 115.366 108.134 119.748C105.623 120.435 102.95 120.814 100.184 120.814H91.816C89.05 120.814 86.377 120.435 83.866 119.748C66.527 115.366 54 100.054 54 82C54 58.804 72.804 40 96 40Z" stroke="white" stroke-width="8"/>
                        <path d="M96 64L104.944 81.472L124 84.216L110 97.528L113.056 116L96 107.472L78.944 116L82 97.528L68 84.216L87.056 81.472L96 64Z" fill="white"/>
                        <rect x="76" y="116" width="40" height="36" rx="4" fill="white"/>
                        <path d="M88 132H104M88 140H104" stroke="#FF9900" stroke-width="4" stroke-linecap="round"/>
                    </svg>
                    <h1>WHS Safety Audit</h1>
                    <p>Amazon Austria</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label class="form-label" for="username">Email</label>
                        <input type="email" id="username" class="form-control" required placeholder="z.B. admin@amazon.at">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">Passwort</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"></path>
                        </svg>
                        Anmelden
                    </button>
                </form>
                <div id="loginError" class="alert alert-danger mt-2 hidden"></div>
                <div class="demo-accounts">
                    <h4>Demo Accounts:</h4>
                    <p>admin@amazon.at / admin123</p>
                    <p>safety@amazon.at / safety123</p>
                    <p>manager@amazon.at / manager123</p>
                </div>
            </div>
        </div>

        <!-- Main App -->
        <div id="mainApp" class="hidden">
            <!-- Header -->
            <header class="app-header">
                <div class="header-content">
                    <div class="header-logo">
                        <svg viewBox="0 0 192 192" fill="none">
                            <rect width="192" height="192" rx="32" fill="#FF9900"/>
                            <path d="M96 40C119.196 40 138 58.804 138 82C138 100.054 125.473 115.366 108.134 119.748C105.623 120.435 102.95 120.814 100.184 120.814H91.816C89.05 120.814 86.377 120.435 83.866 119.748C66.527 115.366 54 100.054 54 82C54 58.804 72.804 40 96 40Z" stroke="white" stroke-width="8"/>
                            <path d="M96 64L104.944 81.472L124 84.216L110 97.528L113.056 116L96 107.472L78.944 116L82 97.528L68 84.216L87.056 81.472L96 64Z" fill="white"/>
                            <rect x="76" y="116" width="40" height="36" rx="4" fill="white"/>
                            <path d="M88 132H104M88 140H104" stroke="#FF9900" stroke-width="4" stroke-linecap="round"/>
                        </svg>
                        <div class="header-title">
                            <span id="pageTitle">Dashboard</span>
                            <span class="header-subtitle">Workplace Health & Safety</span>
                        </div>
                    </div>
                    <div class="header-actions">
                        <div class="status-indicator">
                            <span class="status-dot" id="statusDot"></span>
                            <span id="statusText">Online</span>
                        </div>
                        <button class="icon-btn" onclick="showNotifications()" title="Benachrichtigungen">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                            </svg>
                            <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                        </button>
                        <button class="icon-btn" id="syncButton" onclick="syncData()" title="Daten synchronisieren">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                        </button>
                        <button class="icon-btn" onclick="showUserMenu()" title="BenutzermenÃ¼">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Main Content -->
            <main class="main-content" id="mainContent">
                <!-- Dashboard -->
                <div id="dashboardPage" class="page">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                            </svg>
                            <div class="stat-value" id="todayAudits">0</div>
                            <div class="stat-label">Heute</div>
                            <div class="stat-trend">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                <span>+12%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                            </svg>
                            <div class="stat-value" id="avgScore">0%</div>
                            <div class="stat-label">Ã Score</div>
                            <div class="stat-trend">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                <span>+5%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <div class="stat-value" id="criticalCount">0</div>
                            <div class="stat-label">Kritisch</div>
                            <div class="stat-trend down">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"></path>
                                </svg>
                                <span>-8%</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <svg class="stat-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                            </svg>
                            <div class="stat-value" id="totalAudits">0</div>
                            <div class="stat-label">Gesamt</div>
                            <div class="stat-trend">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                                </svg>
                                <span>+23%</span>
                            </div>
                        </div>
                    </div>

                    <div style="padding: 1rem;">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xl font-bold">Letzte Audits</h2>
                            <button class="btn btn-sm btn-secondary" onclick="showPage('audits', null)">
                                Alle anzeigen
                            </button>
                        </div>
                        <div id="recentAudits"></div>
                    </div>

                    <button class="fab" onclick="startNewAudit()" title="Neues Audit starten">
                        <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path>
                        </svg>
                    </button>
                </div>

                <!-- New Audit Form -->
                <div id="newAuditPage" class="page hidden">
                    <div style="padding: 1rem;">
                        <h2 class="text-xl font-bold mb-3">Neues Audit erstellen</h2>
                        <form id="auditForm">
                            <div class="form-group">
                                <label class="form-label" for="location">Location</label>
                                <select id="location" class="form-control" required>
                                    <option value="">WÃ¤hlen Sie eine Location...</option>
                                    <option value="DVI1">DVI1 - Wien</option>
                                    <option value="DVI2">DVI2 - Wien</option>
                                    <option value="DVI3">DVI3 - Wien</option>
                                    <option value="DAP5">DAP5 - Graz</option>
                                    <option value="DAP8">DAP8 - Klagenfurt</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="area">Bereich</label>
                                <input type="text" id="area" class="form-control" placeholder="z.B. Versand, Lager" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="shift">Schicht</label>
                                <select id="shift" class="form-control" required>
                                    <option value="">WÃ¤hlen Sie eine Schicht...</option>
                                    <option value="FrÃ¼hschicht">FrÃ¼hschicht</option>
                                    <option value="SpÃ¤tschicht">SpÃ¤tschicht</option>
                                    <option value="Nachtschicht">Nachtschicht</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                                </svg>
                                Audit starten
                            </button>
                            <button type="button" class="btn btn-secondary mt-1" onclick="showPage('dashboard', null)">
                                Abbrechen
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Audit Questions -->
                <div id="questionsPage" class="page hidden">
                    <div class="progress-container">
                        <div class="progress-info">
                            <span id="progressText">0 von 0 beantwortet</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="question-container" id="questionContainer"></div>
                    <div style="padding: 1rem;">
                        <button class="btn btn-primary" onclick="completeAudit()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Audit abschlieÃen
                        </button>
                        <button class="btn btn-secondary mt-1" onclick="cancelAudit()">
                            Abbrechen
                        </button>
                    </div>
                </div>

                <!-- Audits List -->
                <div id="auditsPage" class="page hidden">
                    <div class="search-bar">
                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        <input type="text" class="search-input" placeholder="Audits durchsuchen..." onkeyup="filterAudits(this.value)">
                    </div>
                    <div class="audit-filters">
                        <button class="filter-chip active" onclick="setAuditFilter('all', this)">Alle</button>
                        <button class="filter-chip" onclick="setAuditFilter('today', this)">Heute</button>
                        <button class="filter-chip" onclick="setAuditFilter('week', this)">Diese Woche</button>
                        <button class="filter-chip" onclick="setAuditFilter('month', this)">Diesen Monat</button>
                        <button class="filter-chip" onclick="setAuditFilter('critical', this)">Kritisch</button>
                    </div>
                    <div class="audit-list" id="auditList"></div>
                    <div style="padding: 1rem;">
                        <button class="btn btn-secondary" onclick="massDownloadAudits()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10"></path>
                            </svg>
                            Alle Audits herunterladen
                        </button>
                    </div>
                </div>

                <!-- Users Management -->
                <div id="usersPage" class="page hidden">
                    <div style="padding: 1rem;">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-bold">Benutzerverwaltung</h2>
                            <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">
                                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
                                </svg>
                                Benutzer hinzufÃ¼gen
                            </button>
                        </div>
                        <div class="user-list" id="userList"></div>
                    </div>
                </div>

                <!-- Settings -->
                <div id="settingsPage" class="page hidden">
                    <div style="padding: 1rem;">
                        <h2 class="text-xl font-bold mb-3">Einstellungen</h2>
                        
                        <div class="card">
                            <h3 class="card-title">Konto</h3>
                            <p class="card-subtitle" id="userInfo"></p>
                            <button class="btn btn-sm btn-secondary mt-2" onclick="changePassword()">
                                Passwort Ã¤ndern
                            </button>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Daten Export</h3>
                            <div class="flex flex-col gap-1">
                                <button class="btn btn-secondary btn-sm" onclick="exportQuestions()">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Fragen exportieren (JSON)
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="exportAllAudits()">
                                    <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                    Alle Audits exportieren
                                </button>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Fragen Import</h3>
                            <input type="file" id="importFile" accept=".json" onchange="importQuestions(event)" style="margin-bottom: 0.5rem;">
                            <div id="importMessage"></div>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Benachrichtigungen</h3>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="notificationsEnabled" checked onchange="toggleNotifications()">
                                <span>Push-Benachrichtigungen aktivieren</span>
                            </label>
                        </div>

                        <div class="card">
                            <h3 class="card-title">Ãber</h3>
                            <p class="text-small text-muted">
                                WHS Safety Audit System v2.0<br>
                                Â© 2024 Amazon Austria<br>
                                Entwickelt von Erwin Esener - WHS Austria
                            </p>
                        </div>

                        <button class="btn btn-danger" onclick="logout()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                            </svg>
                            Abmelden
                        </button>
                    </div>
                </div>
            </main>

            <!-- Bottom Navigation -->
            <nav class="bottom-nav">
                <a href="#" class="nav-item active" onclick="showPage('dashboard', this); return false;">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                    <span class="nav-label">Start</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('audits', this); return false;">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path>
                    </svg>
                    <span class="nav-label">Audits</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('users', this); return false;">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                    <span class="nav-label">Benutzer</span>
                </a>
                <a href="#" class="nav-item" onclick="showPage('settings', this); return false;">
                    <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="nav-label">Mehr</span>
                </a>
            </nav>
        </div>

        <!-- Modal -->
        <div id="modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="modalTitle">Titel</h3>
                    <p class="modal-subtitle" id="modalSubtitle"></p>
                </div>
                <div class="modal-body" id="modalBody"></div>
                <div class="modal-actions" id="modalActions"></div>
            </div>
        </div>

        <!-- Action Sheet -->
        <div id="actionSheet" class="action-sheet">
            <div class="action-sheet-handle"></div>
            <h3 class="action-sheet-title" id="actionSheetTitle">Optionen</h3>
            <div class="action-sheet-options" id="actionSheetOptions"></div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // API Configuration
        const API_BASE = window.location.hostname === 'localhost' ? 'http://localhost:8888/api' : '/api';
        
        // Audit Questions (same as before but can be imported)
        const auditQuestions = {
            "1": {
                "title": "ALLGEMEINE SICHERHEIT",
                "subsections": {
                    "Notfallausstattung": [
                        {
                            "id": "1.1",
                            "question": "Sind Sicherheitshinweise und FluchtwegplÃ¤ne deutlich sichtbar?",
                            "critical": true,
                            "basis": "AStV Â§ 19"
                        },
                        {
                            "id": "1.2",
                            "question": "Sind alle NotausgÃ¤nge frei und gut gekennzeichnet?",
                            "critical": true,
                            "basis": "AStV Â§ 20"
                        },
                        {
                            "id": "1.3",
                            "question": "Ist die Erste-Hilfe-Ausstattung vollstÃ¤ndig und erreichbar?",
                            "critical": true,
                            "basis": "ASchG Â§ 26"
                        },
                        {
                            "id": "1.4",
                            "question": "Ist die NotfallausrÃ¼stung (AugenspÃ¼lung, FeuerlÃ¶scher) zugÃ¤nglich?",
                            "critical": true,
                            "basis": null
                        }
                    ],
                    "PersÃ¶nliche SchutzausrÃ¼stung": [
                        {
                            "id": "1.5",
                            "question": "Tragen alle Mitarbeiter die korrekte PSA?",
                            "critical": false,
                            "basis": "ASchG Â§ 71"
                        },
                        {
                            "id": "1.6",
                            "question": "Sind alle Mitarbeiter-Badges sichtbar?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "1.7",
                            "question": "Entsprechen Frisur/Kleidung den Sicherheitsvorschriften? (max. SchulterhÃ¶he)",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "1.8",
                            "question": "Sind aktuelle Arbeitsanweisungen verfÃ¼gbar?",
                            "critical": false,
                            "basis": "ASchG Â§ 12"
                        }
                    ]
                }
            },
            "2": {
                "title": "ARBEITSPLATZ UND UMGEBUNG",
                "subsections": {
                    "Ordnung und Sauberkeit": [
                        {
                            "id": "2.1",
                            "question": "Ist die Lagerhalle sauber und aufgerÃ¤umt?",
                            "critical": false,
                            "basis": "AStV Â§ 4"
                        },
                        {
                            "id": "2.2",
                            "question": "Sind die BÃ¶den rutschfest und eben?",
                            "critical": true,
                            "basis": "AStV Â§ 5"
                        },
                        {
                            "id": "2.3",
                            "question": "Ist ausreichend Bewegungsfreiheit vorhanden? (min. 1,5 mÂ² pro Person)",
                            "critical": false,
                            "basis": null
                        }
                    ],
                    "Arbeitsumgebung": [
                        {
                            "id": "2.4",
                            "question": "Entspricht die Beleuchtung den Anforderungen? (min. 200 Lux)",
                            "critical": false,
                            "basis": "AStV Â§ 22"
                        },
                        {
                            "id": "2.5",
                            "question": "Ist die Raumtemperatur angemessen? (18-25Â°C)",
                            "critical": false,
                            "basis": "AStV Â§ 23"
                        },
                        {
                            "id": "2.6",
                            "question": "Ist die LÃ¼ftung ausreichend?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "2.7",
                            "question": "Liegt der LÃ¤rmpegel im zulÃ¤ssigen Bereich? (â¤ 85 dB(A))",
                            "critical": false,
                            "basis": null
                        }
                    ],
                    "Ergonomie": [
                        {
                            "id": "2.8",
                            "question": "Sind die ArbeitsplÃ¤tze ergonomisch gestaltet?",
                            "critical": false,
                            "basis": "AStV Â§ 21"
                        }
                    ]
                }
            },
            "3": {
                "title": "LAGERUNG UND TRANSPORT",
                "subsections": {
                    "Lagerbereiche": [
                        {
                            "id": "3.1",
                            "question": "Werden die 5S-Markierungen respektiert?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "3.2",
                            "question": "Sind die Lagerbereiche sicher organisiert?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "3.3",
                            "question": "Werden Lagerungen Ã¼ber Kopf vermieden?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "3.4",
                            "question": "Sind Regale ordnungsgemÃ¤Ã befestigt?",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "3.5",
                            "question": "Sind die maximalen StapelhÃ¶hen eingehalten?",
                            "critical": false,
                            "basis": null
                        }
                    ],
                    "Transportwege": [
                        {
                            "id": "3.6",
                            "question": "Sind FuÃgÃ¤ngerwege klar gekennzeichnet? (min. 1,2 m breit)",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "3.7",
                            "question": "Sind alle Transportwege frei von Hindernissen?",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "3.8",
                            "question": "Sind Gefahrenbereiche deutlich markiert?",
                            "critical": false,
                            "basis": null
                        }
                    ],
                    "FlurfÃ¶rderzeuge": [
                        {
                            "id": "3.9",
                            "question": "Sind alle FlurfÃ¶rderzeuge in gutem Zustand?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "3.10",
                            "question": "Sind die Wartungsprotokolle aktuell? (jÃ¤hrliche PrÃ¼fung)",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "3.11",
                            "question": "Sind Ladehilfsmittel unbeschÃ¤digt?",
                            "critical": false,
                            "basis": null
                        }
                    ]
                }
            },
            "4": {
                "title": "GEFAHRSTOFFE",
                "subsections": {
                    "": [
                        {
                            "id": "4.1",
                            "question": "Sind Gefahrstoffe korrekt gelagert?",
                            "critical": true,
                            "basis": "ChemG"
                        },
                        {
                            "id": "4.2",
                            "question": "Sind alle Gefahrstoffe ordnungsgemÃ¤Ã gekennzeichnet?",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "4.3",
                            "question": "Sind SicherheitsdatenblÃ¤tter verfÃ¼gbar?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "4.4",
                            "question": "Sind Gefahrstoffbereiche abgesperrt?",
                            "critical": true,
                            "basis": null
                        }
                    ]
                }
            },
            "5": {
                "title": "ERGONOMIE UND ARBEITSVERHALTEN",
                "subsections": {
                    "": [
                        {
                            "id": "5.1",
                            "question": "Vermeiden Mitarbeiter ungÃ¼nstige KÃ¶rperhaltungen?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "5.2",
                            "question": "Werden Transportwagen kontrolliert bewegt?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "5.3",
                            "question": "Werden HandlÃ¤ufe verwendet (wo vorhanden)?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "5.4",
                            "question": "Werden Hebehilfen bei schweren Lasten eingesetzt? (ab 25 kg MÃ¤nner, 15 kg Frauen)",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "5.5",
                            "question": "Werden Pausenzeiten eingehalten?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "5.6",
                            "question": "Ist der Arbeitsrhythmus angemessen?",
                            "critical": false,
                            "basis": null
                        }
                    ]
                }
            },
            "6": {
                "title": "NOTFALLVORSORGE",
                "subsections": {
                    "Personal": [
                        {
                            "id": "6.1",
                            "question": "Sind genÃ¼gend Ersthelfer verfÃ¼gbar? (1 pro 19 Mitarbeiter)",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "6.2",
                            "question": "Sind Brandschutzwarte ernannt und geschult?",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "6.3",
                            "question": "Sind die NotfallplÃ¤ne aktuell und bekannt?",
                            "critical": false,
                            "basis": null
                        }
                    ],
                    "Ãbungen": [
                        {
                            "id": "6.4",
                            "question": "Werden regelmÃ¤Ãig NotfallÃ¼bungen durchgefÃ¼hrt?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "6.5",
                            "question": "Sind SammelplÃ¤tze bekannt und gekennzeichnet?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "6.6",
                            "question": "Funktioniert das Alarmsystem ordnungsgemÃ¤Ã?",
                            "critical": true,
                            "basis": null
                        }
                    ]
                }
            },
            "7": {
                "title": "WARTUNG UND INSTANDHALTUNG",
                "subsections": {
                    "": [
                        {
                            "id": "7.1",
                            "question": "Werden Wartungsintervalle bei Toren eingehalten?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "7.2",
                            "question": "Sind FeuerlÃ¶scher-PrÃ¼ffristen aktuell? (alle 2 Jahre)",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "7.3",
                            "question": "Sind elektrische Anlagen ordnungsgemÃ¤Ã geprÃ¼ft?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "7.4",
                            "question": "Erfolgt regelmÃ¤Ãige Wartung der LÃ¼ftungsanlagen?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "7.5",
                            "question": "Sind alle Wartungsprotokolle verfÃ¼gbar?",
                            "critical": false,
                            "basis": null
                        }
                    ]
                }
            },
            "8": {
                "title": "HÃHENARBEITEN (falls zutreffend)",
                "subsections": {
                    "": [
                        {
                            "id": "8.1",
                            "question": "Sind Absturzsicherungen vorhanden?",
                            "critical": true,
                            "basis": null
                        },
                        {
                            "id": "8.2",
                            "question": "Ist spezielle SchutzausrÃ¼stung verfÃ¼gbar?",
                            "critical": false,
                            "basis": null
                        },
                        {
                            "id": "8.3",
                            "question": "Sind Arbeiten in der HÃ¶he genehmigt?",
                            "critical": false,
                            "basis": null
                        }
                    ]
                }
            }
        };

        // State
        let currentUser = null;
        let currentAudit = null;
        let isOnline = navigator.onLine;
        let auditFilter = 'all';
        let users = [];
        let notifications = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            isOnline = navigator.onLine;
            checkAuth();
            setupEventListeners();
            registerServiceWorker();
            initializeDatabase();
            
            // Check online status
            window.addEventListener('online', () => {
                isOnline = true;
                updateOnlineStatus();
                syncData();
                showNotification('Wieder online', 'info');
            });
            
            window.addEventListener('offline', () => {
                isOnline = false;
                updateOnlineStatus();
                showNotification('Offline-Modus aktiv', 'info');
            });
        });

        // Initialize IndexedDB for photos and offline storage
        async function initializeDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('WHSAuditDB', 2);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    
                    if (!db.objectStoreNames.contains('photos')) {
                        db.createObjectStore('photos', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('pending_audits')) {
                        db.createObjectStore('pending_audits', { keyPath: 'id' });
                    }
                    
                    if (!db.objectStoreNames.contains('users')) {
                        db.createObjectStore('users', { keyPath: 'id' });
                    }
                };
            });
        }

        // Save photo to IndexedDB
        async function savePhoto(photoData) {
            try {
                const db = await initializeDatabase();
                const tx = db.transaction('photos', 'readwrite');
                const store = tx.objectStore('photos');
                
                const photo = {
                    id: Date.now().toString(),
                    data: photoData,
                    timestamp: new Date().toISOString()
                };
                
                await store.add(photo);
                return photo.id;
            } catch (error) {
                console.error('Error saving photo:', error);
                return null;
            }
        }

        // Get photo from IndexedDB
        async function getPhoto(id) {
            try {
                const db = await initializeDatabase();
                const tx = db.transaction('photos', 'readonly');
                const store = tx.objectStore('photos');
                return await store.get(id);
            } catch (error) {
                console.error('Error getting photo:', error);
                return null;
            }
        }

        // Update online status indicator
        function updateOnlineStatus() {
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (isOnline) {
                statusDot.classList.remove('offline');
                statusText.textContent = 'Online';
            } else {
                statusDot.classList.add('offline');
                statusText.textContent = 'Offline';
            }
            
            updateSyncButtonStatus();
        }

        // Update sync button status
        function updateSyncButtonStatus() {
            const syncButton = document.getElementById('syncButton');
            if (!syncButton) return;
            
            const hasPendingSync = localStorage.getItem('pendingSync') === 'true';
            
            if (!isOnline) {
                syncButton.style.opacity = '0.5';
                syncButton.style.cursor = 'not-allowed';
                syncButton.title = 'Offline - Keine Synchronisation mÃ¶glich';
            } else if (!hasPendingSync) {
                syncButton.style.opacity = '0.5';
                syncButton.title = 'Keine ausstehenden Daten';
            } else {
                syncButton.style.opacity = '1';
                syncButton.style.cursor = 'pointer';
                syncButton.title = 'Daten synchronisieren';
                
                // Badge fÃ¼r ausstehende Sync
                if (!syncButton.querySelector('.notification-badge')) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = '!';
                    badge.style.background = 'var(--warning)';
                    syncButton.appendChild(badge);
                }
            }
        }

        // Register Service Worker
        async function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('./sw.js');
                    console.log('Service Worker registered:', registration);
                } catch (error) {
                    console.error('Service Worker registration failed:', error);
                }
            }
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('auditForm').addEventListener('submit', handleAuditForm);
            
            // Close modal on background click
            document.getElementById('modal').addEventListener('click', (e) => {
                if (e.target.id === 'modal') {
                    hideModal();
                }
            });
            
            // Close action sheet on background click
            document.getElementById('actionSheet').addEventListener('click', (e) => {
                if (e.target.id === 'actionSheet') {
                    hideActionSheet();
                }
            });
            
            // Add file input for photos
            const photoInput = document.createElement('input');
            photoInput.type = 'file';
            photoInput.id = 'photoInput';
            photoInput.accept = 'image/*';
            photoInput.multiple = true;
            photoInput.style.display = 'none';
            photoInput.addEventListener('change', handlePhotoUpload);
            document.body.appendChild(photoInput);
        }

        // Authentication
        async function checkAuth() {
            const token = localStorage.getItem('authToken');
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                // We have a saved user, use it
                currentUser = JSON.parse(savedUser);
                showApp();
                console.log('Logged in as:', currentUser.name);
                
                // Try to verify token if online
                if (isOnline && token) {
                    // ... optional verification
                }
            } else {
                showLogin();
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await apiCall('/auth', 'POST', { username, password });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    currentUser = data.user;
                    showApp();
                    showNotification(`Willkommen ${data.user.name}!`, 'success');
                } else {
                    showError('UngÃ¼ltige Anmeldedaten');
                }
            } catch (error) {
                // Fallback to local auth for demo
                const demoUsers = {
                    'admin@amazon.at': { password: 'admin123', data: { id: '1', username: 'admin@amazon.at', role: 'admin', name: 'Admin User' } },
                    'safety@amazon.at': { password: 'safety123', data: { id: '2', username: 'safety@amazon.at', role: 'auditor', name: 'Safety Officer' } },
                    'manager@amazon.at': { password: 'manager123', data: { id: '3', username: 'manager@amazon.at', role: 'viewer', name: 'Area Manager' } }
                };
                
                const user = demoUsers[username];
                if (user && user.password === password) {
                    currentUser = user.data;
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showApp();
                    showNotification(`Willkommen ${currentUser.name}! (Offline-Modus)`, 'info');
                } else {
                    showError('UngÃ¼ltige Anmeldedaten');
                }
            }
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            currentUser = null;
            showLogin();
            showNotification('Erfolgreich abgemeldet', 'info');
        }

        // UI Functions
        function showLogin() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').innerHTML = `
                <strong>${currentUser.name}</strong><br>
                <span class="text-small text-muted">${currentUser.username}</span><br>
                <span class="user-role ${currentUser.role}">${currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1)}</span>
            `;
            updateOnlineStatus();
            showPage('dashboard', null);
            loadUsers();
        }

        function showPage(pageName, navElement) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.add('hidden');
            });
            
            // Show selected page
            document.getElementById(pageName + 'Page').classList.remove('hidden');
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Set active nav item
            if (navElement) {
                navElement.classList.add('active');
            } else {
                // Find the nav item by page name
                const navMap = {
                    'dashboard': 0,
                    'audits': 1,
                    'users': 2,
                    'settings': 3
                };
                const navItems = document.querySelectorAll('.nav-item');
                if (navMap[pageName] !== undefined && navItems[navMap[pageName]]) {
                    navItems[navMap[pageName]].classList.add('active');
                }
            }
            
            // Update header title
            const titles = {
                dashboard: 'Dashboard',
                newAudit: 'Neues Audit',
                questions: 'Audit durchfÃ¼hren',
                audits: 'Audit Liste',
                users: 'Benutzerverwaltung',
                settings: 'Einstellungen'
            };
            
            document.getElementById('pageTitle').textContent = titles[pageName] || 'WHS Safety Audit';
            
            // Load page data
            if (pageName === 'dashboard') {
                loadDashboard();
            } else if (pageName === 'audits') {
                loadAuditList();
            } else if (pageName === 'users') {
                loadUserList();
            }
        }

        // Dashboard
        async function loadDashboard() {
            // Always try to load from local storage first
            const localAudits = JSON.parse(localStorage.getItem('localAudits') || '[]');
            const today = new Date().toDateString();
            const todayAudits = localAudits.filter(a => new Date(a.date).toDateString() === today);
            
            // Set initial values from local data
            document.getElementById('todayAudits').textContent = todayAudits.length;
            document.getElementById('totalAudits').textContent = localAudits.length;
            
            if (localAudits.length > 0) {
                const avgScore = Math.round(localAudits.reduce((sum, a) => sum + (a.score || 0), 0) / localAudits.length);
                document.getElementById('avgScore').textContent = `${avgScore}%`;
                
                const criticalCount = localAudits.reduce((sum, a) => sum + (a.criticalFailures || 0), 0);
                document.getElementById('criticalCount').textContent = criticalCount;
            } else {
                document.getElementById('avgScore').textContent = '0%';
                document.getElementById('criticalCount').textContent = '0';
            }
            
            // Display local audits first
            displayRecentAudits(localAudits.slice(-5).reverse());
            
            // Then try to get fresh data from server if online
            if (isOnline) {
                try {
                    const response = await apiCall('/audits/stats', 'GET');
                    if (response.ok) {
                        const stats = await response.json();
                        
                        document.getElementById('todayAudits').textContent = stats.todayCount || 0;
                        document.getElementById('avgScore').textContent = `${stats.avgScore || 0}%`;
                        document.getElementById('criticalCount').textContent = stats.criticalCount || 0;
                        document.getElementById('totalAudits').textContent = stats.totalCount || 0;
                        
                        // Load recent audits from server
                        const auditsResponse = await apiCall('/audits?limit=5', 'GET');
                        if (auditsResponse.ok) {
                            const recentAudits = await auditsResponse.json();
                            displayRecentAudits(recentAudits);
                        }
                    }
                } catch (error) {
                    console.log('Failed to load from server, using local data:', error);
                }
            }
        }

        function displayRecentAudits(audits) {
            const container = document.getElementById('recentAudits');
            container.innerHTML = '';
            
            if (audits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="empty-state-title">Keine Audits vorhanden</h3>
                        <p class="empty-state-text">Starten Sie ein neues Audit, um loszulegen.</p>
                    </div>
                `;
                return;
            }
            
            audits.forEach(audit => {
                const scoreClass = audit.score >= 80 ? 'high' : audit.score >= 60 ? 'medium' : 'low';
                const item = document.createElement('div');
                item.className = 'audit-item';
                item.onclick = () => viewAudit(audit.id);
                
                item.innerHTML = `
                    <div class="audit-header">
                        <div>
                            <div class="audit-location">${audit.location} - ${audit.area || 'N/A'}</div>
                            <div class="audit-meta">
                                <div class="audit-meta-item">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>${new Date(audit.date).toLocaleDateString('de-AT')}</span>
                                </div>
                                <div class="audit-meta-item">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>${audit.shift}</span>
                                </div>
                                <div class="audit-meta-item">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span>${audit.auditor}</span>
                                </div>
                            </div>
                        </div>
                        <div class="audit-score ${scoreClass}">${audit.score || 0}%</div>
                    </div>
                    ${audit.criticalFailures > 0 ? `
                        <div class="alert alert-danger mt-2">
                            <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>${audit.criticalFailures} kritische MÃ¤ngel</span>
                        </div>
                    ` : ''}
                `;
                
                container.appendChild(item);
            });
        }

        // New Audit
        function startNewAudit() {
            showPage('newAudit', null);
        }

        async function handleAuditForm(e) {
            e.preventDefault();
            
            currentAudit = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                location: document.getElementById('location').value,
                area: document.getElementById('area').value,
                shift: document.getElementById('shift').value,
                auditor: currentUser.username,
                auditorName: currentUser.name,
                answers: {},
                comments: {},
                photos: {},
                status: 'in_progress'
            };
            
            displayQuestions();
            showPage('questions', null);
        }

        // Questions
        function displayQuestions() {
            const container = document.getElementById('questionContainer');
            container.innerHTML = '';
            
            Object.keys(auditQuestions).forEach(sectionKey => {
                const section = auditQuestions[sectionKey];
                
                // Section header
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `<h3 class="section-title">${sectionKey}. ${section.title}</h3>`;
                container.appendChild(sectionHeader);
                
                // Questions
                Object.keys(section.subsections).forEach(subsectionKey => {
                    if (subsectionKey) {
                        const subsectionTitle = document.createElement('h4');
                        subsectionTitle.style.padding = '0 1rem';
                        subsectionTitle.style.marginBottom = '1rem';
                        subsectionTitle.style.fontWeight = '600';
                        subsectionTitle.style.color = 'var(--secondary)';
                        subsectionTitle.textContent = subsectionKey;
                        container.appendChild(subsectionTitle);
                    }
                    
                    section.subsections[subsectionKey].forEach(question => {
                        const questionCard = document.createElement('div');
                        questionCard.className = `question-card ${question.critical ? 'critical' : ''}`;
                        questionCard.id = `question-${question.id}`;
                        
                        questionCard.innerHTML = `
                            <div class="question-header">
                                <span class="question-number">${question.id}</span>
                                ${question.critical ? '<span class="critical-badge">KRITISCH</span>' : ''}
                            </div>
                            <div class="question-text">${question.question}</div>
                            ${question.basis ? `<div class="basis-text">Rechtsgrundlage: ${question.basis}</div>` : ''}
                            <div class="answer-section">
                                <div class="answer-buttons">
                                    <button class="answer-btn" onclick="selectAnswer('${question.id}', 'YES', this)">JA</button>
                                    <button class="answer-btn no" onclick="selectAnswer('${question.id}', 'NO', this)">NEIN</button>
                                    <button class="answer-btn na" onclick="selectAnswer('${question.id}', 'NA', this)">N/A</button>
                                </div>
                                <button class="toggle-extras-btn" onclick="toggleExtras('${question.id}', this)">
                                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    Kommentar / Fotos hinzufÃ¼gen
                                </button>
                                <div class="comment-section" id="extras-${question.id}">
                                    <textarea 
                                        class="comment-textarea" 
                                        id="comment-${question.id}"
                                        placeholder="Kommentar hinzufÃ¼gen..."
                                        onchange="saveComment('${question.id}', this.value)"
                                    ></textarea>
                                    <div class="photo-section">
                                        <button class="add-photo-btn" onclick="addPhotos('${question.id}')">
                                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            </svg>
                                            Fotos hinzufÃ¼gen
                                        </button>
                                        <div class="photo-grid" id="photos-${question.id}"></div>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        container.appendChild(questionCard);
                    });
                });
            });
            
            updateProgress();
        }

        function selectAnswer(questionId, answer, button) {
            currentAudit.answers[questionId] = answer;
            
            // Update button styling
            const buttons = button.parentElement.querySelectorAll('.answer-btn');
            buttons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
            
            // Auto-open extras for NO answers
            if (answer === 'NO') {
                const extrasBtn = document.querySelector(`#question-${questionId} .toggle-extras-btn`);
                if (!extrasBtn.classList.contains('active')) {
                    toggleExtras(questionId, extrasBtn);
                }
            }
            
            updateProgress();
        }

        function toggleExtras(questionId, button) {
            const extrasSection = document.getElementById(`extras-${questionId}`);
            extrasSection.classList.toggle('active');
            button.classList.toggle('active');
        }

        function saveComment(questionId, comment) {
            if (comment.trim()) {
                currentAudit.comments[questionId] = comment;
            } else {
                delete currentAudit.comments[questionId];
            }
        }

        function addPhotos(questionId) {
            currentPhotoQuestionId = questionId;
            document.getElementById('photoInput').click();
        }

        let currentPhotoQuestionId = null;

        async function handlePhotoUpload(event) {
            const files = event.target.files;
            if (!files.length || !currentPhotoQuestionId) return;
            
            const photoGrid = document.getElementById(`photos-${currentPhotoQuestionId}`);
            
            if (!currentAudit.photos[currentPhotoQuestionId]) {
                currentAudit.photos[currentPhotoQuestionId] = [];
            }
            
            for (const file of files) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const photoData = e.target.result;
                    const photoId = await savePhoto(photoData);
                    
                    if (photoId) {
                        currentAudit.photos[currentPhotoQuestionId].push(photoId);
                        
                        const photoItem = document.createElement('div');
                        photoItem.className = 'photo-item';
                        photoItem.innerHTML = `
                            <img src="${photoData}" alt="Audit Photo" onclick="viewPhoto('${photoData}')">
                            <button class="photo-remove" onclick="removePhoto('${currentPhotoQuestionId}', '${photoId}', this)">Ã</button>
                        `;
                        photoGrid.appendChild(photoItem);
                    }
                };
                reader.readAsDataURL(file);
            }
            
            // Reset file input
            event.target.value = '';
        }

        function removePhoto(questionId, photoId, button) {
            if (confirm('Foto wirklich lÃ¶schen?')) {
                const photoIndex = currentAudit.photos[questionId].indexOf(photoId);
                if (photoIndex > -1) {
                    currentAudit.photos[questionId].splice(photoIndex, 1);
                }
                
                if (currentAudit.photos[questionId].length === 0) {
                    delete currentAudit.photos[questionId];
                }
                
                button.parentElement.remove();
            }
        }

        function viewPhoto(photoData) {
            showModal('Foto', `<img src="${photoData}" style="width: 100%; border-radius: 8px;">`, [
                { text: 'SchlieÃen', onclick: hideModal, class: 'btn-secondary' }
            ]);
        }

        function updateProgress() {
            const totalQuestions = 46;
            const answeredQuestions = Object.keys(currentAudit.answers).length;
            const percentage = Math.round((answeredQuestions / totalQuestions) * 100);
            
            document.getElementById('progressText').textContent = `${answeredQuestions} von ${totalQuestions} beantwortet`;
            document.getElementById('progressPercent').textContent = `${percentage}%`;
            document.getElementById('progressFill').style.width = `${percentage}%`;
        }

        async function completeAudit() {
            if (Object.keys(currentAudit.answers).length === 0) {
                showModal('Fehler', 'Bitte beantworten Sie mindestens eine Frage.');
                return;
            }
            
            // Calculate results
            let totalQuestions = 0;
            let passedQuestions = 0;
            let criticalFailures = 0;
            let findings = [];
            
            Object.values(auditQuestions).forEach(section => {
                Object.values(section.subsections).forEach(subsection => {
                    subsection.forEach(question => {
                        if (currentAudit.answers[question.id]) {
                            totalQuestions++;
                            if (currentAudit.answers[question.id] === 'YES') {
                                passedQuestions++;
                            } else if (currentAudit.answers[question.id] === 'NO') {
                                if (question.critical) {
                                    criticalFailures++;
                                }
                                findings.push({
                                    id: question.id,
                                    question: question.question,
                                    critical: question.critical,
                                    comment: currentAudit.comments[question.id] || '',
                                    photos: currentAudit.photos[question.id] || []
                                });
                            }
                        }
                    });
                });
            });
            
            currentAudit.score = Math.round((passedQuestions / totalQuestions) * 100);
            currentAudit.itemsPassed = passedQuestions;
            currentAudit.totalItems = totalQuestions;
            currentAudit.criticalFailures = criticalFailures;
            currentAudit.findings = findings;
            currentAudit.status = 'completed';
            currentAudit.completedAt = new Date().toISOString();
            currentAudit.overallCondition = currentAudit.score >= 80 ? 'Gut' : 'VerbesserungsbedÃ¼rftig';
            currentAudit.overallResult = criticalFailures === 0 ? 'Keine kritischen Beanstandungen' : `${criticalFailures} kritische MÃ¤ngel festgestellt`;
            
            // Save audit
            try {
                if (isOnline) {
                    await apiCall('/audits', 'POST', currentAudit);
                    showNotification('Audit erfolgreich gespeichert', 'success', 'Audit abgeschlossen');
                } else {
                    // Save locally if offline
                    const db = await initializeDatabase();
                    const tx = db.transaction('pending_audits', 'readwrite');
                    await tx.objectStore('pending_audits').add(currentAudit);
                    
                    const localAudits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                    localAudits.push(currentAudit);
                    localStorage.setItem('localAudits', JSON.stringify(localAudits));
                    localStorage.setItem('pendingSync', 'true');
                    updateSyncButtonStatus();
                    showNotification('Audit lokal gespeichert', 'info', 'Wird bei Verbindung synchronisiert');
                }
            } catch (error) {
                console.error('Failed to save audit:', error);
                // Save locally as fallback
                const localAudits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                localAudits.push(currentAudit);
                localStorage.setItem('localAudits', JSON.stringify(localAudits));
                localStorage.setItem('pendingSync', 'true');
                updateSyncButtonStatus();
                showNotification('Audit lokal gespeichert', 'info');
            }
            
            // Generate PDF
            generatePDF(currentAudit);
            
            // Add notification
            addNotification({
                id: Date.now().toString(),
                type: 'audit_completed',
                title: 'Audit abgeschlossen',
                message: `${currentAudit.location} - Score: ${currentAudit.score}%`,
                timestamp: new Date().toISOString(),
                read: false
            });
            
            currentAudit = null;
            showPage('dashboard', null);
        }

        function cancelAudit() {
            showModal(
                'Audit abbrechen?', 
                'MÃ¶chten Sie das Audit wirklich abbrechen? Alle Daten gehen verloren.',
                [
                    { text: 'Abbrechen', onclick: () => { currentAudit = null; showPage('dashboard', null); hideModal(); }, class: 'btn-danger' },
                    { text: 'Fortsetzen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        // Audit List
        async function loadAuditList() {
            const container = document.getElementById('auditList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p class="loading-text">Audits werden geladen...</p></div>';
            
            // First load from local storage
            const localAudits = JSON.parse(localStorage.getItem('localAudits') || '[]');
            displayAuditList(filterAuditsByType(localAudits));
            
            // Then try to get fresh data if online
            if (isOnline) {
                try {
                    const response = await apiCall('/audits', 'GET');
                    if (response.ok) {
                        const audits = await response.json();
                        displayAuditList(filterAuditsByType(audits));
                    }
                } catch (error) {
                    console.log('Failed to load audits from server, using local data:', error);
                }
            }
        }

        function filterAuditsByType(audits) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            switch (auditFilter) {
                case 'today':
                    return audits.filter(a => new Date(a.date) >= today);
                case 'week':
                    return audits.filter(a => new Date(a.date) >= weekStart);
                case 'month':
                    return audits.filter(a => new Date(a.date) >= monthStart);
                case 'critical':
                    return audits.filter(a => a.criticalFailures > 0);
                default:
                    return audits;
            }
        }

        function setAuditFilter(filter, button) {
            auditFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(chip => chip.classList.remove('active'));
            button.classList.add('active');
            loadAuditList();
        }

        function filterAudits(searchTerm) {
            const audits = document.querySelectorAll('.audit-item');
            const term = searchTerm.toLowerCase();
            
            audits.forEach(audit => {
                const text = audit.textContent.toLowerCase();
                audit.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        function displayAuditList(audits) {
            const container = document.getElementById('auditList');
            container.innerHTML = '';
            
            if (audits.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <h3 class="empty-state-title">Keine Audits gefunden</h3>
                        <p class="empty-state-text">Passen Sie Ihre Filter an oder starten Sie ein neues Audit.</p>
                    </div>
                `;
                return;
            }
            
            // Create a copy and reverse to avoid mutating the original array
            const sortedAudits = [...audits].reverse();
            sortedAudits.forEach(audit => {
                const scoreClass = audit.score >= 80 ? 'high' : audit.score >= 60 ? 'medium' : 'low';
                const item = document.createElement('div');
                item.className = 'audit-item';
                
                item.innerHTML = `
                    <div class="audit-header">
                        <div>
                            <div class="audit-location">${audit.location} - ${audit.area || 'N/A'}</div>
                            <div class="audit-meta">
                                <div class="audit-meta-item">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span>${new Date(audit.date).toLocaleDateString('de-AT')}</span>
                                </div>
                                <div class="audit-meta-item">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span>${audit.shift}</span>
                                </div>
                                <div class="audit-meta-item">
                                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                    </svg>
                                    <span>${audit.auditorName || audit.auditor}</span>
                                </div>
                            </div>
                        </div>
                        <div class="audit-score ${scoreClass}">${audit.score || 0}%</div>
                    </div>
                    ${audit.criticalFailures > 0 ? `
                        <div class="alert alert-danger mt-2">
                            <svg class="alert-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                            </svg>
                            <span>${audit.criticalFailures} kritische MÃ¤ngel</span>
                        </div>
                    ` : ''}
                    <div class="audit-actions">
                        <button class="btn btn-sm btn-primary" onclick="viewAudit('${audit.id}')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                            Details
                        </button>
                        <button class="btn btn-sm btn-secondary" onclick="downloadAuditPDF('${audit.id}')">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                            </svg>
                            PDF
                        </button>
                        ${currentUser.role === 'admin' ? `
                            <button class="btn btn-sm btn-danger" onclick="deleteAudit('${audit.id}')">
                                <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                LÃ¶schen
                            </button>
                        ` : ''}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }

        async function viewAudit(auditId) {
            try {
                let audit;
                if (isOnline) {
                    const response = await apiCall(`/audits/${auditId}`, 'GET');
                    audit = await response.json();
                } else {
                    const audits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                    audit = audits.find(a => a.id === auditId);
                }
                
                if (audit) {
                    showAuditDetails(audit);
                }
            } catch (error) {
                const audits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                const audit = audits.find(a => a.id === auditId);
                if (audit) {
                    showAuditDetails(audit);
                }
            }
        }

        async function showAuditDetails(audit) {
            const findings = audit.findings || [];
            const photosHtml = [];
            
            for (const finding of findings) {
                if (finding.photos && finding.photos.length > 0) {
                    for (const photoId of finding.photos) {
                        const photo = await getPhoto(photoId);
                        if (photo) {
                            photosHtml.push(`
                                <div class="photo-item">
                                    <img src="${photo.data}" alt="Finding Photo" onclick="viewPhoto('${photo.data}')">
                                    <p class="text-xs text-muted mt-1">Frage ${finding.id}</p>
                                </div>
                            `);
                        }
                    }
                }
            }
            
            const modalContent = `
                <div class="audit-details">
                    <div class="card">
                        <h4 class="card-title">Audit Information</h4>
                        <div class="audit-meta">
                            <div class="audit-meta-item">
                                <strong>Location:</strong> ${audit.location}
                            </div>
                            <div class="audit-meta-item">
                                <strong>Bereich:</strong> ${audit.area}
                            </div>
                            <div class="audit-meta-item">
                                <strong>Schicht:</strong> ${audit.shift}
                            </div>
                            <div class="audit-meta-item">
                                <strong>Datum:</strong> ${new Date(audit.date).toLocaleString('de-AT')}
                            </div>
                            <div class="audit-meta-item">
                                <strong>Auditor:</strong> ${audit.auditorName || audit.auditor}
                            </div>
                            <div class="audit-meta-item">
                                <strong>Status:</strong> ${audit.status === 'completed' ? 'Abgeschlossen' : 'In Bearbeitung'}
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h4 class="card-title">Ergebnis</h4>
                        <div class="stats-grid" style="margin: 0;">
                            <div class="stat-card">
                                <div class="stat-value">${audit.score}%</div>
                                <div class="stat-label">Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${audit.itemsPassed}/${audit.totalItems}</div>
                                <div class="stat-label">Bestanden</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${audit.criticalFailures}</div>
                                <div class="stat-label">Kritisch</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${findings.length}</div>
                                <div class="stat-label">MÃ¤ngel</div>
                            </div>
                        </div>
                    </div>
                    
                    ${findings.length > 0 ? `
                        <div class="card">
                            <h4 class="card-title">Festgestellte MÃ¤ngel</h4>
                            ${findings.map(finding => `
                                <div class="alert ${finding.critical ? 'alert-danger' : 'alert-info'} mb-2">
                                    <div>
                                        <strong>${finding.id}:</strong> ${finding.question}
                                        ${finding.critical ? '<span class="critical-badge ml-2">KRITISCH</span>' : ''}
                                    </div>
                                    ${finding.comment ? `<p class="mt-1 text-small">${finding.comment}</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${photosHtml.length > 0 ? `
                        <div class="card">
                            <h4 class="card-title">Fotos</h4>
                            <div class="photo-grid">
                                ${photosHtml.join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            showModal(
                `Audit Details - ${audit.location}`,
                modalContent,
                [
                    { text: 'PDF herunterladen', onclick: () => { generatePDF(audit); hideModal(); }, class: 'btn-primary' },
                    { text: 'SchlieÃen', onclick: hideModal, class: 'btn-secondary' }
                ],
                `Score: ${audit.score}%`
            );
        }

        async function deleteAudit(auditId) {
            showModal(
                'Audit lÃ¶schen?',
                'MÃ¶chten Sie dieses Audit wirklich lÃ¶schen? Diese Aktion kann nicht rÃ¼ckgÃ¤ngig gemacht werden.',
                [
                    { 
                        text: 'LÃ¶schen', 
                        onclick: async () => {
                            try {
                                if (isOnline) {
                                    await apiCall(`/audits/${auditId}`, 'DELETE');
                                }
                                
                                // Remove from local storage
                                const localAudits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                                const filtered = localAudits.filter(a => a.id !== auditId);
                                localStorage.setItem('localAudits', JSON.stringify(filtered));
                                
                                hideModal();
                                loadAuditList();
                                showNotification('Audit gelÃ¶scht', 'success');
                            } catch (error) {
                                showNotification('Fehler beim LÃ¶schen', 'error');
                            }
                        }, 
                        class: 'btn-danger' 
                    },
                    { text: 'Abbrechen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        async function downloadAuditPDF(auditId) {
            try {
                let audit;
                if (isOnline) {
                    const response = await apiCall(`/audits/${auditId}`, 'GET');
                    audit = await response.json();
                } else {
                    const audits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                    audit = audits.find(a => a.id === auditId);
                }
                
                if (audit) {
                    generatePDF(audit);
                }
            } catch (error) {
                const audits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                const audit = audits.find(a => a.id === auditId);
                if (audit) {
                    generatePDF(audit);
                }
            }
        }

        async function massDownloadAudits() {
            showModal(
                'Audits herunterladen',
                'WÃ¤hlen Sie das Format fÃ¼r den Download:',
                [
                    { 
                        text: 'Einzelne PDFs (ZIP)', 
                        onclick: async () => {
                            hideModal();
                            await downloadAuditsAsZip();
                        }, 
                        class: 'btn-primary' 
                    },
                    { 
                        text: 'Excel-Datei', 
                        onclick: async () => {
                            hideModal();
                            await downloadAuditsAsExcel();
                        }, 
                        class: 'btn-primary' 
                    },
                    { text: 'Abbrechen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        async function downloadAuditsAsZip() {
            try {
                showNotification('ZIP wird erstellt...', 'info');
                
                let audits;
                if (isOnline) {
                    const response = await apiCall('/audits', 'GET');
                    audits = await response.json();
                } else {
                    audits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                }
                
                const zip = new JSZip();
                const { jsPDF } = window.jspdf;
                
                for (const audit of audits) {
                    const doc = new jsPDF();
                    await generatePDFContent(doc, audit);
                    const pdfBlob = doc.output('blob');
                    const filename = `audit_${audit.location}_${audit.area}_${new Date(audit.date).toISOString().split('T')[0]}.pdf`;
                    zip.file(filename, pdfBlob);
                }
                
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(zipBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audits_${new Date().toISOString().split('T')[0]}.zip`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('Download abgeschlossen', 'success');
            } catch (error) {
                console.error('Failed to create ZIP:', error);
                showNotification('Fehler beim Erstellen der ZIP-Datei', 'error');
            }
        }

        async function downloadAuditsAsExcel() {
            try {
                const response = await apiCall('/audits/export', 'GET');
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audits_export_${new Date().toISOString().split('T')[0]}.xlsx`;
                a.click();
                URL.revokeObjectURL(url);
                showNotification('Excel-Export erfolgreich', 'success');
            } catch (error) {
                showNotification('Excel-Export nicht verfÃ¼gbar im Offline-Modus', 'error');
            }
        }

        // PDF Generation
        async function generatePDF(audit) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            await generatePDFContent(doc, audit);
            doc.save(`audit_${audit.location}_${new Date(audit.date).toISOString().split('T')[0]}.pdf`);
            showNotification('PDF wurde erstellt', 'success');
        }

        async function generatePDFContent(doc, audit) {
            let yPos = 20;
            
            // Header with Amazon logo
            doc.setFillColor(255, 153, 0);
            doc.rect(0, 0, 210, 40, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(24);
            doc.text('AMAZON AUSTRIA', 20, 20);
            doc.setFontSize(16);
            doc.text('Workplace Health & Safety', 20, 30);
            doc.setFontSize(20);
            doc.text('SAFETY AUDIT REPORT', 20, 38);
            
            // Reset text color
            doc.setTextColor(0, 0, 0);
            yPos = 50;
            
            // Audit Information Box
            doc.setFillColor(245, 245, 245);
            doc.rect(15, yPos, 180, 45, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('AUDIT INFORMATION', 20, yPos + 10);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Date/Time: ${new Date(audit.date).toLocaleString('de-AT')}`, 20, yPos + 20);
            doc.text(`Location: ${audit.location}`, 20, yPos + 25);
            doc.text(`Area: ${audit.area}`, 20, yPos + 30);
            doc.text(`Shift: ${audit.shift}`, 100, yPos + 20);
            doc.text(`Auditor: ${audit.auditorName || audit.auditor}`, 100, yPos + 25);
            doc.text(`Status: ${audit.status === 'completed' ? 'Abgeschlossen' : 'In Bearbeitung'}`, 100, yPos + 30);
            
            yPos += 55;
            
            // Score Summary
            doc.setFillColor(255, 153, 0, 0.1);
            doc.rect(15, yPos, 180, 35, 'F');
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('AUDIT SCORE SUMMARY', 20, yPos + 10);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            
            // Score visualization
            const scoreColor = audit.score >= 80 ? [0, 217, 126] : audit.score >= 60 ? [255, 193, 7] : [220, 53, 69];
            doc.setFillColor(...scoreColor);
            doc.rect(20, yPos + 15, (audit.score / 100) * 50, 10, 'F');
            doc.setFillColor(240, 240, 240);
            doc.rect(20 + (audit.score / 100) * 50, yPos + 15, 50 - (audit.score / 100) * 50, 10, 'F');
            doc.text(`Overall Score: ${audit.score}%`, 75, yPos + 22);
            
            doc.text(`Items Passed: ${audit.itemsPassed}/${audit.totalItems}`, 130, yPos + 20);
            doc.text(`Critical Failures: ${audit.criticalFailures}`, 130, yPos + 25);
            
            yPos += 45;
            
            // Overall Assessment
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('OVERALL ASSESSMENT', 20, yPos);
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Workplace Condition: ${audit.overallCondition || 'N/A'}`, 20, yPos + 10);
            doc.text(`Overall Result: ${audit.overallResult || 'N/A'}`, 20, yPos + 15);
            
            yPos += 25;
            
            // Findings
            if (audit.findings && audit.findings.length > 0) {
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('FINDINGS', 20, yPos);
                yPos += 10;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                
                for (const finding of audit.findings) {
                    if (yPos > 250) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    // Finding box
                    const boxColor = finding.critical ? [220, 53, 69] : [23, 162, 184];
                    doc.setDrawColor(...boxColor);
                    doc.setLineWidth(0.5);
                    doc.rect(15, yPos, 180, 20, 'S');
                    
                    if (finding.critical) {
                        doc.setFillColor(220, 53, 69);
                        doc.setTextColor(255, 255, 255);
                        doc.rect(15, yPos, 25, 6, 'F');
                        doc.text('KRITISCH', 17, yPos + 4.5);
                        doc.setTextColor(0, 0, 0);
                    }
                    
                    doc.text(`${finding.id}: ${finding.question}`, 20, yPos + 10);
                    if (finding.comment) {
                        doc.setFont(undefined, 'italic');
                        const lines = doc.splitTextToSize(`Kommentar: ${finding.comment}`, 170);
                        doc.text(lines, 20, yPos + 15);
                        doc.setFont(undefined, 'normal');
                        yPos += lines.length * 5;
                    }
                    
                    yPos += 25;
                }
            }
            
            // Photos (if any)
            if (audit.findings) {
                const photosToInclude = [];
                for (const finding of audit.findings) {
                    if (finding.photos && finding.photos.length > 0) {
                        for (const photoId of finding.photos) {
                            const photo = await getPhoto(photoId);
                            if (photo) {
                                photosToInclude.push({ questionId: finding.id, data: photo.data });
                            }
                        }
                    }
                }
                
                if (photosToInclude.length > 0) {
                    doc.addPage();
                    yPos = 20;
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('PHOTO DOCUMENTATION', 20, yPos);
                    yPos += 15;
                    
                    for (const photo of photosToInclude) {
                        if (yPos > 200) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'normal');
                        doc.text(`Question ${photo.questionId}:`, 20, yPos);
                        yPos += 5;
                        
                        try {
                            doc.addImage(photo.data, 'JPEG', 20, yPos, 80, 60);
                            yPos += 70;
                        } catch (error) {
                            console.error('Failed to add image to PDF:', error);
                            yPos += 10;
                        }
                    }
                }
            }
            
            // Footer on last page
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });
                doc.text(`Generated on ${new Date().toLocaleString('de-AT')}`, 20, 290);
                doc.text('Â© Amazon Austria WHS', 190, 290, { align: 'right' });
            }
        }

        // User Management
        async function loadUsers() {
            try {
                if (isOnline) {
                    const response = await apiCall('/users', 'GET');
                    if (response.ok) {
                        users = await response.json();
                    } else {
                        // Use demo users
                        users = [
                            { id: '1', username: 'admin@amazon.at', name: 'Admin User', role: 'admin' },
                            { id: '2', username: 'safety@amazon.at', name: 'Safety Officer', role: 'auditor' },
                            { id: '3', username: 'manager@amazon.at', name: 'Area Manager', role: 'viewer' }
                        ];
                    }
                } else {
                    // Load from IndexedDB
                    const db = await initializeDatabase();
                    const tx = db.transaction('users', 'readonly');
                    const store = tx.objectStore('users');
                    const localUsers = await store.getAll();
                    users = localUsers.length > 0 ? localUsers : [
                        { id: '1', username: 'admin@amazon.at', name: 'Admin User', role: 'admin' },
                        { id: '2', username: 'safety@amazon.at', name: 'Safety Officer', role: 'auditor' },
                        { id: '3', username: 'manager@amazon.at', name: 'Area Manager', role: 'viewer' }
                    ];
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                users = [
                    { id: '1', username: 'admin@amazon.at', name: 'Admin User', role: 'admin' },
                    { id: '2', username: 'safety@amazon.at', name: 'Safety Officer', role: 'auditor' },
                    { id: '3', username: 'manager@amazon.at', name: 'Area Manager', role: 'viewer' }
                ];
            }
        }

        async function loadUserList() {
            await loadUsers();
            displayUserList();
        }

        function displayUserList() {
            const container = document.getElementById('userList');
            container.innerHTML = '';
            
            if (users.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-state-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                        </svg>
                        <h3 class="empty-state-title">Keine Benutzer vorhanden</h3>
                        <p class="empty-state-text">FÃ¼gen Sie Benutzer hinzu, um loszulegen.</p>
                    </div>
                `;
                return;
            }
            
            users.forEach(user => {
                const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                const item = document.createElement('div');
                item.className = 'user-item';
                
                item.innerHTML = `
                    <div class="user-avatar">${initials}</div>
                    <div class="user-info">
                        <div class="user-name">${user.name}</div>
                        <div class="user-email">${user.username}</div>
                    </div>
                    <span class="user-role ${user.role}">${user.role.charAt(0).toUpperCase() + user.role.slice(1)}</span>
                    ${currentUser.role === 'admin' && user.id !== currentUser.id ? `
                        <button class="icon-btn" onclick="editUser('${user.id}')" title="Bearbeiten">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                    ` : ''}
                `;
                
                container.appendChild(item);
            });
        }

        function showAddUserModal() {
            if (currentUser.role !== 'admin') {
                showNotification('Keine Berechtigung', 'error');
                return;
            }
            
            const modalContent = `
                <form id="addUserForm">
                    <div class="form-group">
                        <label class="form-label" for="newUserName">Name</label>
                        <input type="text" id="newUserName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newUserEmail">Email</label>
                        <input type="email" id="newUserEmail" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newUserPassword">Passwort</label>
                        <input type="password" id="newUserPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newUserRole">Rolle</label>
                        <select id="newUserRole" class="form-control" required>
                            <option value="viewer">Viewer - Nur Ansicht</option>
                            <option value="auditor">Auditor - Audits durchfÃ¼hren</option>
                            <option value="admin">Admin - Vollzugriff</option>
                        </select>
                    </div>
                </form>
            `;
            
            showModal(
                'Benutzer hinzufÃ¼gen',
                modalContent,
                [
                    { 
                        text: 'HinzufÃ¼gen', 
                        onclick: async () => {
                            const name = document.getElementById('newUserName').value;
                            const email = document.getElementById('newUserEmail').value;
                            const password = document.getElementById('newUserPassword').value;
                            const role = document.getElementById('newUserRole').value;
                            
                            if (name && email && password && role) {
                                await addUser({ name, username: email, password, role });
                                hideModal();
                            }
                        }, 
                        class: 'btn-primary' 
                    },
                    { text: 'Abbrechen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        async function addUser(userData) {
            try {
                if (isOnline) {
                    const response = await apiCall('/users', 'POST', userData);
                    if (response.ok) {
                        showNotification('Benutzer hinzugefÃ¼gt', 'success');
                        loadUserList();
                    } else {
                        showNotification('Fehler beim HinzufÃ¼gen', 'error');
                    }
                } else {
                    // Save to IndexedDB for offline
                    const newUser = {
                        id: Date.now().toString(),
                        ...userData,
                        createdAt: new Date().toISOString()
                    };
                    
                    const db = await initializeDatabase();
                    const tx = db.transaction('users', 'readwrite');
                    await tx.objectStore('users').add(newUser);
                    
                    users.push(newUser);
                    showNotification('Benutzer lokal hinzugefÃ¼gt', 'info');
                    displayUserList();
                }
            } catch (error) {
                console.error('Failed to add user:', error);
                showNotification('Fehler beim HinzufÃ¼gen', 'error');
            }
        }

        function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const modalContent = `
                <form id="editUserForm">
                    <div class="form-group">
                        <label class="form-label" for="editUserName">Name</label>
                        <input type="text" id="editUserName" class="form-control" value="${user.name}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editUserEmail">Email</label>
                        <input type="email" id="editUserEmail" class="form-control" value="${user.username}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editUserRole">Rolle</label>
                        <select id="editUserRole" class="form-control" required>
                            <option value="viewer" ${user.role === 'viewer' ? 'selected' : ''}>Viewer - Nur Ansicht</option>
                            <option value="auditor" ${user.role === 'auditor' ? 'selected' : ''}>Auditor - Audits durchfÃ¼hren</option>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin - Vollzugriff</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="editUserPassword">Neues Passwort (optional)</label>
                        <input type="password" id="editUserPassword" class="form-control" placeholder="Leer lassen fÃ¼r keine Ãnderung">
                    </div>
                </form>
            `;
            
            showModal(
                'Benutzer bearbeiten',
                modalContent,
                [
                    { 
                        text: 'Speichern', 
                        onclick: async () => {
                            const name = document.getElementById('editUserName').value;
                            const email = document.getElementById('editUserEmail').value;
                            const role = document.getElementById('editUserRole').value;
                            const password = document.getElementById('editUserPassword').value;
                            
                            const updatedData = { name, username: email, role };
                            if (password) updatedData.password = password;
                            
                            await updateUser(userId, updatedData);
                            hideModal();
                        }, 
                        class: 'btn-primary' 
                    },
                    { 
                        text: 'LÃ¶schen', 
                        onclick: () => {
                            hideModal();
                            deleteUser(userId);
                        }, 
                        class: 'btn-danger' 
                    },
                    { text: 'Abbrechen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        async function updateUser(userId, userData) {
            try {
                if (isOnline) {
                    const response = await apiCall(`/users/${userId}`, 'PUT', userData);
                    if (response.ok) {
                        showNotification('Benutzer aktualisiert', 'success');
                        loadUserList();
                    }
                } else {
                    // Update in local array
                    const userIndex = users.findIndex(u => u.id === userId);
                    if (userIndex !== -1) {
                        users[userIndex] = { ...users[userIndex], ...userData };
                        displayUserList();
                        showNotification('Benutzer lokal aktualisiert', 'info');
                    }
                }
            } catch (error) {
                showNotification('Fehler beim Aktualisieren', 'error');
            }
        }

        async function deleteUser(userId) {
            showModal(
                'Benutzer lÃ¶schen?',
                'MÃ¶chten Sie diesen Benutzer wirklich lÃ¶schen?',
                [
                    { 
                        text: 'LÃ¶schen', 
                        onclick: async () => {
                            try {
                                if (isOnline) {
                                    await apiCall(`/users/${userId}`, 'DELETE');
                                }
                                users = users.filter(u => u.id !== userId);
                                hideModal();
                                displayUserList();
                                showNotification('Benutzer gelÃ¶scht', 'success');
                            } catch (error) {
                                showNotification('Fehler beim LÃ¶schen', 'error');
                            }
                        }, 
                        class: 'btn-danger' 
                    },
                    { text: 'Abbrechen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        // Settings Functions
        function changePassword() {
            const modalContent = `
                <form id="changePasswordForm">
                    <div class="form-group">
                        <label class="form-label" for="currentPassword">Aktuelles Passwort</label>
                        <input type="password" id="currentPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="newPassword">Neues Passwort</label>
                        <input type="password" id="newPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Passwort bestÃ¤tigen</label>
                        <input type="password" id="confirmPassword" class="form-control" required>
                    </div>
                </form>
            `;
            
            showModal(
                'Passwort Ã¤ndern',
                modalContent,
                [
                    { 
                        text: 'Ãndern', 
                        onclick: async () => {
                            const currentPassword = document.getElementById('currentPassword').value;
                            const newPassword = document.getElementById('newPassword').value;
                            const confirmPassword = document.getElementById('confirmPassword').value;
                            
                            if (newPassword !== confirmPassword) {
                                showNotification('PasswÃ¶rter stimmen nicht Ã¼berein', 'error');
                                return;
                            }
                            
                            // In real app, verify current password and update
                            showNotification('Passwort geÃ¤ndert', 'success');
                            hideModal();
                        }, 
                        class: 'btn-primary' 
                    },
                    { text: 'Abbrechen', onclick: hideModal, class: 'btn-secondary' }
                ]
            );
        }

        function toggleNotifications() {
            const enabled = document.getElementById('notificationsEnabled').checked;
            localStorage.setItem('notificationsEnabled', enabled);
            
            if (enabled && 'Notification' in window) {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        showNotification('Benachrichtigungen aktiviert', 'success');
                    }
                });
            }
        }

        // Notifications
        function addNotification(notification) {
            notifications.unshift(notification);
            updateNotificationBadge();
            
            // Show push notification if enabled
            const enabled = localStorage.getItem('notificationsEnabled') !== 'false';
            if (enabled && 'Notification' in window && Notification.permission === 'granted') {
                new Notification(notification.title, {
                    body: notification.message,
                    icon: '/icon-192.svg',
                    badge: '/icon-192.svg'
                });
            }
        }

        function updateNotificationBadge() {
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        function showNotifications() {
            const notificationsList = notifications.map(n => `
                <div class="notification-item ${n.read ? 'read' : ''}" onclick="markNotificationRead('${n.id}')">
                    <div class="notification-icon">
                        <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            ${n.type === 'audit_completed' ? 
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>' :
                                '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                            }
                        </svg>
                    </div>
                    <div class="notification-content">
                        <div class="notification-title">${n.title}</div>
                        <div class="notification-message">${n.message}</div>
                        <div class="notification-time">${formatRelativeTime(n.timestamp)}</div>
                    </div>
                </div>
            `).join('');
            
            showActionSheet(
                'Benachrichtigungen',
                notificationsList || '<p class="text-center text-muted">Keine Benachrichtigungen</p>'
            );
        }

        function markNotificationRead(notificationId) {
            const notification = notifications.find(n => n.id === notificationId);
            if (notification) {
                notification.read = true;
                updateNotificationBadge();
            }
        }

        function formatRelativeTime(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Gerade eben';
            if (diffMins < 60) return `vor ${diffMins} Minute${diffMins > 1 ? 'n' : ''}`;
            if (diffHours < 24) return `vor ${diffHours} Stunde${diffHours > 1 ? 'n' : ''}`;
            return `vor ${diffDays} Tag${diffDays > 1 ? 'en' : ''}`;
        }

        // Data Sync
        async function syncData() {
            if (!isOnline) {
                showNotification('Keine Internetverbindung', 'error');
                return;
            }
            
            showNotification('Synchronisiere Daten...', 'info');
            
            try {
                // Sync pending audits
                const db = await initializeDatabase();
                const tx = db.transaction('pending_audits', 'readwrite');
                const store = tx.objectStore('pending_audits');
                const pendingAudits = await store.getAll();
                
                let syncCount = 0;
                if (pendingAudits && pendingAudits.length > 0) {
                    for (const audit of pendingAudits) {
                        try {
                            await apiCall('/audits', 'POST', audit);
                            await store.delete(audit.id);
                            syncCount++;
                        } catch (error) {
                            console.error('Failed to sync audit:', audit.id);
                        }
                    }
                }
                
                if (syncCount > 0) {
                    localStorage.removeItem('pendingSync');
                    updateSyncButtonStatus();
                    showNotification(`${syncCount} Audits synchronisiert`, 'success');
                    loadDashboard();
                } else {
                    showNotification('Keine ausstehenden Daten', 'info');
                }
                
                // Sync users if admin
                if (currentUser.role === 'admin') {
                    const userTx = db.transaction('users', 'readonly');
                    const userStore = userTx.objectStore('users');
                    const localUsers = await userStore.getAll();
                    
                    for (const user of localUsers) {
                        if (user.createdAt && !user.synced) {
                            try {
                                await apiCall('/users', 'POST', user);
                                user.synced = true;
                            } catch (error) {
                                console.error('Failed to sync user:', user.id);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Sync error:', error);
                showNotification('Synchronisation fehlgeschlagen', 'error');
            }
        }

        // Export Functions
        function exportQuestions() {
            const blob = new Blob([JSON.stringify(auditQuestions, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'audit_questions.json';
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Fragen exportiert', 'success');
        }

        function importQuestions(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const questions = JSON.parse(e.target.result);
                    // Validate and save questions
                    showNotification('Fragen erfolgreich importiert', 'success');
                    document.getElementById('importMessage').innerHTML = '<p class="alert alert-success">Import erfolgreich!</p>';
                } catch (error) {
                    showError('Fehler beim Importieren der Datei');
                    document.getElementById('importMessage').innerHTML = '<p class="alert alert-danger">Import fehlgeschlagen!</p>';
                }
            };
            reader.readAsText(file);
        }

        async function exportAllAudits() {
            try {
                if (isOnline) {
                    const response = await apiCall('/audits/export', 'GET');
                    const data = await response.json();
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audits_export_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('Export erfolgreich', 'success');
                } else {
                    // Export local data
                    const localAudits = JSON.parse(localStorage.getItem('localAudits') || '[]');
                    const exportData = {
                        exportDate: new Date().toISOString(),
                        exportedBy: currentUser.username,
                        auditCount: localAudits.length,
                        audits: localAudits
                    };
                    
                    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `audits_export_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                    showNotification('Export erfolgreich', 'success');
                }
            } catch (error) {
                showError('Export fehlgeschlagen');
            }
        }

        // API Helper
        async function apiCall(endpoint, method = 'GET', body = null) {
            const token = localStorage.getItem('authToken');
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(API_BASE + endpoint, options);
                
                if (!response.ok && response.status === 401) {
                    // Only logout if this is the auth verification endpoint
                    if (endpoint === '/auth') {
                        logout();
                        throw new Error('Unauthorized');
                    }
                    // For other endpoints, just throw error without logging out
                    throw new Error('Unauthorized request');
                }
                
                return response;
            } catch (error) {
                // If offline, throw error but don't logout
                if (!isOnline) {
                    throw new Error('Offline mode');
                }
                throw error;
            }
        }

        // UI Helpers
        function showModal(title, content, actions = [], subtitle = '') {
            const modal = document.getElementById('modal');
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalSubtitle').textContent = subtitle;
            document.getElementById('modalBody').innerHTML = content;
            
            const actionsContainer = document.getElementById('modalActions');
            actionsContainer.innerHTML = '';
            
            if (actions.length === 0) {
                actions = [{ text: 'OK', onclick: () => hideModal() }];
            }
            
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = `btn ${action.class || 'btn-primary'}`;
                button.textContent = action.text;
                button.onclick = action.onclick;
                actionsContainer.appendChild(button);
            });
            
            modal.classList.add('active');
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('active');
        }

        function showActionSheet(title, content) {
            const sheet = document.getElementById('actionSheet');
            document.getElementById('actionSheetTitle').textContent = title;
            document.getElementById('actionSheetOptions').innerHTML = content;
            sheet.classList.add('active');
            
            // Add backdrop click listener
            setTimeout(() => {
                const backdrop = (e) => {
                    if (e.target === sheet) {
                        hideActionSheet();
                        sheet.removeEventListener('click', backdrop);
                    }
                };
                sheet.addEventListener('click', backdrop);
            }, 100);
        }

        function hideActionSheet() {
            document.getElementById('actionSheet').classList.remove('active');
        }

        function showNotification(message, type = 'success', title = '') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                success: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>',
                error: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>',
                info: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
            };
            
            toast.innerHTML = `
                <svg class="toast-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    ${iconMap[type]}
                </svg>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
            `;
            
            const container = document.getElementById('toastContainer');
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Remove after 4 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.classList.remove('hidden');
                setTimeout(() => errorDiv.classList.add('hidden'), 5000);
            } else {
                showModal('Fehler', message);
            }
        }

        function showUserMenu() {
            const options = `
                <div class="action-sheet-option" onclick="changePassword(); hideActionSheet();">
                    <svg class="action-sheet-option-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    <span class="action-sheet-option-text">Passwort Ã¤ndern</span>
                </div>
                <div class="action-sheet-option" onclick="syncData(); hideActionSheet();">
                    <svg class="action-sheet-option-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    <span class="action-sheet-option-text">Daten synchronisieren</span>
                </div>
                <div class="action-sheet-option" onclick="showPage('settings', null); hideActionSheet();">
                    <svg class="action-sheet-option-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <span class="action-sheet-option-text">Einstellungen</span>
                </div>
                <div class="action-sheet-option" onclick="logout(); hideActionSheet();" style="color: var(--danger);">
                    <svg class="action-sheet-option-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    <span class="action-sheet-option-text">Abmelden</span>
                </div>
            `;
            
            showActionSheet(currentUser.name, options);
        }

        // PWA Installation
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button if not already installed
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                setTimeout(() => {
                    showModal(
                        'App installieren',
                        'Installieren Sie die WHS Safety Audit App auf Ihrem GerÃ¤t fÃ¼r eine bessere Erfahrung und Offline-FunktionalitÃ¤t.',
                        [
                            { 
                                text: 'Installieren', 
                                onclick: () => {
                                    hideModal();
                                    installPWA();
                                }, 
                                class: 'btn-primary' 
                            },
                            { text: 'SpÃ¤ter', onclick: hideModal, class: 'btn-secondary' }
                        ]
                    );
                }, 5000); // Show after 5 seconds
            }
        });

        async function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                
                if (outcome === 'accepted') {
                    showNotification('App wurde installiert!', 'success');
                }
                
                deferredPrompt = null;
            }
        }

        // Handle app installed
        window.addEventListener('appinstalled', (evt) => {
            console.log('App installed successfully');
            showNotification('App erfolgreich installiert!', 'success');
        });

        // Check for pending sync on load
        window.addEventListener('load', () => {
            if (localStorage.getItem('pendingSync') === 'true' && isOnline) {
                syncData();
            }
        });

        // Periodic sync check
        setInterval(() => {
            if (localStorage.getItem('pendingSync') === 'true' && isOnline) {
                syncData();
            }
        }, 60000); // Check every minute

        // Add keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + N: New Audit
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                if (document.getElementById('dashboardPage').classList.contains('hidden') === false) {
                    startNewAudit();
                }
            }
            
            // Ctrl/Cmd + S: Save/Sync
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                syncData();
            }
            
            // Escape: Close modals
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal');
                const actionSheet = document.getElementById('actionSheet');
                
                if (modal.classList.contains('active')) {
                    hideModal();
                } else if (actionSheet.classList.contains('active')) {
                    hideActionSheet();
                }
            }
        });

        // Handle print functionality
        window.addEventListener('beforeprint', () => {
            document.body.classList.add('printing');
        });

        window.addEventListener('afterprint', () => {
            document.body.classList.remove('printing');
        });

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Application error:', e.error);
            // Don't show notification for every error to avoid annoying the user
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('Unhandled promise rejection:', e.reason);
            // Don't show notification for every rejection
        });

        // Initialize demo data for first time users
        function initializeDemoData() {
            if (!localStorage.getItem('demoInitialized')) {
                const demoAudits = [
                    {
                        id: '1',
                        date: new Date(Date.now() - 86400000).toISOString(), // Yesterday
                        location: 'DVI1',
                        area: 'Versand',
                        shift: 'FrÃ¼hschicht',
                        auditor: 'safety@amazon.at',
                        auditorName: 'Safety Officer',
                        score: 92,
                        itemsPassed: 42,
                        totalItems: 46,
                        criticalFailures: 0,
                        status: 'completed',
                        overallCondition: 'Gut',
                        overallResult: 'Keine kritischen Beanstandungen',
                        findings: []
                    },
                    {
                        id: '2',
                        date: new Date(Date.now() - 172800000).toISOString(), // 2 days ago
                        location: 'DVI2',
                        area: 'Lager',
                        shift: 'SpÃ¤tschicht',
                        auditor: 'admin@amazon.at',
                        auditorName: 'Admin User',
                        score: 78,
                        itemsPassed: 36,
                        totalItems: 46,
                        criticalFailures: 2,
                        status: 'completed',
                        overallCondition: 'VerbesserungsbedÃ¼rftig',
                        overallResult: '2 kritische MÃ¤ngel festgestellt',
                        findings: [
                            {
                                id: '1.2',
                                question: 'Sind alle NotausgÃ¤nge frei und gut gekennzeichnet?',
                                critical: true,
                                comment: 'Notausgang B3 war durch Paletten blockiert'
                            },
                            {
                                id: '3.7',
                                question: 'Sind alle Transportwege frei von Hindernissen?',
                                critical: true,
                                comment: 'Mehrere Kartons im Haupttransportweg'
                            }
                        ]
                    }
                ];
                
                localStorage.setItem('localAudits', JSON.stringify(demoAudits));
                localStorage.setItem('demoInitialized', 'true');
                
                // Add demo notifications
                addNotification({
                    id: '1',
                    type: 'info',
                    title: 'Willkommen!',
                    message: 'Demo-Daten wurden geladen',
                    timestamp: new Date().toISOString(),
                    read: false
                });
            }
        }

        // Call demo initialization
        initializeDemoData();

        // Cleanup function for old data
        function cleanupOldData() {
            const maxAge = 90 * 24 * 60 * 60 * 1000; // 90 days
            const now = Date.now();
            
            // Clean old audits
            const audits = JSON.parse(localStorage.getItem('localAudits') || '[]');
            const recentAudits = audits.filter(audit => {
                const auditDate = new Date(audit.date).getTime();
                return (now - auditDate) < maxAge;
            });
            
            if (recentAudits.length < audits.length) {
                localStorage.setItem('localAudits', JSON.stringify(recentAudits));
                console.log(`Cleaned up ${audits.length - recentAudits.length} old audits`);
            }
            
            // Clean old photos from IndexedDB
            cleanupOldPhotos();
        }

        async function cleanupOldPhotos() {
            try {
                const db = await initializeDatabase();
                const tx = db.transaction('photos', 'readwrite');
                const store = tx.objectStore('photos');
                const photos = await store.getAll();
                
                if (!photos || photos.length === 0) return;
                
                const maxAge = 90 * 24 * 60 * 60 * 1000; // 90 days
                const now = Date.now();
                let deletedCount = 0;
                
                for (const photo of photos) {
                    const photoDate = new Date(photo.timestamp).getTime();
                    if ((now - photoDate) > maxAge) {
                        await store.delete(photo.id);
                        deletedCount++;
                    }
                }
                
                if (deletedCount > 0) {
                    console.log(`Cleaned up ${deletedCount} old photos`);
                }
            } catch (error) {
                console.error('Error cleaning up photos:', error);
            }
        }

        // Run cleanup on startup
        setTimeout(cleanupOldData, 5000);

        // Version check and update notification
        const APP_VERSION = '2.0.0';
        const LAST_VERSION_KEY = 'lastAppVersion';

        function checkForUpdates() {
            const lastVersion = localStorage.getItem(LAST_VERSION_KEY);
            
            if (lastVersion !== APP_VERSION) {
                showModal(
                    'App aktualisiert!',
                    `
                        <h4>Version ${APP_VERSION} - Neue Funktionen:</h4>
                        <ul style="text-align: left; padding-left: 20px;">
                            <li>Verbesserte Offline-FunktionalitÃ¤t</li>
                            <li>Foto-Dokumentation fÃ¼r MÃ¤ngel</li>
                            <li>Erweiterte PDF-Reports</li>
                            <li>Bessere Performance und StabilitÃ¤t</li>
                        </ul>
                    `,
                    [{ text: 'Verstanden', onclick: hideModal, class: 'btn-primary' }]
                );
                
                localStorage.setItem(LAST_VERSION_KEY, APP_VERSION);
            }
        }

        // Check for updates after app loads
        setTimeout(checkForUpdates, 2000);

        // Performance monitoring
        if ('performance' in window) {
            window.addEventListener('load', () => {
                const perfData = window.performance.timing;
                const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
                console.log(`Page load time: ${pageLoadTime}ms`);
                
                if (pageLoadTime > 3000) {
                    console.warn('Page load time is high. Consider optimizing resources.');
                }
            });
        }

        // Prevent accidental navigation
        let hasUnsavedChanges = false;

        window.addEventListener('beforeunload', (e) => {
            if (currentAudit && Object.keys(currentAudit.answers).length > 0) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });

        // Final initialization
        console.log('WHS Safety Audit App initialized successfully');
        console.log(`Version: ${APP_VERSION}`);
        console.log(`Online: ${isOnline}`);
        console.log(`Service Worker: ${'serviceWorker' in navigator ? 'Supported' : 'Not supported'}`);
    </script>
</body>
</html>
