<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safety Analytics Platform - Amazon WHS Austria | Developed by Erwin Esener</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #FF9900;
            --primary-dark: #e88600;
            --secondary: #232F3E;
            --secondary-dark: #37475A;
            --success: #4CAF50;
            --warning: #FFC107;
            --danger: #FF5722;
            --critical: #B71C1C;
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #212121;
            --text-secondary: #757575;
            --shadow: rgba(0,0,0,0.1);
            --shadow-hover: rgba(0,0,0,0.15);
            --border-radius: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --shadow: rgba(255,255,255,0.05);
            --shadow-hover: rgba(255,255,255,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }

        /* Modern Header */
        .header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            padding: 1.5rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Mode Toggle */
        .mode-toggle {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 30px;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
        }

        .mode-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        /* Navigation Tabs */
        .nav-container {
            background: var(--bg-primary);
            box-shadow: 0 2px 10px var(--shadow);
            position: sticky;
            top: 80px;
            z-index: 90;
            margin-bottom: 2rem;
        }

        .nav-tabs {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0.75rem 20px;
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            white-space: nowrap;
            font-weight: 500;
            position: relative;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
            z-index: -1;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px var(--shadow);
        }

        .nav-tab:hover::before {
            width: 100%;
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 10px rgba(255, 153, 0, 0.3);
        }

        .nav-tab-icon {
            margin-right: 0.5rem;
        }

        /* Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px 40px;
        }

        /* Modern Cards */
        .card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 2px 10px var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .card:hover::before {
            opacity: 1;
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow);
            transition: var(--transition);
        }

        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .metric-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .metric-card:hover .metric-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0.5rem 0;
            transition: var(--transition);
        }

        .metric-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .metric-trend {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 0.9rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }

        .metric-trend.down {
            background: rgba(255, 87, 34, 0.1);
            color: var(--danger);
        }

        /* Control Panel */
        .control-panel {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .control-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Modern Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:active::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 153, 0, 0.3);
        }

        .btn-secondary {
            background: var(--secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(35, 47, 62, 0.3);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* File Upload Area */
        .upload-area {
            border: 2px dashed var(--primary);
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            background: rgba(255, 153, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .upload-area:hover {
            border-color: var(--primary-dark);
            background: rgba(255, 153, 0, 0.1);
        }

        .upload-area.dragging {
            background: rgba(255, 153, 0, 0.2);
            border-color: var(--primary);
        }

        .file-input {
            display: none;
        }

        .upload-label {
            display: inline-block;
            padding: 0.75rem 2rem;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .upload-label:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Filter Section */
        .filter-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-input {
            padding: 0.75rem;
            border: 2px solid transparent;
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .filter-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-primary);
        }

        /* Quick Actions Bar */
        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        /* Charts Container */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Data Table */
        .table-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: 0 2px 10px var(--shadow);
            overflow: hidden;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .table-wrapper {
            overflow-x: auto;
            margin: -1.5rem;
            padding: 1.5rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: var(--secondary);
            color: white;
            padding: 1rem;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--bg-secondary);
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .badge-success {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .badge-danger {
            background: rgba(255, 87, 34, 0.2);
            color: var(--danger);
        }

        .badge-critical {
            background: rgba(183, 28, 28, 0.2);
            color: var(--critical);
        }

        .badge-info {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        /* Risk Matrix */
        .risk-matrix {
            display: grid;
            grid-template-columns: 80px repeat(5, 1fr);
            grid-template-rows: repeat(6, 80px);
            gap: 4px;
            max-width: 600px;
            margin: 2rem auto;
        }

        .matrix-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            font-size: 1.1rem;
        }

        .matrix-cell::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .matrix-cell:hover::before {
            width: 100px;
            height: 100px;
        }

        .matrix-cell:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .matrix-label {
            background: var(--secondary);
            color: white;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .risk-low { background: var(--success); }
        .risk-medium { background: var(--warning); color: #333; }
        .risk-high { background: var(--danger); }
        .risk-critical { background: var(--critical); }

        /* Timeline */
        .timeline-container {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .timeline-item {
            border-left: 3px solid var(--primary);
            padding-left: 2rem;
            margin-bottom: 2rem;
            position: relative;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 0;
            width: 13px;
            height: 13px;
            border-radius: 50%;
            background: var(--primary);
        }

        .timeline-date {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .timeline-content {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 8px;
        }

        /* Status Messages */
        .status-message {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .status-success {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
            border: 1px solid rgba(76, 175, 80, 0.3);
        }

        .status-error {
            background: rgba(255, 87, 34, 0.1);
            color: var(--danger);
            border: 1px solid rgba(255, 87, 34, 0.3);
        }

        .status-info {
            background: rgba(33, 150, 243, 0.1);
            color: #2196F3;
            border: 1px solid rgba(33, 150, 243, 0.3);
        }

        /* Austin Case Study Link */
        .austin-link {
            background: var(--primary);
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 5px;
            text-decoration: none;
            font-size: 0.85rem;
            transition: var(--transition);
        }

        .austin-link:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--bg-secondary);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Action Items */
        .action-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 2rem;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .action-category {
            margin-bottom: 2rem;
        }

        .action-category h4 {
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-list {
            list-style: none;
            padding: 0;
        }

        .action-item {
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: var(--transition);
        }

        .action-item:hover {
            transform: translateX(4px);
        }

        .action-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .action-icon.immediate {
            background: rgba(255, 87, 34, 0.2);
            color: var(--danger);
        }

        .action-icon.short-term {
            background: rgba(255, 193, 7, 0.2);
            color: var(--warning);
        }

        .action-icon.long-term {
            background: rgba(33, 150, 243, 0.2);
            color: #2196F3;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: scroll;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .filter-section {
                grid-template-columns: 1fr;
            }

            .table-wrapper {
                font-size: 0.9rem;
            }

            .risk-matrix {
                grid-template-columns: 40px repeat(5, 1fr);
                grid-template-rows: repeat(6, 60px);
                font-size: 0.8rem;
            }
        }

        /* Tab Content */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Hidden class */
        .hidden {
            display: none !important;
        }

        /* Export Options */
        .export-section {
            background: var(--bg-primary);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 2px 10px var(--shadow);
        }

        .export-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            position: relative;
            background: var(--bg-primary);
            margin: 5% auto;
            padding: 2rem;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--bg-secondary);
            padding-bottom: 1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--text-primary);
            transform: rotate(90deg);
        }

        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 4rem 2rem;
        }

        .welcome-title {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 3rem;
        }

        .welcome-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .pagination-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* KPI Dashboard */
        .kpi-container {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);
            color: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 2rem;
            margin-top: 1.5rem;
        }

        .kpi-item {
            text-align: center;
        }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }
            
            .header, .nav-container, .mode-toggle, .btn, .upload-area {
                display: none !important;
            }
            
            .card, .table-container {
                break-inside: avoid;
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }

        /* Footer */
        .footer {
            background: var(--secondary);
            color: white;
            padding: 2rem 0;
            margin-top: 4rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .footer a {
            color: var(--primary);
            text-decoration: none;
        }

        .footer a:hover {
            text-decoration: underline;
        }

        /* Sub Navigation */
        .sub-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--bg-secondary);
            padding-bottom: 0.5rem;
        }

        .sub-nav-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px 8px 0 0;
        }

        .sub-nav-item:hover {
            background: var(--bg-secondary);
        }

        .sub-nav-item.active {
            background: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-title">
                <h1>
                    <span>üõ°Ô∏è</span>
                    Safety Analytics Platform
                </h1>
                <div class="header-subtitle">
                    <span>Amazon WHS Austria</span>
                    <span style="opacity: 0.7;">|</span>
                    <span>Developed by Erwin Esener</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="mode-toggle" onclick="toggleTheme()">
                    <span id="themeIcon">üåô</span>
                    <span id="themeText">Dark Mode</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Navigation -->
    <nav class="nav-container">
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchModule('overview')">
                <span class="nav-tab-icon">üìä</span>
                <span>Overview</span>
            </div>
            <div class="nav-tab" onclick="switchModule('injury')">
                <span class="nav-tab-icon">üè•</span>
                <span>Injury & Illness</span>
            </div>
            <div class="nav-tab" onclick="switchModule('nearmiss')">
                <span class="nav-tab-icon">‚ö†Ô∏è</span>
                <span>Near Miss</span>
            </div>
            <div class="nav-tab" onclick="switchModule('combined')">
                <span class="nav-tab-icon">üìà</span>
                <span>Combined Analytics</span>
            </div>
            <div class="nav-tab" onclick="switchModule('reports')">
                <span class="nav-tab-icon">üìÑ</span>
                <span>Reports</span>
            </div>
            <div class="nav-tab" onclick="switchModule('actions')">
                <span class="nav-tab-icon">‚úÖ</span>
                <span>Action Tracking</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- Status Message Container -->
        <div id="statusContainer"></div>

        <!-- Overview Module -->
        <div id="overview" class="tab-content active">
            <div class="welcome-screen" id="welcomeScreen">
                <h2 class="welcome-title">Welcome to Safety Analytics</h2>
                <p class="welcome-subtitle">Your comprehensive platform for workplace safety data analysis</p>
                <div class="welcome-actions">
                    <button class="btn btn-primary" onclick="switchModule('injury')">
                        <span>üè•</span> Analyze Injuries
                    </button>
                    <button class="btn btn-primary" onclick="switchModule('nearmiss')">
                        <span>‚ö†Ô∏è</span> Review Near Misses
                    </button>
                    <button class="btn btn-secondary" onclick="loadSampleData()">
                        <span>üß™</span> Load Sample Data
                    </button>
                </div>
            </div>

            <!-- KPI Dashboard -->
            <div class="kpi-container" id="kpiDashboard" style="display: none;">
                <h3>Key Performance Indicators - Austria Region</h3>
                <div class="kpi-grid">
                    <div class="kpi-item">
                        <div class="kpi-value" id="kpiTRIR">0.00</div>
                        <div class="kpi-label">TRIR (Total Recordable Incident Rate)</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-value" id="kpiLTIR">0.00</div>
                        <div class="kpi-label">LTIR (Lost Time Incident Rate)</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-value" id="kpiDAFWR">0.00</div>
                        <div class="kpi-label">DAFWR (Days Away From Work Rate)</div>
                    </div>
                    <div class="kpi-item">
                        <div class="kpi-value" id="kpiNMFR">0.00</div>
                        <div class="kpi-label">NMFR (Near Miss Frequency Rate)</div>
                    </div>
                </div>
            </div>

            <!-- Combined Metrics Overview -->
            <div class="metrics-grid" id="overviewMetrics" style="display: none;">
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-value" id="totalIncidents">0</div>
                    <div class="metric-label">Total Safety Events</div>
                    <div class="metric-trend">‚Üì 12%</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üè•</div>
                    <div class="metric-value" id="injuryCount">0</div>
                    <div class="metric-label">Injuries & Illnesses</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-value" id="nearMissCount">0</div>
                    <div class="metric-label">Near Misses</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-value" id="riskScore">0.0</div>
                    <div class="metric-label">Overall Risk Score</div>
                </div>
            </div>

            <!-- Quick Charts -->
            <div class="charts-grid" id="overviewCharts" style="display: none;">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Safety Trend Overview</h3>
                        <button class="btn btn-sm btn-outline" onclick="exportChart('overviewTrendChart')">
                            <span>üì∏</span> Export
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="overviewTrendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Site Comparison</h3>
                        <button class="btn btn-sm btn-outline" onclick="exportChart('overviewSiteChart')">
                            <span>üì∏</span> Export
                        </button>
                    </div>
                    <div class="chart-container">
                        <canvas id="overviewSiteChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Injury & Illness Module -->
        <div id="injury" class="tab-content">
            <!-- Sub Navigation -->
            <div class="sub-nav">
                <div class="sub-nav-item active" onclick="switchInjuryView('dashboard')">Dashboard</div>
                <div class="sub-nav-item" onclick="switchInjuryView('riskMatrix')">Risk Matrix</div>
                <div class="sub-nav-item" onclick="switchInjuryView('timeline')">Timeline</div>
                <div class="sub-nav-item" onclick="switchInjuryView('analytics')">Advanced Analytics</div>
            </div>

            <!-- Dashboard View -->
            <div id="injuryDashboard" class="injury-view">
                <div class="control-panel">
                    <div class="control-header">
                        <h2 class="control-title">Injury & Illness Analysis</h2>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="generatePDFReport('injury')">
                                <span>üìÑ</span> Generate Report
                            </button>
                            <button class="btn btn-secondary" onclick="exportInjuryData()">
                                <span>üìä</span> Export to Excel
                            </button>
                            <button class="btn btn-outline" onclick="refreshDashboard('injury')">
                                <span>üîÑ</span> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="upload-area" id="injuryUploadArea" ondrop="handleDrop(event, 'injury')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <p style="margin-bottom: 1rem;">üìÅ Drag and drop your injury CSV file here</p>
                        <label for="injuryFile" class="upload-label">Choose File</label>
                        <input type="file" id="injuryFile" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'injury')">
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                            Supports CSV files with injury/illness tracking data including severity, body parts, causes, recordability, and OTR status
                        </p>
                    </div>

                    <div class="filter-section">
                        <div class="filter-group">
                            <label class="filter-label">Site</label>
                            <select class="filter-input" id="injurySiteFilter" onchange="applyFilters('injury')">
                                <option value="">All Sites</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Severity</label>
                            <select class="filter-input" id="injurySeverityFilter" onchange="applyFilters('injury')">
                                <option value="">All Severities</option>
                                <option value="A">A - Critical</option>
                                <option value="B">B - High</option>
                                <option value="C">C - Medium</option>
                                <option value="D">D - Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Recordable</label>
                            <select class="filter-input" id="injuryRecordableFilter" onchange="applyFilters('injury')">
                                <option value="">All Cases</option>
                                <option value="1">Recordable Only</option>
                                <option value="0">Non-Recordable Only</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">OTR Status</label>
                            <select class="filter-input" id="injuryOTRFilter" onchange="applyFilters('injury')">
                                <option value="">All</option>
                                <option value="yes">On The Road</option>
                                <option value="no">Not On The Road</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Body Part</label>
                            <select class="filter-input" id="injuryBodyPartFilter" onchange="applyFilters('injury')">
                                <option value="">All Body Parts</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Root Cause</label>
                            <select class="filter-input" id="injuryRootCauseFilter" onchange="applyFilters('injury')">
                                <option value="">All Causes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date From</label>
                            <input type="date" class="filter-input" id="injuryDateFrom" onchange="applyFilters('injury')">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date To</label>
                            <input type="date" class="filter-input" id="injuryDateTo" onchange="applyFilters('injury')">
                        </div>
                    </div>
                </div>

                <!-- Injury Metrics -->
                <div class="metrics-grid" id="injuryMetrics">
                    <div class="metric-card">
                        <div class="metric-icon">üè•</div>
                        <div class="metric-value" id="injuryTotal">0</div>
                        <div class="metric-label">Total Incidents</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìù</div>
                        <div class="metric-value" id="injuryRecordable">0</div>
                        <div class="metric-label">Recordable Cases</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìÖ</div>
                        <div class="metric-value" id="injuryLostTime">0</div>
                        <div class="metric-label">Lost Time Cases</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">‚è±Ô∏è</div>
                        <div class="metric-value" id="injuryDaysLost">0</div>
                        <div class="metric-label">Days Away From Work</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üöó</div>
                        <div class="metric-value" id="injuryOTR">0</div>
                        <div class="metric-label">OTR Incidents</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìä</div>
                        <div class="metric-value" id="injuryRecordableRate">0.0</div>
                        <div class="metric-label">Recordable Rate</div>
                    </div>
                </div>

                <!-- Injury Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Analysis View 1</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateInjuryChart(1, this.value)">
                                <option value="severity">Severity Distribution</option>
                                <option value="bodyPart">Body Parts Affected</option>
                                <option value="rootCause">Root Causes</option>
                                <option value="processPath">Process Paths</option>
                                <option value="contributingFactors">Contributing Factors</option>
                                <option value="otrAnalysis">OTR Analysis</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryChart1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Analysis View 2</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateInjuryChart(2, this.value)">
                                <option value="trend">Monthly Trend</option>
                                <option value="recordableTrend">Recordable Trend</option>
                                <option value="lostTimeTrend">Lost Time Trend</option>
                                <option value="dafwAnalysis">DAFW Analysis</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryChart2"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Site Analysis</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateInjuryChart(3, this.value)">
                                <option value="site">Site Comparison</option>
                                <option value="recordableRate">Recordable Rate by Site</option>
                                <option value="severityBySite">Severity by Site</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryChart3"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Impact Analysis</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateInjuryChart(4, this.value)">
                                <option value="impactType">Impact Types</option>
                                <option value="bodyPartHeatmap">Body Part Heatmap</option>
                                <option value="riskTrend">Risk Score Trend</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryChart4"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Injury Table -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>Recent Injury & Illness Cases</h3>
                        <button class="btn btn-sm btn-outline" onclick="exportTable('injury')">
                            <span>üìä</span> Export Table
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table id="injuryTable">
                            <thead>
                                <tr>
                                    <th>Case Number</th>
                                    <th>Date</th>
                                    <th>Site</th>
                                    <th>Body Part</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Recordable</th>
                                    <th>OTR</th>
                                    <th>DAFW Days</th>
                                    <th>Root Cause</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="injuryTableBody">
                                <tr>
                                    <td colspan="11" style="text-align: center; padding: 3rem;">
                                        No data loaded. Please upload a CSV file.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button class="btn btn-sm" onclick="changePage('injury', -1)" id="injuryPrevBtn">Previous</button>
                        <span class="pagination-info" id="injuryPageInfo">Page 1 of 1</span>
                        <button class="btn btn-sm" onclick="changePage('injury', 1)" id="injuryNextBtn">Next</button>
                    </div>
                </div>
            </div>

            <!-- Risk Matrix View -->
            <div id="injuryRiskMatrix" class="injury-view hidden">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Injury & Illness Risk Assessment Matrix</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Click on any cell to view incidents in that risk category
                    </p>
                    <div class="risk-matrix" id="injuryRiskMatrixGrid">
                        <!-- Will be populated dynamically -->
                    </div>
                    <div style="margin-top: 2rem; text-align: center;">
                        <h4>Risk Levels:</h4>
                        <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 1rem;">
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #4CAF50; vertical-align: middle; border-radius: 4px;"></span> Low (1-5)</span>
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #FFC107; vertical-align: middle; border-radius: 4px;"></span> Medium (6-10)</span>
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #FF5722; vertical-align: middle; border-radius: 4px;"></span> High (11-15)</span>
                            <span><span style="display: inline-block; width: 20px; height: 20px; background: #B71C1C; vertical-align: middle; border-radius: 4px;"></span> Critical (16-25)</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Timeline View -->
            <div id="injuryTimeline" class="injury-view hidden">
                <div class="timeline-container">
                    <h3 style="margin-bottom: 1.5rem;">Injury & Illness Timeline</h3>
                    <div id="injuryTimelineContent">
                        <p style="text-align: center; padding: 2rem;">Timeline will be displayed after data is loaded.</p>
                    </div>
                    <div class="pagination">
                        <button class="btn btn-sm" onclick="changeTimelinePage('injury', -1)">Previous</button>
                        <span class="pagination-info" id="injuryTimelinePageInfo">Page 1 of 1</span>
                        <button class="btn btn-sm" onclick="changeTimelinePage('injury', 1)">Next</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics View -->
            <div id="injuryAnalytics" class="injury-view hidden">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Recordable Rate Trend</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryRecordableRateTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Body Part Heat Map by Severity</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryBodyPartHeatMapChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Root Cause Analysis by Site</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryRootCauseBySiteChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">DAFW Days Distribution</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="injuryDAFWDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Near Miss Module -->
        <div id="nearmiss" class="tab-content">
            <!-- Sub Navigation -->
            <div class="sub-nav">
                <div class="sub-nav-item active" onclick="switchNearMissView('dashboard')">Dashboard</div>
                <div class="sub-nav-item" onclick="switchNearMissView('riskMatrix')">Risk Matrix</div>
                <div class="sub-nav-item" onclick="switchNearMissView('timeline')">Timeline</div>
                <div class="sub-nav-item" onclick="switchNearMissView('analytics')">Advanced Analytics</div>
            </div>

            <!-- Dashboard View -->
            <div id="nearMissDashboard" class="nearmiss-view">
                <div class="control-panel">
                    <div class="control-header">
                        <h2 class="control-title">Near Miss Analysis</h2>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="generatePDFReport('nearmiss')">
                                <span>üìÑ</span> Generate Report
                            </button>
                            <button class="btn btn-secondary" onclick="exportNearMissData()">
                                <span>üìä</span> Export to Excel
                            </button>
                            <button class="btn btn-outline" onclick="refreshDashboard('nearmiss')">
                                <span>üîÑ</span> Refresh
                            </button>
                        </div>
                    </div>

                    <div class="upload-area" id="nearMissUploadArea" ondrop="handleDrop(event, 'nearmiss')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                        <p style="margin-bottom: 1rem;">üìÅ Drag and drop your near miss CSV file here</p>
                        <label for="nearMissFile" class="upload-label">Choose File</label>
                        <input type="file" id="nearMissFile" class="file-input" accept=".csv" onchange="handleFileUpload(event, 'nearmiss')">
                        <p style="margin-top: 1rem; font-size: 0.9rem; color: var(--text-secondary);">
                            Supports CSV files with near miss tracking data including potential severity, location, and risk assessments
                        </p>
                    </div>

                    <div class="filter-section">
                        <div class="filter-group">
                            <label class="filter-label">Site</label>
                            <select class="filter-input" id="nearMissSiteFilter" onchange="applyFilters('nearmiss')">
                                <option value="">All Sites</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Potential Severity</label>
                            <select class="filter-input" id="nearMissSeverityFilter" onchange="applyFilters('nearmiss')">
                                <option value="">All Severities</option>
                                <option value="A">A - Critical</option>
                                <option value="B">B - High</option>
                                <option value="C">C - Medium</option>
                                <option value="D">D - Low</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Primary Impact</label>
                            <select class="filter-input" id="nearMissPrimaryImpactFilter" onchange="applyFilters('nearmiss')">
                                <option value="">All Impacts</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Location</label>
                            <select class="filter-input" id="nearMissLocationFilter" onchange="applyFilters('nearmiss')">
                                <option value="">All Locations</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Process Path</label>
                            <select class="filter-input" id="nearMissProcessFilter" onchange="applyFilters('nearmiss')">
                                <option value="">All Processes</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Likelihood</label>
                            <select class="filter-input" id="nearMissLikelihoodFilter" onchange="applyFilters('nearmiss')">
                                <option value="">All Likelihoods</option>
                                <option value="Rare">Rare</option>
                                <option value="Unlikely">Unlikely</option>
                                <option value="Possible">Possible</option>
                                <option value="Likely">Likely</option>
                                <option value="Almost Certain">Almost Certain</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date From</label>
                            <input type="date" class="filter-input" id="nearMissDateFrom" onchange="applyFilters('nearmiss')">
                        </div>
                        <div class="filter-group">
                            <label class="filter-label">Date To</label>
                            <input type="date" class="filter-input" id="nearMissDateTo" onchange="applyFilters('nearmiss')">
                        </div>
                    </div>
                </div>

                <!-- Near Miss Metrics -->
                <div class="metrics-grid" id="nearMissMetrics">
                    <div class="metric-card">
                        <div class="metric-icon">‚ö†Ô∏è</div>
                        <div class="metric-value" id="nearMissTotal">0</div>
                        <div class="metric-label">Total Near Misses</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìä</div>
                        <div class="metric-value" id="nearMissRisk">0.0</div>
                        <div class="metric-label">Average Risk Score</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üö®</div>
                        <div class="metric-value" id="nearMissHigh">0</div>
                        <div class="metric-label">High Severity (A & B)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìç</div>
                        <div class="metric-value" id="nearMissRepeat">0</div>
                        <div class="metric-label">Repeat Locations</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">‚ö°</div>
                        <div class="metric-value" id="nearMissActionable">0</div>
                        <div class="metric-label">Requires Action</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-icon">üìà</div>
                        <div class="metric-value" id="nearMissFrequency">0.0</div>
                        <div class="metric-label">Frequency Rate</div>
                    </div>
                </div>

                <!-- Near Miss Charts -->
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Analysis View 1</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateNearMissChart(1, this.value)">
                                <option value="severity">Severity Distribution</option>
                                <option value="location">Top Locations</option>
                                <option value="impact">Primary Impacts</option>
                                <option value="likelihood">Likelihood Analysis</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissChart1"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Analysis View 2</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateNearMissChart(2, this.value)">
                                <option value="process">Process Paths</option>
                                <option value="trend">Monthly Trend</option>
                                <option value="site">Site Comparison</option>
                                <option value="riskTrend">Risk Score Trend</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissChart2"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Impact Analysis</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateNearMissChart(3, this.value)">
                                <option value="impactBySeverity">Impact by Severity</option>
                                <option value="locationHeatmap">Location Heatmap</option>
                                <option value="contributingFactors">Contributing Factors</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissChart3"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Risk Analysis</h3>
                            <select class="filter-input" style="width: auto;" onchange="updateNearMissChart(4, this.value)">
                                <option value="riskMatrix">Risk Score Distribution</option>
                                <option value="highRiskAreas">High Risk Areas</option>
                                <option value="preventionOpportunities">Prevention Opportunities</option>
                            </select>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissChart4"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Near Miss Table -->
                <div class="table-container">
                    <div class="table-header">
                        <h3>Recent Near Miss Reports</h3>
                        <button class="btn btn-sm btn-outline" onclick="exportTable('nearmiss')">
                            <span>üìä</span> Export Table
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table id="nearMissTable">
                            <thead>
                                <tr>
                                    <th>Near Miss ID</th>
                                    <th>Date</th>
                                    <th>Site</th>
                                    <th>Location</th>
                                    <th>Process Path</th>
                                    <th>Primary Impact</th>
                                    <th>Severity</th>
                                    <th>Likelihood</th>
                                    <th>Risk Score</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="nearMissTableBody">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 3rem;">
                                        No data loaded. Please upload a CSV file.
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="pagination">
                        <button class="btn btn-sm" onclick="changePage('nearmiss', -1)" id="nearMissPrevBtn">Previous</button>
                        <span class="pagination-info" id="nearMissPageInfo">Page 1 of 1</span>
                        <button class="btn btn-sm" onclick="changePage('nearmiss', 1)" id="nearMissNextBtn">Next</button>
                    </div>
                </div>
            </div>

            <!-- Risk Matrix View -->
            <div id="nearMissRiskMatrix" class="nearmiss-view hidden">
                <div class="card">
                    <h3 style="margin-bottom: 1.5rem;">Near Miss Risk Assessment Matrix</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                        Click on any cell to view incidents in that risk category
                    </p>
                    <div class="risk-matrix" id="nearMissRiskMatrixGrid">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>
            </div>

            <!-- Timeline View -->
            <div id="nearMissTimeline" class="nearmiss-view hidden">
                <div class="timeline-container">
                    <h3 style="margin-bottom: 1.5rem;">Near Miss Timeline</h3>
                    <div id="nearMissTimelineContent">
                        <p style="text-align: center; padding: 2rem;">Timeline will be displayed after data is loaded.</p>
                    </div>
                    <div class="pagination">
                        <button class="btn btn-sm" onclick="changeTimelinePage('nearmiss', -1)">Previous</button>
                        <span class="pagination-info" id="nearMissTimelinePageInfo">Page 1 of 1</span>
                        <button class="btn btn-sm" onclick="changeTimelinePage('nearmiss', 1)">Next</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Analytics View -->
            <div id="nearMissAnalytics" class="nearmiss-view hidden">
                <div class="charts-grid">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Risk Trend Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissRiskTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Impact vs Severity Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissImpactAnalysisChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Location Risk Map</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissLocationRiskChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <div class="chart-header">
                            <h3 class="chart-title">Process Path Risk Analysis</h3>
                        </div>
                        <div class="chart-container">
                            <canvas id="nearMissProcessRiskChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined Analytics Module -->
        <div id="combined" class="tab-content">
            <div class="control-panel">
                <div class="control-header">
                    <h2 class="control-title">Combined Safety Analytics</h2>
                    <div>
                        <button class="btn btn-primary" onclick="generatePDFReport('combined')">
                            <span>üìÑ</span> Generate Combined Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Combined Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-icon">üìä</div>
                    <div class="metric-value" id="combinedTotal">0</div>
                    <div class="metric-label">Total Safety Events</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">‚ö†Ô∏è</div>
                    <div class="metric-value" id="combinedHighRisk">0</div>
                    <div class="metric-label">High Risk Events</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üìà</div>
                    <div class="metric-value" id="combinedTrend">0%</div>
                    <div class="metric-label">Monthly Trend</div>
                </div>
                <div class="metric-card">
                    <div class="metric-icon">üéØ</div>
                    <div class="metric-value" id="combinedTargetSites">0</div>
                    <div class="metric-label">Sites Requiring Focus</div>
                </div>
            </div>

            <!-- Risk Matrix -->
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">Combined Risk Assessment Matrix</h3>
                <div class="risk-matrix" id="combinedRiskMatrix">
                    <!-- Will be populated dynamically -->
                </div>
            </div>

            <!-- Combined Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Safety Performance Trend</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="combinedTrendChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Site Safety Comparison</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="combinedSiteChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Severity Analysis - Combined</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="combinedSeverityChart"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-header">
                        <h3 class="chart-title">Prevention Effectiveness</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="combinedPreventionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Insights -->
            <div class="card" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">Key Insights & Correlations</h3>
                <div id="combinedInsights">
                    <p style="color: var(--text-secondary);">Load data to see insights and correlations between injuries and near misses</p>
                </div>
            </div>
        </div>

        <!-- Reports Module -->
        <div id="reports" class="tab-content">
            <div class="control-panel">
                <div class="control-header">
                    <h2 class="control-title">Report Generation Center</h2>
                </div>
            </div>

            <div class="export-section">
                <h3 style="margin-bottom: 1.5rem;">Available Reports</h3>
                <div class="export-grid">
                    <button class="btn btn-primary" onclick="generatePDFReport('injury')">
                        <span>üìÑ</span> 
                        <div>
                            <div>Injury & Illness Report</div>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Comprehensive injury analysis</small>
                        </div>
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFReport('nearmiss')">
                        <span>üìÑ</span>
                        <div>
                            <div>Near Miss Report</div>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Near miss trends & patterns</small>
                        </div>
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFReport('combined')">
                        <span>üìÑ</span>
                        <div>
                            <div>Combined Safety Report</div>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Full safety analysis</small>
                        </div>
                    </button>
                    <button class="btn btn-primary" onclick="generatePDFReport('executive')">
                        <span>üìÑ</span>
                        <div>
                            <div>Executive Summary</div>
                            <small style="font-size: 0.8rem; opacity: 0.8;">High-level overview</small>
                        </div>
                    </button>
                    <button class="btn btn-secondary" onclick="exportToExcel('all')">
                        <span>üìä</span>
                        <div>
                            <div>Export All Data to Excel</div>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Raw data export</small>
                        </div>
                    </button>
                    <button class="btn btn-secondary" onclick="exportDashboard()">
                        <span>üì∏</span>
                        <div>
                            <div>Dashboard Screenshot</div>
                            <small style="font-size: 0.8rem; opacity: 0.8;">Current view capture</small>
                        </div>
                    </button>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">Report History</h3>
                <div id="reportHistory">
                    <p style="color: var(--text-secondary);">No reports generated yet</p>
                </div>
            </div>

            <div class="card" style="margin-top: 2rem;">
                <h3 style="margin-bottom: 1.5rem;">Scheduled Reports</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <select class="filter-input" style="flex: 1;">
                        <option>Weekly Safety Summary - Every Monday</option>
                        <option>Monthly Executive Report - 1st of Month</option>
                        <option>Quarterly Trend Analysis - Quarterly</option>
                    </select>
                    <button class="btn btn-outline">Configure</button>
                </div>
            </div>
        </div>

        <!-- Action Tracking Module -->
        <div id="actions" class="tab-content">
            <div class="control-panel">
                <div class="control-header">
                    <h2 class="control-title">Action Item Tracking</h2>
                    <button class="btn btn-primary" onclick="addNewAction()">
                        <span>‚ûï</span> Add Action
                    </button>
                </div>
            </div>

            <div class="action-section">
                <div class="action-category">
                    <h4 style="color: var(--danger);">
                        <span class="action-icon immediate">üö®</span>
                        Immediate Actions Required
                    </h4>
                    <ul class="action-list" id="immediateActions">
                        <li class="action-item">
                            <span class="action-icon immediate">!</span>
                            <div style="flex: 1;">
                                <strong>No immediate actions identified</strong>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Load data to see recommended immediate actions
                                </p>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="action-category">
                    <h4 style="color: var(--warning);">
                        <span class="action-icon short-term">‚ö°</span>
                        Short-term Actions (30 days)
                    </h4>
                    <ul class="action-list" id="shortTermActions">
                        <li class="action-item">
                            <span class="action-icon short-term">üìÖ</span>
                            <div style="flex: 1;">
                                <strong>No short-term actions identified</strong>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Actions will be generated based on data analysis
                                </p>
                            </div>
                        </li>
                    </ul>
                </div>

                <div class="action-category">
                    <h4 style="color: #2196F3;">
                        <span class="action-icon long-term">üéØ</span>
                        Long-term Improvements
                    </h4>
                    <ul class="action-list" id="longTermActions">
                        <li class="action-item">
                            <span class="action-icon long-term">üîÑ</span>
                            <div style="flex: 1;">
                                <strong>No long-term improvements identified</strong>
                                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    Strategic improvements will be suggested based on trends
                                </p>
                            </div>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for details -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Content will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <p>
            Safety Analytics Platform v2.0 | Amazon WHS Austria | 
            Developed by <a href="mailto:erwin.esener@amazon.com">Erwin Esener</a> | 
            ¬© 2024 Amazon.com, Inc.
        </p>
    </footer>

    <script>
        // Global State Management
        const state = {
            injury: {
                rawData: [],
                filteredData: [],
                charts: {},
                currentPage: 1,
                timelinePage: 1
            },
            nearMiss: {
                rawData: [],
                filteredData: [],
                charts: {},
                currentPage: 1,
                timelinePage: 1
            },
            currentModule: 'overview',
            theme: 'light',
            itemsPerPage: 15
        };

        // Constants
        const DEFAULT_AUSTIN_URL = 'https://safety.amazon.com/austin-case-study';
        const SEVERITY_COLORS = {
            'A': '#B71C1C',
            'B': '#FF5722',
            'C': '#FFC107',
            'D': '#4CAF50',
            'Unknown': '#9E9E9E'
        };

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Safety Analytics Platform - Amazon WHS Austria');
            console.log('Developed by Erwin Esener');
            initializeCharts();
            setupEventListeners();
            createRiskMatrices();
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                toggleTheme();
            }
        });

        // Theme Toggle
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const themeText = document.getElementById('themeText');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark Mode';
                state.theme = 'light';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light Mode';
                state.theme = 'dark';
            }
            
            localStorage.setItem('theme', state.theme);
            
            // Update charts for new theme
            updateAllCharts();
        }

        // Module Switching
        function switchModule(module) {
            // Update navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.closest('.nav-tab').classList.add('active');
            
            // Hide all content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Show selected content
            document.getElementById(module).classList.add('active');
            state.currentModule = module;
            
            // Update specific modules
            if (module === 'combined') {
                updateCombinedAnalytics();
            } else if (module === 'actions') {
                updateActionItems();
            }
        }

        // Sub-view switching for Injury module
        function switchInjuryView(view) {
            document.querySelectorAll('#injury .sub-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.injury-view').forEach(v => {
                v.classList.add('hidden');
            });
            
            document.getElementById('injury' + view.charAt(0).toUpperCase() + view.slice(1)).classList.remove('hidden');
            
            if (view === 'timeline') {
                updateInjuryTimeline();
            } else if (view === 'analytics') {
                updateInjuryAdvancedAnalytics();
            } else if (view === 'riskMatrix') {
                updateInjuryRiskMatrix();
            }
        }

        // Sub-view switching for Near Miss module
        function switchNearMissView(view) {
            document.querySelectorAll('#nearmiss .sub-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.nearmiss-view').forEach(v => {
                v.classList.add('hidden');
            });
            
            document.getElementById('nearMiss' + view.charAt(0).toUpperCase() + view.slice(1)).classList.remove('hidden');
            
            if (view === 'timeline') {
                updateNearMissTimeline();
            } else if (view === 'analytics') {
                updateNearMissAdvancedAnalytics();
            } else if (view === 'riskMatrix') {
                updateNearMissRiskMatrix();
            }
        }

        // File Handling
        function handleFileUpload(event, type) {
            const file = event.target.files[0];
            if (!file) return;
            
            showStatus(`Processing ${type} file...`, 'info');
            
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result, type);
            };
            reader.onerror = function() {
                showStatus('Error reading file', 'error');
            };
            reader.readAsText(file);
        }

        // Drag and Drop
        function handleDrop(event, type) {
            event.preventDefault();
            event.stopPropagation();
            
            const uploadArea = event.target.closest('.upload-area');
            uploadArea.classList.remove('dragging');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.type === 'text/csv' || file.name.endsWith('.csv')) {
                    // Create a fake event for the file input
                    const input = type === 'injury' ? 
                        document.getElementById('injuryFile') : 
                        document.getElementById('nearMissFile');
                    
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    input.files = dataTransfer.files;
                    
                    handleFileUpload({ target: input }, type);
                } else {
                    showStatus('Please upload a CSV file', 'error');
                }
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            event.target.closest('.upload-area').classList.add('dragging');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            event.target.closest('.upload-area').classList.remove('dragging');
        }

        // CSV Parsing
        function parseCSV(csvText, type) {
            Papa.parse(csvText, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (type === 'injury') {
                        state.injury.rawData = results.data;
                        processInjuryData();
                        populateInjuryFilters();
                        applyFilters('injury');
                        showStatus(`Loaded ${results.data.length} injury records successfully!`, 'success');
                    } else {
                        state.nearMiss.rawData = results.data;
                        processNearMissData();
                        populateNearMissFilters();
                        applyFilters('nearmiss');
                        showStatus(`Loaded ${results.data.length} near miss records successfully!`, 'success');
                    }
                    
                    updateOverview();
                },
                error: function(error) {
                    showStatus('Failed to parse CSV: ' + error.message, 'error');
                }
            });
        }

        // Data Processing - Injury
        function processInjuryData() {
            state.injury.rawData.forEach((row, index) => {
                // Parse dates
                if (row.incident_date) {
                    row.parsedDate = new Date(row.incident_date);
                }
                
                // Standardize severity
                row.severity = standardizeSeverity(row.severity || row.potential_severity);
                
                // Ensure numeric values
                row.recordable = parseInt(row.recordable) || 0;
                row.total_dafw_days = parseInt(row.total_dafw_days) || 0;
                row.total_rwa_days = parseInt(row.total_rwa_days) || 0;
                
                // Generate ID if needed
                if (!row.case_number) {
                    row.case_number = `CASE-${index + 1}`;
                }
                
                // Extract body part
                row.bodyPart = row.initial_info_principal_body_part || 
                              row.initial_info_detailed_body_part || 
                              'Unknown';
                
                // Extract OTR status
                if (row.initial_info_incident_on_the_road === true) {
                    row.otr = 'yes';
                } else if (row.initial_info_incident_on_the_road === false) {
                    row.otr = 'no';
                } else {
                    row.otr = row.initial_info_incident_on_the_road || 'no';
                    if (typeof row.otr === 'string') {
                        row.otr = row.otr.toLowerCase();
                    }
                    if (row.otr === '1' || row.otr === 'true' || row.otr === 'yes' || row.otr === 'y') {
                        row.otr = 'yes';
                    } else {
                        row.otr = 'no';
                    }
                }
                
                // Extract root cause
                row.rootCause = row.rca_primary_cause || 'Under Investigation';
                
                // Extract contributing factors
                row.contributingFactor = row.rca_contributing_factor_category || 'Unknown';
                
                // Process path
                row.processPath = row.initial_info_process_path || 'Unknown';
                
                // Extract Austin URL
                row.austin_url = row.austin_url || 
                                row.austin_case_study_url || 
                                row.austin_link || 
                                row.case_study_url ||
                                DEFAULT_AUSTIN_URL;
                
                // Standardize likelihood
                row.standardized_likelihood = standardizeLikelihood(row.initial_risk_assessment_likeliness);
            });
        }

        // Data Processing - Near Miss
        function processNearMissData() {
            state.nearMiss.rawData.forEach((row, index) => {
                // Parse dates
                if (row.nearmiss_date) {
                    row.parsedDate = new Date(row.nearmiss_date);
                }
                
                // Use potential_severity
                row.severity = standardizeSeverity(row.potential_severity || row.severity);
                
                // Standardize likelihood
                row.standardized_likelihood = standardizeLikelihood(row.initial_risk_assessment_likeliness);
                
                // Calculate risk score if not present
                if (!row.risk || row.risk === '' || row.risk === 0) {
                    row.risk = calculateRiskScore(row);
                }
                
                // Generate ID if needed
                if (!row.incident_id) {
                    const date = row.parsedDate || new Date();
                    const site = (row.site && row.site.trim()) ? row.site.trim() : 'XX';
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const seq = String(index + 1).padStart(3, '0');
                    row.incident_id = `NM-${site}-${year}${month}-${seq}`;
                }
                
                // Extract primary impact
                row.primaryImpact = row.initial_info_primary_impact || 'Unknown';
                
                // Extract location
                row.location = row.initial_info_location_event || 'Unknown';
                
                // Process path
                row.processPath = row.initial_info_process_path || 'Unknown';
                
                // Contributing factors
                row.contributingFactor = row.rca_contributing_factor_category || 'Unknown';
            });
        }

        // Standardize severity
        function standardizeSeverity(severity) {
            if (!severity) return 'Unknown';
            const severityStr = String(severity).toUpperCase().trim();
            
            if (['A', 'B', 'C', 'D'].includes(severityStr)) {
                return severityStr;
            }
            
            const lower = severityStr.toLowerCase();
            if (lower.includes('critical') || lower.includes('severe')) return 'A';
            if (lower.includes('high') || lower.includes('major')) return 'B';
            if (lower.includes('medium') || lower.includes('moderate')) return 'C';
            if (lower.includes('low') || lower.includes('minor')) return 'D';
            
            return 'Unknown';
        }

        // Standardize likelihood
        function standardizeLikelihood(likelihood) {
            if (!likelihood) return 'Possible';
            
            const likelihoodStr = String(likelihood).toLowerCase().trim();
            
            // Direct matches
            if (likelihoodStr.includes('rare')) return 'Rare';
            if (likelihoodStr.includes('unlikely')) return 'Unlikely';
            if (likelihoodStr.includes('possible')) return 'Possible';
            if (likelihoodStr.includes('likely') && !likelihoodStr.includes('unlikely')) {
                if (likelihoodStr.includes('almost') || likelihoodStr.includes('certain')) {
                    return 'Almost Certain';
                }
                return 'Likely';
            }
            if (likelihoodStr.includes('certain')) return 'Almost Certain';
            
            // Numeric values (1-5 scale)
            const numValue = parseInt(likelihoodStr);
            if (!isNaN(numValue)) {
                switch(numValue) {
                    case 1: return 'Rare';
                    case 2: return 'Unlikely';
                    case 3: return 'Possible';
                    case 4: return 'Likely';
                    case 5: return 'Almost Certain';
                }
            }
            
            return 'Possible'; // Default
        }

        // Calculate risk score
        function calculateRiskScore(row) {
            const severityMap = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'Unknown': 1 };
            const likelihoodMap = { 
                'Rare': 1, 
                'Unlikely': 2, 
                'Possible': 3, 
                'Likely': 4, 
                'Almost Certain': 5 
            };
            
            const severity = severityMap[row.severity] || 1;
            const likelihood = likelihoodMap[row.standardized_likelihood] || 3;
            
            return ((severity * likelihood) / 5 * 2).toFixed(1); // Scale to 0-10
        }

        // Populate Filters
        function populateInjuryFilters() {
            // Sites
            const sites = [...new Set(state.injury.rawData.map(r => r.site).filter(Boolean))];
            const siteFilter = document.getElementById('injurySiteFilter');
            siteFilter.innerHTML = '<option value="">All Sites</option>';
            sites.sort().forEach(site => {
                siteFilter.innerHTML += `<option value="${site}">${site}</option>`;
            });
            
            // Body Parts
            const bodyParts = [...new Set(state.injury.rawData.map(r => r.bodyPart).filter(Boolean))];
            const bodyPartFilter = document.getElementById('injuryBodyPartFilter');
            bodyPartFilter.innerHTML = '<option value="">All Body Parts</option>';
            bodyParts.sort().slice(0, 20).forEach(part => {
                const truncated = part.length > 30 ? part.substring(0, 30) + '...' : part;
                bodyPartFilter.innerHTML += `<option value="${part}">${truncated}</option>`;
            });
            
            // Root Causes
            const rootCauses = [...new Set(state.injury.rawData.map(r => r.rootCause).filter(Boolean))];
            const rootCauseFilter = document.getElementById('injuryRootCauseFilter');
            rootCauseFilter.innerHTML = '<option value="">All Causes</option>';
            rootCauses.sort().forEach(cause => {
                const truncated = cause.length > 30 ? cause.substring(0, 30) + '...' : cause;
                rootCauseFilter.innerHTML += `<option value="${cause}">${truncated}</option>`;
            });
        }

        function populateNearMissFilters() {
            // Sites
            const sites = [...new Set(state.nearMiss.rawData.map(r => r.site).filter(Boolean))];
            const siteFilter = document.getElementById('nearMissSiteFilter');
            siteFilter.innerHTML = '<option value="">All Sites</option>';
            sites.sort().forEach(site => {
                siteFilter.innerHTML += `<option value="${site}">${site}</option>`;
            });
            
            // Primary Impacts
            const impacts = [...new Set(state.nearMiss.rawData.map(r => r.primaryImpact).filter(Boolean))];
            const impactFilter = document.getElementById('nearMissPrimaryImpactFilter');
            impactFilter.innerHTML = '<option value="">All Impacts</option>';
            impacts.sort().forEach(impact => {
                impactFilter.innerHTML += `<option value="${impact}">${impact}</option>`;
            });
            
            // Locations
            const locations = [...new Set(state.nearMiss.rawData.map(r => r.location).filter(Boolean))];
            const locationFilter = document.getElementById('nearMissLocationFilter');
            locationFilter.innerHTML = '<option value="">All Locations</option>';
            locations.sort().slice(0, 20).forEach(location => {
                const truncated = location.length > 30 ? location.substring(0, 30) + '...' : location;
                locationFilter.innerHTML += `<option value="${location}">${truncated}</option>`;
            });
            
            // Process Paths
            const processes = [...new Set(state.nearMiss.rawData.map(r => r.processPath).filter(Boolean))];
            const processFilter = document.getElementById('nearMissProcessFilter');
            processFilter.innerHTML = '<option value="">All Processes</option>';
            processes.sort().forEach(process => {
                processFilter.innerHTML += `<option value="${process}">${process}</option>`;
            });
        }

        // Apply Filters
        function applyFilters(type) {
            if (type === 'injury') {
                const siteFilter = document.getElementById('injurySiteFilter').value;
                const severityFilter = document.getElementById('injurySeverityFilter').value;
                const recordableFilter = document.getElementById('injuryRecordableFilter').value;
                const otrFilter = document.getElementById('injuryOTRFilter').value;
                const bodyPartFilter = document.getElementById('injuryBodyPartFilter').value;
                const rootCauseFilter = document.getElementById('injuryRootCauseFilter').value;
                const dateFrom = document.getElementById('injuryDateFrom').value;
                const dateTo = document.getElementById('injuryDateTo').value;
                
                state.injury.filteredData = state.injury.rawData.filter(row => {
                    if (siteFilter && row.site !== siteFilter) return false;
                    if (severityFilter && row.severity !== severityFilter) return false;
                    if (recordableFilter !== '' && row.recordable != recordableFilter) return false;
                    if (otrFilter && row.otr !== otrFilter) return false;
                    if (bodyPartFilter && row.bodyPart !== bodyPartFilter) return false;
                    if (rootCauseFilter && row.rootCause !== rootCauseFilter) return false;
                    
                    if (dateFrom || dateTo) {
                        const rowDate = row.parsedDate;
                        if (!rowDate || isNaN(rowDate)) return false;
                        if (dateFrom && rowDate < new Date(dateFrom)) return false;
                        if (dateTo && rowDate > new Date(dateTo)) return false;
                    }
                    
                    return true;
                });
                
                state.injury.currentPage = 1;
                updateInjuryDashboard();
                updateInjuryTable();
                updateInjuryCharts();
            } else {
                const siteFilter = document.getElementById('nearMissSiteFilter').value;
                const severityFilter = document.getElementById('nearMissSeverityFilter').value;
                const impactFilter = document.getElementById('nearMissPrimaryImpactFilter').value;
                const locationFilter = document.getElementById('nearMissLocationFilter').value;
                const processFilter = document.getElementById('nearMissProcessFilter').value;
                const likelihoodFilter = document.getElementById('nearMissLikelihoodFilter').value;
                const dateFrom = document.getElementById('nearMissDateFrom').value;
                const dateTo = document.getElementById('nearMissDateTo').value;
                
                state.nearMiss.filteredData = state.nearMiss.rawData.filter(row => {
                    if (siteFilter && row.site !== siteFilter) return false;
                    if (severityFilter && row.severity !== severityFilter) return false;
                    if (impactFilter && row.primaryImpact !== impactFilter) return false;
                    if (locationFilter && row.location !== locationFilter) return false;
                    if (processFilter && row.processPath !== processFilter) return false;
                    if (likelihoodFilter && row.standardized_likelihood !== likelihoodFilter) return false;
                    
                    if (dateFrom || dateTo) {
                        const rowDate = row.parsedDate;
                        if (!rowDate || isNaN(rowDate)) return false;
                        if (dateFrom && rowDate < new Date(dateFrom)) return false;
                        if (dateTo && rowDate > new Date(dateTo)) return false;
                    }
                    
                    return true;
                });
                
                state.nearMiss.currentPage = 1;
                updateNearMissDashboard();
                updateNearMissTable();
                updateNearMissCharts();
            }
            
            updateOverview();
            updateKPIs();
        }

        // Update KPIs
        function updateKPIs() {
            if (state.injury.rawData.length === 0 && state.nearMiss.rawData.length === 0) return;
            
            // Calculate rates (per 200,000 hours - standard OSHA calculation)
            const hoursWorked = 200000; // Standard baseline
            
            // TRIR (Total Recordable Incident Rate)
            const recordableCount = state.injury.filteredData.filter(r => r.recordable === 1).length;
            const trir = ((recordableCount / hoursWorked) * 200000).toFixed(2);
            document.getElementById('kpiTRIR').textContent = trir;
            
            // LTIR (Lost Time Incident Rate)
            const lostTimeCount = state.injury.filteredData.filter(r => r.total_dafw_days > 0).length;
            const ltir = ((lostTimeCount / hoursWorked) * 200000).toFixed(2);
            document.getElementById('kpiLTIR').textContent = ltir;
            
            // DAFWR (Days Away From Work Rate)
            const totalDaysLost = state.injury.filteredData.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
            const dafwr = ((totalDaysLost / hoursWorked) * 200000).toFixed(2);
            document.getElementById('kpiDAFWR').textContent = dafwr;
            
            // NMFR (Near Miss Frequency Rate)
            const nearMissCount = state.nearMiss.filteredData.length;
            const nmfr = ((nearMissCount / hoursWorked) * 200000).toFixed(2);
            document.getElementById('kpiNMFR').textContent = nmfr;
        }

        // Update Dashboards
        function updateInjuryDashboard() {
            const data = state.injury.filteredData;
            
            document.getElementById('injuryTotal').textContent = data.length;
            document.getElementById('injuryRecordable').textContent = 
                data.filter(r => r.recordable === 1).length;
            document.getElementById('injuryLostTime').textContent = 
                data.filter(r => r.total_dafw_days > 0).length;
            document.getElementById('injuryDaysLost').textContent = 
                data.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
            document.getElementById('injuryOTR').textContent = 
                data.filter(r => r.otr === 'yes').length;
            
            // Calculate recordable rate
            const recordableCount = data.filter(r => r.recordable === 1).length;
            const recordableRate = data.length > 0 ? 
                ((recordableCount / data.length) * 100).toFixed(1) : '0.0';
            document.getElementById('injuryRecordableRate').textContent = recordableRate + '%';
        }

        function updateNearMissDashboard() {
            const data = state.nearMiss.filteredData;
            
            document.getElementById('nearMissTotal').textContent = data.length;
            
            const risks = data.map(r => parseFloat(r.risk)).filter(r => !isNaN(r));
            const avgRisk = risks.length > 0 ? 
                (risks.reduce((a, b) => a + b, 0) / risks.length).toFixed(1) : '0.0';
            document.getElementById('nearMissRisk').textContent = avgRisk;
            
            document.getElementById('nearMissHigh').textContent = 
                data.filter(r => r.severity === 'A' || r.severity === 'B').length;
            
            // Calculate repeat locations
            const locationCounts = {};
            data.forEach(row => {
                const location = row.location || 'Unknown';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });
            const repeatLocations = Object.values(locationCounts).filter(count => count >= 2).length;
            document.getElementById('nearMissRepeat').textContent = repeatLocations;
            
            // Actionable items (high risk)
            const actionableCount = data.filter(r => parseFloat(r.risk) >= 7).length;
            document.getElementById('nearMissActionable').textContent = actionableCount;
            
            // Frequency rate
            const frequencyRate = data.length > 0 ? 
                (data.length / 30).toFixed(1) : '0.0'; // Per month
            document.getElementById('nearMissFrequency').textContent = frequencyRate;
        }

        // Update Tables with Pagination
        function updateInjuryTable() {
            const tbody = document.getElementById('injuryTableBody');
            const data = state.injury.filteredData;
            const currentPage = state.injury.currentPage;
            const startIndex = (currentPage - 1) * state.itemsPerPage;
            const endIndex = Math.min(startIndex + state.itemsPerPage, data.length);
            const pageData = data.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 3rem;">No data matches the current filters.</td></tr>';
                updatePaginationInfo('injury', 0, 0);
                return;
            }
            
            tbody.innerHTML = pageData.map(row => `
                <tr>
                    <td>${row.case_number || 'N/A'}</td>
                    <td>${row.incident_date || 'N/A'}</td>
                    <td>${row.site || 'N/A'}</td>
                    <td title="${row.bodyPart || ''}">${(row.bodyPart || 'N/A').substring(0, 20)}${row.bodyPart?.length > 20 ? '...' : ''}</td>
                    <td>${row.type || 'N/A'}</td>
                    <td><span class="badge badge-${getSeverityClass(row.severity)}">${row.severity}</span></td>
                    <td><span class="badge badge-${row.recordable === 1 ? 'danger' : 'success'}">${row.recordable === 1 ? 'Yes' : 'No'}</span></td>
                    <td><span class="badge badge-${row.otr === 'yes' ? 'warning' : 'info'}">${row.otr === 'yes' ? 'Yes' : 'No'}</span></td>
                    <td>${row.total_dafw_days || 0}</td>
                    <td title="${row.rootCause || ''}">${(row.rootCause || 'N/A').substring(0, 20)}${row.rootCause?.length > 20 ? '...' : ''}</td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewDetails('injury', '${row.case_number}')">View</button>
                        <a href="${row.austin_url}" target="_blank" class="austin-link">üìö</a>
                    </td>
                </tr>
            `).join('');
            
            updatePaginationInfo('injury', currentPage, Math.ceil(data.length / state.itemsPerPage));
        }

        function updateNearMissTable() {
            const tbody = document.getElementById('nearMissTableBody');
            const data = state.nearMiss.filteredData;
            const currentPage = state.nearMiss.currentPage;
            const startIndex = (currentPage - 1) * state.itemsPerPage;
            const endIndex = Math.min(startIndex + state.itemsPerPage, data.length);
            const pageData = data.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 3rem;">No data matches the current filters.</td></tr>';
                updatePaginationInfo('nearmiss', 0, 0);
                return;
            }
            
            tbody.innerHTML = pageData.map(row => `
                <tr>
                    <td>${row.incident_id || 'N/A'}</td>
                    <td>${row.nearmiss_date || 'N/A'}</td>
                    <td>${row.site || 'N/A'}</td>
                    <td title="${row.location || ''}">${(row.location || 'N/A').substring(0, 25)}${row.location?.length > 25 ? '...' : ''}</td>
                    <td title="${row.processPath || ''}">${(row.processPath || 'N/A').substring(0, 20)}${row.processPath?.length > 20 ? '...' : ''}</td>
                    <td title="${row.primaryImpact || ''}">${(row.primaryImpact || 'N/A').substring(0, 20)}${row.primaryImpact?.length > 20 ? '...' : ''}</td>
                    <td><span class="badge badge-${getSeverityClass(row.severity)}">${row.severity}</span></td>
                    <td><span class="badge badge-info">${row.standardized_likelihood || 'N/A'}</span></td>
                    <td><span class="badge badge-${getRiskClass(row.risk)}">${row.risk || 'N/A'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline" onclick="viewDetails('nearmiss', '${row.incident_id}')">View</button>
                    </td>
                </tr>
            `).join('');
            
            updatePaginationInfo('nearmiss', currentPage, Math.ceil(data.length / state.itemsPerPage));
        }

        // Pagination
        function changePage(type, direction) {
            const data = type === 'injury' ? state.injury.filteredData : state.nearMiss.filteredData;
            const totalPages = Math.ceil(data.length / state.itemsPerPage);
            
            if (type === 'injury') {
                state.injury.currentPage += direction;
                if (state.injury.currentPage < 1) state.injury.currentPage = 1;
                if (state.injury.currentPage > totalPages) state.injury.currentPage = totalPages;
                updateInjuryTable();
            } else {
                state.nearMiss.currentPage += direction;
                if (state.nearMiss.currentPage < 1) state.nearMiss.currentPage = 1;
                if (state.nearMiss.currentPage > totalPages) state.nearMiss.currentPage = totalPages;
                updateNearMissTable();
            }
        }

        function updatePaginationInfo(type, currentPage, totalPages) {
            const pageInfo = document.getElementById(`${type}PageInfo`);
            const prevBtn = document.getElementById(`${type}PrevBtn`);
            const nextBtn = document.getElementById(`${type}NextBtn`);
            
            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }

        // Get severity class for badges
        function getSeverityClass(severity) {
            switch(severity) {
                case 'A': return 'critical';
                case 'B': return 'danger';
                case 'C': return 'warning';
                case 'D': return 'success';
                default: return 'secondary';
            }
        }

        function getRiskClass(risk) {
            const riskValue = parseFloat(risk);
            if (riskValue >= 8) return 'critical';
            if (riskValue >= 6) return 'danger';
            if (riskValue >= 4) return 'warning';
            if (riskValue >= 2) return 'success';
            return 'info';
        }

        // Initialize Charts
        function initializeCharts() {
            // Injury Charts
            for (let i = 1; i <= 4; i++) {
                const ctx = document.getElementById(`injuryChart${i}`)?.getContext('2d');
                if (ctx) {
                    state.injury.charts[`chart${i}`] = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: [], datasets: [] },
                        options: getChartOptions('doughnut')
                    });
                }
            }
            
            // Near Miss Charts
            for (let i = 1; i <= 4; i++) {
                const ctx = document.getElementById(`nearMissChart${i}`)?.getContext('2d');
                if (ctx) {
                    state.nearMiss.charts[`chart${i}`] = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: [], datasets: [] },
                        options: getChartOptions('doughnut')
                    });
                }
            }
            
            // Initialize advanced analytics charts
            initializeAdvancedCharts();
            
            // Initialize overview charts
            initializeOverviewCharts();
            
            // Initialize combined charts
            initializeCombinedCharts();
        }

        function initializeAdvancedCharts() {
            // Injury Advanced Analytics
            const injuryAdvancedCharts = [
                'injuryRecordableRateTrendChart',
                'injuryBodyPartHeatMapChart',
                'injuryRootCauseBySiteChart',
                'injuryDAFWDistributionChart'
            ];
            
            injuryAdvancedCharts.forEach(chartId => {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    state.injury.charts[chartId] = new Chart(ctx, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: getChartOptions('line')
                    });
                }
            });
            
            // Near Miss Advanced Analytics
            const nearMissAdvancedCharts = [
                'nearMissRiskTrendChart',
                'nearMissImpactAnalysisChart',
                'nearMissLocationRiskChart',
                'nearMissProcessRiskChart'
            ];
            
            nearMissAdvancedCharts.forEach(chartId => {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    state.nearMiss.charts[chartId] = new Chart(ctx, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: getChartOptions('line')
                    });
                }
            });
        }

        function initializeOverviewCharts() {
            const overviewTrendCtx = document.getElementById('overviewTrendChart')?.getContext('2d');
            if (overviewTrendCtx) {
                new Chart(overviewTrendCtx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: getChartOptions('line')
                });
            }
            
            const overviewSiteCtx = document.getElementById('overviewSiteChart')?.getContext('2d');
            if (overviewSiteCtx) {
                new Chart(overviewSiteCtx, {
                    type: 'bar',
                    data: { labels: [], datasets: [] },
                    options: getChartOptions('bar')
                });
            }
        }

        function initializeCombinedCharts() {
            const combinedChartIds = [
                'combinedTrendChart',
                'combinedSiteChart',
                'combinedSeverityChart',
                'combinedPreventionChart'
            ];
            
            combinedChartIds.forEach(chartId => {
                const ctx = document.getElementById(chartId)?.getContext('2d');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: { labels: [], datasets: [] },
                        options: getChartOptions('line')
                    });
                }
            });
        }

        // Get chart options based on type
        function getChartOptions(type) {
            const isDark = state.theme === 'dark';
            const textColor = isDark ? '#ffffff' : '#212121';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            const baseOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: type === 'doughnut' || type === 'pie',
                        position: 'bottom',
                        labels: {
                            color: textColor,
                            padding: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: isDark ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)',
                        titleColor: isDark ? '#ffffff' : '#212121',
                        bodyColor: isDark ? '#ffffff' : '#212121',
                        borderColor: isDark ? 'rgba(255, 255, 255, 0.3)' : 'rgba(0, 0, 0, 0.3)',
                        borderWidth: 1,
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            };
            
            if (type === 'line' || type === 'bar') {
                baseOptions.scales = {
                    x: {
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    y: {
                        ticks: {
                            color: textColor
                        },
                        grid: {
                            color: gridColor
                        },
                        beginAtZero: true
                    }
                };
            }
            
            return baseOptions;
        }

        // Update Charts
        function updateInjuryCharts() {
            updateInjuryChart(1, document.querySelector('#injuryChart1').parentElement.parentElement.querySelector('select').value || 'severity');
            updateInjuryChart(2, document.querySelector('#injuryChart2').parentElement.parentElement.querySelector('select').value || 'trend');
            updateInjuryChart(3, document.querySelector('#injuryChart3').parentElement.parentElement.querySelector('select').value || 'site');
            updateInjuryChart(4, document.querySelector('#injuryChart4').parentElement.parentElement.querySelector('select').value || 'impactType');
        }

        function updateNearMissCharts() {
            updateNearMissChart(1, document.querySelector('#nearMissChart1').parentElement.parentElement.querySelector('select').value || 'severity');
            updateNearMissChart(2, document.querySelector('#nearMissChart2').parentElement.parentElement.querySelector('select').value || 'process');
            updateNearMissChart(3, document.querySelector('#nearMissChart3').parentElement.parentElement.querySelector('select').value || 'impactBySeverity');
            updateNearMissChart(4, document.querySelector('#nearMissChart4').parentElement.parentElement.querySelector('select').value || 'riskMatrix');
        }

        function updateInjuryChart(chartNum, type) {
            const chart = state.injury.charts[`chart${chartNum}`];
            if (!chart || state.injury.filteredData.length === 0) return;
            
            const data = state.injury.filteredData;
            
            switch(type) {
                case 'severity':
                    updateSeverityChart(chart, data);
                    break;
                case 'bodyPart':
                    updateBodyPartChart(chart, data);
                    break;
                case 'rootCause':
                    updateRootCauseChart(chart, data);
                    break;
                case 'processPath':
                    updateProcessPathChart(chart, data);
                    break;
                case 'contributingFactors':
                    updateContributingFactorsChart(chart, data);
                    break;
                case 'otrAnalysis':
                    updateOTRAnalysisChart(chart, data);
                    break;
                case 'trend':
                    updateTrendChart(chart, data, 'injury');
                    break;
                case 'recordableTrend':
                    updateRecordableTrendChart(chart, data);
                    break;
                case 'lostTimeTrend':
                    updateLostTimeTrendChart(chart, data);
                    break;
                case 'dafwAnalysis':
                    updateDAFWAnalysisChart(chart, data);
                    break;
                case 'site':
                    updateSiteChart(chart, data);
                    break;
                case 'recordableRate':
                    updateRecordableRateChart(chart, data);
                    break;
                case 'severityBySite':
                    updateSeverityBySiteChart(chart, data);
                    break;
                case 'impactType':
                    updateImpactTypeChart(chart, data);
                    break;
                case 'bodyPartHeatmap':
                    updateBodyPartHeatmapChart(chart, data);
                    break;
                case 'riskTrend':
                    updateRiskTrendChart(chart, data);
                    break;
            }
        }

        function updateNearMissChart(chartNum, type) {
            const chart = state.nearMiss.charts[`chart${chartNum}`];
            if (!chart || state.nearMiss.filteredData.length === 0) return;
            
            const data = state.nearMiss.filteredData;
            
            switch(type) {
                case 'severity':
                    updateSeverityChart(chart, data);
                    break;
                case 'location':
                    updateLocationChart(chart, data);
                    break;
                case 'impact':
                    updateImpactChart(chart, data);
                    break;
                case 'likelihood':
                    updateLikelihoodChart(chart, data);
                    break;
                case 'process':
                    updateProcessChart(chart, data);
                    break;
                case 'trend':
                    updateTrendChart(chart, data, 'nearmiss');
                    break;
                case 'site':
                    updateSiteChart(chart, data);
                    break;
                case 'riskTrend':
                    updateRiskTrendChart(chart, data);
                    break;
                case 'impactBySeverity':
                    updateImpactBySeverityChart(chart, data);
                    break;
                case 'locationHeatmap':
                    updateLocationHeatmapChart(chart, data);
                    break;
                case 'contributingFactors':
                    updateContributingFactorsChart(chart, data);
                    break;
                case 'riskMatrix':
                    updateRiskMatrixChart(chart, data);
                    break;
                case 'highRiskAreas':
                    updateHighRiskAreasChart(chart, data);
                    break;
                case 'preventionOpportunities':
                    updatePreventionOpportunitiesChart(chart, data);
                    break;
            }
        }

        // Chart Update Functions
        function updateSeverityChart(chart, data) {
            const severityCounts = {
                'A': data.filter(r => r.severity === 'A').length,
                'B': data.filter(r => r.severity === 'B').length,
                'C': data.filter(r => r.severity === 'C').length,
                'D': data.filter(r => r.severity === 'D').length
            };
            
            const nonZero = Object.entries(severityCounts).filter(([_, count]) => count > 0);
            
            chart.config.type = 'doughnut';
            chart.data = {
                labels: nonZero.map(([severity]) => `Severity ${severity}`),
                datasets: [{
                    data: nonZero.map(([, count]) => count),
                    backgroundColor: nonZero.map(([severity]) => SEVERITY_COLORS[severity])
                }]
            };
            chart.options = getChartOptions('doughnut');
            chart.update();
        }

        function updateBodyPartChart(chart, data) {
            const bodyPartCounts = {};
            data.forEach(row => {
                const part = row.bodyPart || 'Unknown';
                bodyPartCounts[part] = (bodyPartCounts[part] || 0) + 1;
            });
            
            const topParts = Object.entries(bodyPartCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topParts.map(([part]) => part.substring(0, 20) + (part.length > 20 ? '...' : '')),
                datasets: [{
                    data: topParts.map(([, count]) => count),
                    backgroundColor: 'rgba(255, 153, 0, 0.8)',
                    borderColor: 'rgba(255, 153, 0, 1)',
                    borderWidth: 1,
                    label: 'Incidents'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.options.indexAxis = 'y';
            chart.update();
        }

        function updateRootCauseChart(chart, data) {
            const causeCounts = {};
            data.forEach(row => {
                const cause = row.rootCause || 'Unknown';
                causeCounts[cause] = (causeCounts[cause] || 0) + 1;
            });
            
            const topCauses = Object.entries(causeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topCauses.map(([cause]) => cause.substring(0, 25) + (cause.length > 25 ? '...' : '')),
                datasets: [{
                    data: topCauses.map(([, count]) => count),
                    backgroundColor: 'rgba(35, 47, 62, 0.8)',
                    borderColor: 'rgba(35, 47, 62, 1)',
                    borderWidth: 1,
                    label: 'Cases'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.options.indexAxis = 'y';
            chart.update();
        }

        function updateProcessPathChart(chart, data) {
            const pathCounts = {};
            data.forEach(row => {
                const path = row.processPath || row.initial_info_process_path || 'Unknown';
                pathCounts[path] = (pathCounts[path] || 0) + 1;
            });
            
            const topPaths = Object.entries(pathCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topPaths.map(([path]) => path),
                datasets: [{
                    data: topPaths.map(([, count]) => count),
                    backgroundColor: 'rgba(55, 71, 90, 0.8)',
                    borderColor: 'rgba(55, 71, 90, 1)',
                    borderWidth: 1,
                    label: 'Cases'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.update();
        }

        function updateContributingFactorsChart(chart, data) {
            const factorCounts = {};
            data.forEach(row => {
                const factor = row.contributingFactor || row.rca_contributing_factor_category || 'Unknown';
                factorCounts[factor] = (factorCounts[factor] || 0) + 1;
            });
            
            const topFactors = Object.entries(factorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            chart.config.type = 'doughnut';
            chart.data = {
                labels: topFactors.map(([factor]) => factor),
                datasets: [{
                    data: topFactors.map(([, count]) => count),
                    backgroundColor: [
                        'rgba(255, 153, 0, 0.8)',
                        'rgba(35, 47, 62, 0.8)',
                        'rgba(55, 71, 90, 0.8)',
                        'rgba(255, 87, 34, 0.8)',
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(33, 150, 243, 0.8)'
                    ],
                    label: 'Cases'
                }]
            };
            chart.options = getChartOptions('doughnut');
            chart.update();
        }

        function updateOTRAnalysisChart(chart, data) {
            const otrCounts = {
                'On The Road': data.filter(r => r.otr === 'yes').length,
                'Not On The Road': data.filter(r => r.otr === 'no').length
            };
            
            chart.config.type = 'doughnut';
            chart.data = {
                labels: Object.keys(otrCounts),
                datasets: [{
                    data: Object.values(otrCounts),
                    backgroundColor: ['rgba(255, 87, 34, 0.8)', 'rgba(76, 175, 80, 0.8)'],
                    label: 'Cases'
                }]
            };
            chart.options = getChartOptions('doughnut');
            chart.update();
        }

        function updateTrendChart(chart, data, type) {
            const monthlyData = {};
            data.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate)) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            chart.config.type = 'line';
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    label: type === 'injury' ? 'Injuries' : 'Near Misses',
                    data: sortedMonths.map(m => monthlyData[m]),
                    borderColor: 'rgba(255, 153, 0, 1)',
                    backgroundColor: 'rgba(255, 153, 0, 0.1)',
                    tension: 0.3
                }]
            };
            chart.options = getChartOptions('line');
            chart.update();
        }

        function updateRecordableTrendChart(chart, data) {
            const monthlyData = {};
            data.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate) && row.recordable === 1) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            chart.config.type = 'line';
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    label: 'Recordable Cases',
                    data: sortedMonths.map(m => monthlyData[m] || 0),
                    borderColor: 'rgba(255, 87, 34, 1)',
                    backgroundColor: 'rgba(255, 87, 34, 0.1)',
                    tension: 0.3
                }]
            };
            chart.options = getChartOptions('line');
            chart.update();
        }

        function updateLostTimeTrendChart(chart, data) {
            const monthlyData = {};
            data.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate) && row.total_dafw_days > 0) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    monthlyData[monthKey] = (monthlyData[monthKey] || 0) + 1;
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            chart.config.type = 'line';
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    label: 'Lost Time Cases',
                    data: sortedMonths.map(m => monthlyData[m] || 0),
                    borderColor: 'rgba(183, 28, 28, 1)',
                    backgroundColor: 'rgba(183, 28, 28, 0.1)',
                    tension: 0.3
                }]
            };
            chart.options = getChartOptions('line');
            chart.update();
        }

        function updateDAFWAnalysisChart(chart, data) {
            const dafwRanges = {
                '0 Days': 0,
                '1-3 Days': 0,
                '4-7 Days': 0,
                '8-14 Days': 0,
                '15-30 Days': 0,
                '30+ Days': 0
            };
            
            data.forEach(row => {
                const days = row.total_dafw_days || 0;
                if (days === 0) dafwRanges['0 Days']++;
                else if (days <= 3) dafwRanges['1-3 Days']++;
                else if (days <= 7) dafwRanges['4-7 Days']++;
                else if (days <= 14) dafwRanges['8-14 Days']++;
                else if (days <= 30) dafwRanges['15-30 Days']++;
                else dafwRanges['30+ Days']++;
            });
            
            chart.config.type = 'doughnut';
            chart.data = {
                labels: Object.keys(dafwRanges),
                datasets: [{
                    data: Object.values(dafwRanges),
                    backgroundColor: [
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(255, 153, 0, 0.8)',
                        'rgba(255, 87, 34, 0.8)',
                        'rgba(183, 28, 28, 0.8)',
                        'rgba(55, 71, 90, 0.8)'
                    ],
                    label: 'Cases'
                }]
            };
            chart.options = getChartOptions('doughnut');
            chart.update();
        }

        function updateSiteChart(chart, data) {
            const siteCounts = {};
            data.forEach(row => {
                const site = row.site || 'Unknown';
                siteCounts[site] = (siteCounts[site] || 0) + 1;
            });
            
            const sites = Object.entries(siteCounts)
                .sort((a, b) => b[1] - a[1]);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: sites.map(([site]) => site),
                datasets: [{
                    data: sites.map(([, count]) => count),
                    backgroundColor: sites.map((_, i) => 
                        i % 2 === 0 ? 'rgba(255, 153, 0, 0.8)' : 'rgba(35, 47, 62, 0.8)'
                    ),
                    borderWidth: 1,
                    label: 'Incidents'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.update();
        }

        function updateRecordableRateChart(chart, data) {
            const siteData = {};
            data.forEach(row => {
                const site = row.site || 'Unknown';
                if (!siteData[site]) {
                    siteData[site] = { total: 0, recordable: 0 };
                }
                siteData[site].total++;
                if (row.recordable === 1) {
                    siteData[site].recordable++;
                }
            });
            
            const siteRates = Object.entries(siteData)
                .map(([site, data]) => ({
                    site,
                    rate: ((data.recordable / data.total) * 100).toFixed(1)
                }))
                .sort((a, b) => b.rate - a.rate);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: siteRates.map(s => s.site),
                datasets: [{
                    data: siteRates.map(s => parseFloat(s.rate)),
                    backgroundColor: 'rgba(255, 87, 34, 0.8)',
                    borderWidth: 1,
                    label: 'Recordable Rate %'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.options.scales.y.max = 100;
            chart.update();
        }

        function updateSeverityBySiteChart(chart, data) {
            const siteData = {};
            data.forEach(row => {
                const site = row.site || 'Unknown';
                if (!siteData[site]) {
                    siteData[site] = { A: 0, B: 0, C: 0, D: 0 };
                }
                if (row.severity && siteData[site][row.severity] !== undefined) {
                    siteData[site][row.severity]++;
                }
            });
            
            const sites = Object.keys(siteData).sort();
            
            chart.config.type = 'bar';
            chart.data = {
                labels: sites,
                datasets: [
                    {
                        label: 'Severity A',
                        data: sites.map(site => siteData[site].A),
                        backgroundColor: SEVERITY_COLORS.A
                    },
                    {
                        label: 'Severity B',
                        data: sites.map(site => siteData[site].B),
                        backgroundColor: SEVERITY_COLORS.B
                    },
                    {
                        label: 'Severity C',
                        data: sites.map(site => siteData[site].C),
                        backgroundColor: SEVERITY_COLORS.C
                    },
                    {
                        label: 'Severity D',
                        data: sites.map(site => siteData[site].D),
                        backgroundColor: SEVERITY_COLORS.D
                    }
                ]
            };
            chart.options = getChartOptions('bar');
            chart.options.scales.x.stacked = true;
            chart.options.scales.y.stacked = true;
            chart.update();
        }

        function updateImpactTypeChart(chart, data) {
            const impactCounts = {};
            data.forEach(row => {
                const impact = row.initial_info_impact_type_primary || row.type || 'Unknown';
                impactCounts[impact] = (impactCounts[impact] || 0) + 1;
            });
            
            const topImpacts = Object.entries(impactCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            chart.config.type = 'pie';
            chart.data = {
                labels: topImpacts.map(([impact]) => impact),
                datasets: [{
                    data: topImpacts.map(([, count]) => count),
                    backgroundColor: [
                        'rgba(255, 153, 0, 0.8)',
                        'rgba(35, 47, 62, 0.8)',
                        'rgba(55, 71, 90, 0.8)',
                        'rgba(255, 87, 34, 0.8)',
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(33, 150, 243, 0.8)'
                    ],
                    label: 'Cases'
                }]
            };
            chart.options = getChartOptions('pie');
            chart.update();
        }

        function updateBodyPartHeatmapChart(chart, data) {
            const bodyPartSeverity = {};
            data.forEach(row => {
                const part = row.bodyPart || 'Unknown';
                if (!bodyPartSeverity[part]) {
                    bodyPartSeverity[part] = { A: 0, B: 0, C: 0, D: 0 };
                }
                if (row.severity && bodyPartSeverity[part][row.severity] !== undefined) {
                    bodyPartSeverity[part][row.severity]++;
                }
            });
            
            const topBodyParts = Object.entries(bodyPartSeverity)
                .map(([part, severities]) => ({
                    part,
                    total: Object.values(severities).reduce((a, b) => a + b, 0),
                    severities
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 10);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topBodyParts.map(bp => bp.part.substring(0, 20) + (bp.part.length > 20 ? '...' : '')),
                datasets: [
                    {
                        label: 'Severity A',
                        data: topBodyParts.map(bp => bp.severities.A),
                        backgroundColor: SEVERITY_COLORS.A
                    },
                    {
                        label: 'Severity B',
                        data: topBodyParts.map(bp => bp.severities.B),
                        backgroundColor: SEVERITY_COLORS.B
                    },
                    {
                        label: 'Severity C',
                        data: topBodyParts.map(bp => bp.severities.C),
                        backgroundColor: SEVERITY_COLORS.C
                    },
                    {
                        label: 'Severity D',
                        data: topBodyParts.map(bp => bp.severities.D),
                        backgroundColor: SEVERITY_COLORS.D
                    }
                ]
            };
            chart.options = getChartOptions('bar');
            chart.options.indexAxis = 'y';
            chart.options.scales.x.stacked = true;
            chart.options.scales.y.stacked = true;
            chart.update();
        }

        function updateRiskTrendChart(chart, data) {
            const monthlyRisk = {};
            data.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate)) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyRisk[monthKey]) {
                        monthlyRisk[monthKey] = { total: 0, count: 0 };
                    }
                    const risk = parseFloat(row.risk || calculateRiskScore(row));
                    if (!isNaN(risk)) {
                        monthlyRisk[monthKey].total += risk;
                        monthlyRisk[monthKey].count++;
                    }
                }
            });
            
            const sortedMonths = Object.keys(monthlyRisk).sort();
            const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            
            chart.config.type = 'line';
            chart.data = {
                labels: sortedMonths.map(m => {
                    const [year, month] = m.split('-');
                    return `${monthNames[parseInt(month)-1]} ${year}`;
                }),
                datasets: [{
                    label: 'Average Risk Score',
                    data: sortedMonths.map(m => 
                        monthlyRisk[m].count > 0 ? (monthlyRisk[m].total / monthlyRisk[m].count).toFixed(1) : 0
                    ),
                    borderColor: 'rgba(255, 153, 0, 1)',
                    backgroundColor: 'rgba(255, 153, 0, 0.1)',
                    tension: 0.3
                }]
            };
            chart.options = getChartOptions('line');
            chart.update();
        }

        // Near Miss specific charts
        function updateLocationChart(chart, data) {
            const locationCounts = {};
            data.forEach(row => {
                const location = row.location || 'Unknown';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });
            
            const topLocations = Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topLocations.map(([location]) => 
                    location.substring(0, 30) + (location.length > 30 ? '...' : '')
                ),
                datasets: [{
                    data: topLocations.map(([, count]) => count),
                    backgroundColor: 'rgba(35, 47, 62, 0.8)',
                    borderColor: 'rgba(35, 47, 62, 1)',
                    borderWidth: 1,
                    label: 'Incidents'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.options.indexAxis = 'y';
            chart.update();
        }

        function updateImpactChart(chart, data) {
            const impactCounts = {};
            data.forEach(row => {
                const impact = row.primaryImpact || 'Unknown';
                impactCounts[impact] = (impactCounts[impact] || 0) + 1;
            });
            
            const topImpacts = Object.entries(impactCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 6);
            
            chart.config.type = 'pie';
            chart.data = {
                labels: topImpacts.map(([impact]) => impact),
                datasets: [{
                    data: topImpacts.map(([, count]) => count),
                    backgroundColor: [
                        'rgba(255, 153, 0, 0.8)',
                        'rgba(35, 47, 62, 0.8)',
                        'rgba(55, 71, 90, 0.8)',
                        'rgba(255, 87, 34, 0.8)',
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(33, 150, 243, 0.8)'
                    ],
                    label: 'Incidents'
                }]
            };
            chart.options = getChartOptions('pie');
            chart.update();
        }

        function updateLikelihoodChart(chart, data) {
            const likelihoodCounts = {};
            data.forEach(row => {
                const likelihood = row.standardized_likelihood || 'Unknown';
                likelihoodCounts[likelihood] = (likelihoodCounts[likelihood] || 0) + 1;
            });
            
            const likelihoods = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];
            
            chart.config.type = 'bar';
            chart.data = {
                labels: likelihoods,
                datasets: [{
                    data: likelihoods.map(l => likelihoodCounts[l] || 0),
                    backgroundColor: [
                        'rgba(76, 175, 80, 0.8)',
                        'rgba(139, 195, 74, 0.8)',
                        'rgba(255, 193, 7, 0.8)',
                        'rgba(255, 152, 0, 0.8)',
                        'rgba(255, 87, 34, 0.8)'
                    ],
                    label: 'Incidents'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.update();
        }

        function updateProcessChart(chart, data) {
            const processCounts = {};
            data.forEach(row => {
                const process = row.processPath || 'Unknown';
                processCounts[process] = (processCounts[process] || 0) + 1;
            });
            
            const processes = Object.entries(processCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: processes.map(([process]) => process),
                datasets: [{
                    data: processes.map(([, count]) => count),
                    backgroundColor: 'rgba(255, 153, 0, 0.8)',
                    borderColor: 'rgba(255, 153, 0, 1)',
                    borderWidth: 1,
                    label: 'Incidents'
                }]
            };
            chart.options = getChartOptions('bar');
            chart.update();
        }

        function updateImpactBySeverityChart(chart, data) {
            const impactSeverity = {};
            data.forEach(row => {
                const impact = row.primaryImpact || 'Unknown';
                if (!impactSeverity[impact]) {
                    impactSeverity[impact] = { A: 0, B: 0, C: 0, D: 0 };
                }
                if (row.severity && impactSeverity[impact][row.severity] !== undefined) {
                    impactSeverity[impact][row.severity]++;
                }
            });
            
            const topImpacts = Object.entries(impactSeverity)
                .map(([impact, severities]) => ({
                    impact,
                    total: Object.values(severities).reduce((a, b) => a + b, 0),
                    severities
                }))
                .sort((a, b) => b.total - a.total)
                .slice(0, 8);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topImpacts.map(i => i.impact),
                datasets: [
                    {
                        label: 'Severity A',
                        data: topImpacts.map(i => i.severities.A),
                        backgroundColor: SEVERITY_COLORS.A
                    },
                    {
                        label: 'Severity B',
                        data: topImpacts.map(i => i.severities.B),
                        backgroundColor: SEVERITY_COLORS.B
                    },
                    {
                        label: 'Severity C',
                        data: topImpacts.map(i => i.severities.C),
                        backgroundColor: SEVERITY_COLORS.C
                    },
                    {
                        label: 'Severity D',
                        data: topImpacts.map(i => i.severities.D),
                        backgroundColor: SEVERITY_COLORS.D
                    }
                ]
            };
            chart.options = getChartOptions('bar');
            chart.options.scales.x.stacked = true;
            chart.options.scales.y.stacked = true;
            chart.update();
        }

        function updateLocationHeatmapChart(chart, data) {
            const locationRisk = {};
            data.forEach(row => {
                const location = row.location || 'Unknown';
                if (!locationRisk[location]) {
                    locationRisk[location] = { total: 0, count: 0 };
                }
                const risk = parseFloat(row.risk || calculateRiskScore(row));
                if (!isNaN(risk)) {
                    locationRisk[location].total += risk;
                    locationRisk[location].count++;
                }
            });
            
            const topLocations = Object.entries(locationRisk)
                .map(([location, data]) => ({
                    location,
                    avgRisk: data.count > 0 ? (data.total / data.count).toFixed(1) : 0,
                    count: data.count
                }))
                .sort((a, b) => b.avgRisk - a.avgRisk)
                .slice(0, 10);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topLocations.map(l => l.location.substring(0, 30) + (l.location.length > 30 ? '...' : '')),
                datasets: [{
                    label: 'Average Risk Score',
                    data: topLocations.map(l => parseFloat(l.avgRisk)),
                    backgroundColor: topLocations.map(l => {
                        const risk = parseFloat(l.avgRisk);
                        if (risk >= 8) return SEVERITY_COLORS.A;
                        if (risk >= 6) return SEVERITY_COLORS.B;
                        if (risk >= 4) return SEVERITY_COLORS.C;
                        return SEVERITY_COLORS.D;
                    }),
                    borderWidth: 1
                }]
            };
            chart.options = getChartOptions('bar');
            chart.options.indexAxis = 'y';
            chart.update();
        }

        function updateRiskMatrixChart(chart, data) {
            const riskDistribution = {
                '0-2': 0,
                '2-4': 0,
                '4-6': 0,
                '6-8': 0,
                '8-10': 0
            };
            
            data.forEach(row => {
                const risk = parseFloat(row.risk || calculateRiskScore(row));
                if (risk <= 2) riskDistribution['0-2']++;
                else if (risk <= 4) riskDistribution['2-4']++;
                else if (risk <= 6) riskDistribution['4-6']++;
                else if (risk <= 8) riskDistribution['6-8']++;
                else riskDistribution['8-10']++;
            });
            
            chart.config.type = 'bar';
            chart.data = {
                labels: Object.keys(riskDistribution),
                datasets: [{
                    label: 'Number of Incidents',
                    data: Object.values(riskDistribution),
                    backgroundColor: [
                        SEVERITY_COLORS.D,
                        SEVERITY_COLORS.C,
                        SEVERITY_COLORS.C,
                        SEVERITY_COLORS.B,
                        SEVERITY_COLORS.A
                    ],
                    borderWidth: 1
                }]
            };
            chart.options = getChartOptions('bar');
            chart.update();
        }

        function updateHighRiskAreasChart(chart, data) {
            const highRiskData = data.filter(r => {
                const risk = parseFloat(r.risk || calculateRiskScore(r));
                return risk >= 7;
            });
            
            const areaCounts = {};
            highRiskData.forEach(row => {
                const key = `${row.location || 'Unknown'} - ${row.processPath || 'Unknown'}`;
                areaCounts[key] = (areaCounts[key] || 0) + 1;
            });
            
            const topAreas = Object.entries(areaCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topAreas.map(([area]) => area.substring(0, 40) + (area.length > 40 ? '...' : '')),
                datasets: [{
                    label: 'High Risk Incidents',
                    data: topAreas.map(([, count]) => count),
                    backgroundColor: 'rgba(183, 28, 28, 0.8)',
                    borderColor: 'rgba(183, 28, 28, 1)',
                    borderWidth: 1
                }]
            };
            chart.options = getChartOptions('bar');
            chart.options.indexAxis = 'y';
            chart.update();
        }

        function updatePreventionOpportunitiesChart(chart, data) {
            // Identify patterns for prevention
            const preventionData = {};
            
            // Group by root cause and severity
            data.forEach(row => {
                const factor = row.contributingFactor || 'Unknown';
                if (!preventionData[factor]) {
                    preventionData[factor] = {
                        total: 0,
                        highSeverity: 0,
                        preventable: 0
                    };
                }
                preventionData[factor].total++;
                if (row.severity === 'A' || row.severity === 'B') {
                    preventionData[factor].highSeverity++;
                }
                // Consider preventable if likelihood is not 'Rare'
                if (row.standardized_likelihood !== 'Rare') {
                    preventionData[factor].preventable++;
                }
            });
            
            const topOpportunities = Object.entries(preventionData)
                .map(([factor, data]) => ({
                    factor,
                    preventionScore: (data.preventable / data.total) * (data.highSeverity + 1)
                }))
                .sort((a, b) => b.preventionScore - a.preventionScore)
                .slice(0, 8);
            
            chart.config.type = 'bar';
            chart.data = {
                labels: topOpportunities.map(o => o.factor),
                datasets: [{
                    label: 'Prevention Priority Score',
                    data: topOpportunities.map(o => o.preventionScore.toFixed(1)),
                    backgroundColor: 'rgba(255, 153, 0, 0.8)',
                    borderColor: 'rgba(255, 153, 0, 1)',
                    borderWidth: 1
                }]
            };
            chart.options = getChartOptions('bar');
            chart.update();
        }

        // Update Overview
        function updateOverview() {
            if (state.injury.rawData.length > 0 || state.nearMiss.rawData.length > 0) {
                document.getElementById('welcomeScreen').style.display = 'none';
                document.getElementById('kpiDashboard').style.display = 'block';
                document.getElementById('overviewMetrics').style.display = 'grid';
                document.getElementById('overviewCharts').style.display = 'grid';
                
                // Update metrics
                const totalIncidents = state.injury.filteredData.length + state.nearMiss.filteredData.length;
                document.getElementById('totalIncidents').textContent = totalIncidents;
                document.getElementById('injuryCount').textContent = state.injury.filteredData.length;
                document.getElementById('nearMissCount').textContent = state.nearMiss.filteredData.length;
                
                // Calculate overall risk score
                const allRisks = [
                    ...state.injury.filteredData.map(r => parseFloat(calculateRiskScore(r))),
                    ...state.nearMiss.filteredData.map(r => parseFloat(r.risk))
                ].filter(r => !isNaN(r));
                
                const avgRisk = allRisks.length > 0 ? 
                    (allRisks.reduce((a, b) => a + b, 0) / allRisks.length).toFixed(1) : '0.0';
                document.getElementById('riskScore').textContent = avgRisk;
                
                updateKPIs();
                updateOverviewCharts();
            }
        }

        function updateOverviewCharts() {
            // Update trend chart
            const trendChart = Chart.getChart("overviewTrendChart");
            if (trendChart) {
                const allData = [...state.injury.filteredData, ...state.nearMiss.filteredData];
                const monthlyData = {};
                
                allData.forEach(row => {
                    if (row.parsedDate && !isNaN(row.parsedDate)) {
                        const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { injury: 0, nearMiss: 0 };
                        }
                        if (row.case_number) {
                            monthlyData[monthKey].injury++;
                        } else {
                            monthlyData[monthKey].nearMiss++;
                        }
                    }
                });
                
                const sortedMonths = Object.keys(monthlyData).sort();
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                
                trendChart.data = {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return `${monthNames[parseInt(month)-1]} ${year}`;
                    }),
                    datasets: [
                        {
                            label: 'Injuries',
                            data: sortedMonths.map(m => monthlyData[m].injury),
                            borderColor: 'rgba(255, 87, 34, 1)',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Near Misses',
                            data: sortedMonths.map(m => monthlyData[m].nearMiss),
                            borderColor: 'rgba(255, 193, 7, 1)',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.3
                        }
                    ]
                };
                trendChart.update();
            }
            
            // Update site chart
            const siteChart = Chart.getChart("overviewSiteChart");
            if (siteChart) {
                const siteCounts = {};
                
                state.injury.filteredData.forEach(row => {
                    const site = row.site || 'Unknown';
                    if (!siteCounts[site]) siteCounts[site] = { injury: 0, nearMiss: 0 };
                    siteCounts[site].injury++;
                });
                
                state.nearMiss.filteredData.forEach(row => {
                    const site = row.site || 'Unknown';
                    if (!siteCounts[site]) siteCounts[site] = { injury: 0, nearMiss: 0 };
                    siteCounts[site].nearMiss++;
                });
                
                const sites = Object.keys(siteCounts).sort();
                
                siteChart.data = {
                    labels: sites,
                    datasets: [
                        {
                            label: 'Injuries',
                            data: sites.map(site => siteCounts[site].injury),
                            backgroundColor: 'rgba(255, 87, 34, 0.8)'
                        },
                        {
                            label: 'Near Misses',
                            data: sites.map(site => siteCounts[site].nearMiss),
                            backgroundColor: 'rgba(255, 193, 7, 0.8)'
                        }
                    ]
                };
                siteChart.update();
            }
        }

        // Risk Matrix Functions
        function createRiskMatrices() {
            createRiskMatrix('injuryRiskMatrixGrid');
            createRiskMatrix('nearMissRiskMatrixGrid');
            createRiskMatrix('combinedRiskMatrix');
        }

        function createRiskMatrix(elementId) {
            const matrix = document.getElementById(elementId);
            if (!matrix) return;
            
            matrix.innerHTML = '';
            
            const severityLabels = ['', 'A', 'B', 'C', 'D'];
            const likelihoodLabels = ['', 'Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];
            
            for (let s = 0; s < 6; s++) {
                for (let l = 0; l < 6; l++) {
                    const cell = document.createElement('div');
                    
                    if (s === 0 && l === 0) {
                        cell.className = 'matrix-label';
                        cell.textContent = 'S/L';
                    } else if (s === 0) {
                        cell.className = 'matrix-label';
                        cell.textContent = likelihoodLabels[l];
                    } else if (l === 0) {
                        cell.className = 'matrix-label';
                        cell.textContent = severityLabels[s];
                    } else {
                        const risk = (5 - s) * l;
                        let riskClass = 'risk-low';
                        if (risk > 15) riskClass = 'risk-critical';
                        else if (risk > 10) riskClass = 'risk-high';
                        else if (risk > 5) riskClass = 'risk-medium';
                        
                        cell.className = `matrix-cell ${riskClass}`;
                        cell.textContent = '0';
                        cell.id = `${elementId}-${severityLabels[s]}-${likelihoodLabels[l]}`;
                        cell.onclick = () => showMatrixDetails(severityLabels[s], likelihoodLabels[l], elementId);
                    }
                    
                    matrix.appendChild(cell);
                }
            }
        }

        function updateInjuryRiskMatrix() {
            updateRiskMatrix(state.injury.filteredData, 'injuryRiskMatrixGrid');
        }

        function updateNearMissRiskMatrix() {
            updateRiskMatrix(state.nearMiss.filteredData, 'nearMissRiskMatrixGrid');
        }

        function updateRiskMatrix(data, matrixId) {
            // Reset all cells
            const severityLabels = ['A', 'B', 'C', 'D'];
            const likelihoodLabels = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];
            
            severityLabels.forEach(severity => {
                likelihoodLabels.forEach(likelihood => {
                    const cell = document.getElementById(`${matrixId}-${severity}-${likelihood}`);
                    if (cell) {
                        cell.textContent = '0';
                        cell.style.fontWeight = 'normal';
                    }
                });
            });
            
            // Count incidents
            const matrixCounts = {};
            
            data.forEach(incident => {
                const severity = incident.severity;
                const likelihood = incident.standardized_likelihood || 'Possible';
                
                if (['A', 'B', 'C', 'D'].includes(severity)) {
                    const key = `${severity}-${likelihood}`;
                    matrixCounts[key] = (matrixCounts[key] || 0) + 1;
                }
            });
            
            // Update cells with counts
            Object.entries(matrixCounts).forEach(([key, count]) => {
                const [severity, likelihood] = key.split('-');
                const cell = document.getElementById(`${matrixId}-${severity}-${likelihood}`);
                if (cell) {
                    cell.textContent = count.toString();
                    if (count > 0) {
                        cell.style.fontWeight = 'bold';
                        cell.style.fontSize = '1.2rem';
                    }
                }
            });
        }

        function showMatrixDetails(severity, likelihood, matrixId) {
            let data;
            let type;
            
            if (matrixId.includes('injury')) {
                data = state.injury.filteredData;
                type = 'Injury';
            } else if (matrixId.includes('nearMiss')) {
                data = state.nearMiss.filteredData;
                type = 'Near Miss';
            } else {
                data = [...state.injury.filteredData, ...state.nearMiss.filteredData];
                type = 'Combined';
            }
            
            const incidents = data.filter(r => 
                r.severity === severity && 
                r.standardized_likelihood === likelihood
            );
            
            if (incidents.length === 0) {
                showStatus(`No ${type.toLowerCase()} incidents found with Severity ${severity} and Likelihood ${likelihood}`, 'info');
                return;
            }
            
            // Show in modal
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = `${type} Incidents: Severity ${severity}, ${likelihood}`;
            body.innerHTML = `
                <p style="margin-bottom: 1rem;">Total incidents: ${incidents.length}</p>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${incidents.map(incident => `
                        <div style="padding: 1rem; border-bottom: 1px solid var(--bg-secondary);">
                            <strong>${incident.case_number || incident.incident_id}</strong><br>
                            <span style="color: var(--text-secondary);">
                                Date: ${incident.incident_date || incident.nearmiss_date || 'N/A'}<br>
                                Site: ${incident.site || 'N/A'}<br>
                                ${incident.bodyPart ? `Body Part: ${incident.bodyPart}<br>` : ''}
                                ${incident.location ? `Location: ${incident.location}<br>` : ''}
                                ${incident.processPath ? `Process: ${incident.processPath}<br>` : ''}
                            </span>
                        </div>
                    `).join('')}
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Timeline Functions
        function updateInjuryTimeline() {
            const timelineContent = document.getElementById('injuryTimelineContent');
            const data = state.injury.filteredData
                .filter(r => r.parsedDate)
                .sort((a, b) => b.parsedDate - a.parsedDate);
            
            const currentPage = state.injury.timelinePage;
            const startIndex = (currentPage - 1) * 10;
            const endIndex = Math.min(startIndex + 10, data.length);
            const pageData = data.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                timelineContent.innerHTML = '<p style="text-align: center; padding: 2rem;">No incidents to display.</p>';
                return;
            }
            
            timelineContent.innerHTML = pageData.map(incident => `
                <div class="timeline-item">
                    <div class="timeline-date">${incident.incident_date || 'N/A'}</div>
                    <div class="timeline-content">
                        <h4>${incident.case_number}</h4>
                        <p><strong>Site:</strong> ${incident.site || 'N/A'}</p>
                        <p><strong>Body Part:</strong> ${incident.bodyPart || 'N/A'}</p>
                        <p><strong>Severity:</strong> <span class="badge badge-${getSeverityClass(incident.severity)}">${incident.severity}</span></p>
                        <p><strong>Recordable:</strong> <span class="badge badge-${incident.recordable === 1 ? 'danger' : 'success'}">${incident.recordable === 1 ? 'Yes' : 'No'}</span></p>
                        <p><strong>Description:</strong> ${incident.initial_info_incident_description || 'No description'}</p>
                        <a href="${incident.austin_url}" target="_blank" class="austin-link">View Austin Case Study</a>
                    </div>
                </div>
            `).join('');
            
            // Update pagination
            const totalPages = Math.ceil(data.length / 10);
            const pageInfo = document.getElementById('injuryTimelinePageInfo');
            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        }

        function updateNearMissTimeline() {
            const timelineContent = document.getElementById('nearMissTimelineContent');
            const data = state.nearMiss.filteredData
                .filter(r => r.parsedDate)
                .sort((a, b) => b.parsedDate - a.parsedDate);
            
            const currentPage = state.nearMiss.timelinePage;
            const startIndex = (currentPage - 1) * 10;
            const endIndex = Math.min(startIndex + 10, data.length);
            const pageData = data.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                timelineContent.innerHTML = '<p style="text-align: center; padding: 2rem;">No near misses to display.</p>';
                return;
            }
            
            timelineContent.innerHTML = pageData.map(incident => `
                <div class="timeline-item">
                    <div class="timeline-date">${incident.nearmiss_date || 'N/A'}</div>
                    <div class="timeline-content">
                        <h4>${incident.incident_id}</h4>
                        <p><strong>Site:</strong> ${incident.site || 'N/A'}</p>
                        <p><strong>Location:</strong> ${incident.location || 'N/A'}</p>
                        <p><strong>Process:</strong> ${incident.processPath || 'N/A'}</p>
                        <p><strong>Severity:</strong> <span class="badge badge-${getSeverityClass(incident.severity)}">${incident.severity}</span></p>
                        <p><strong>Risk Score:</strong> <span class="badge badge-${getRiskClass(incident.risk)}">${incident.risk}</span></p>
                        <p><strong>Description:</strong> ${incident.initial_info_incident_description || 'No description'}</p>
                    </div>
                </div>
            `).join('');
            
            // Update pagination
            const totalPages = Math.ceil(data.length / 10);
            const pageInfo = document.getElementById('nearMissTimelinePageInfo');
            if (pageInfo) pageInfo.textContent = `Page ${currentPage} of ${totalPages || 1}`;
        }

        function changeTimelinePage(type, direction) {
            const data = type === 'injury' ? 
                state.injury.filteredData.filter(r => r.parsedDate) : 
                state.nearMiss.filteredData.filter(r => r.parsedDate);
            
            const totalPages = Math.ceil(data.length / 10);
            
            if (type === 'injury') {
                state.injury.timelinePage += direction;
                if (state.injury.timelinePage < 1) state.injury.timelinePage = 1;
                if (state.injury.timelinePage > totalPages) state.injury.timelinePage = totalPages;
                updateInjuryTimeline();
            } else {
                state.nearMiss.timelinePage += direction;
                if (state.nearMiss.timelinePage < 1) state.nearMiss.timelinePage = 1;
                if (state.nearMiss.timelinePage > totalPages) state.nearMiss.timelinePage = totalPages;
                updateNearMissTimeline();
            }
        }

        // Advanced Analytics
        function updateInjuryAdvancedAnalytics() {
            // Recordable Rate Trend
            const recordableRateChart = state.injury.charts.injuryRecordableRateTrendChart;
            if (recordableRateChart) {
                const monthlyRates = {};
                const monthlyTotals = {};
                
                state.injury.filteredData.forEach(row => {
                    if (row.parsedDate && !isNaN(row.parsedDate)) {
                        const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyTotals[monthKey]) {
                            monthlyTotals[monthKey] = 0;
                            monthlyRates[monthKey] = 0;
                        }
                        monthlyTotals[monthKey]++;
                        if (row.recordable === 1) {
                            monthlyRates[monthKey]++;
                        }
                    }
                });
                
                const sortedMonths = Object.keys(monthlyTotals).sort();
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                
                recordableRateChart.data = {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return `${monthNames[parseInt(month)-1]} ${year}`;
                    }),
                    datasets: [{
                        label: 'Recordable Rate %',
                        data: sortedMonths.map(m => 
                            monthlyTotals[m] > 0 ? ((monthlyRates[m] / monthlyTotals[m]) * 100).toFixed(1) : 0
                        ),
                        borderColor: 'rgba(255, 87, 34, 1)',
                        backgroundColor: 'rgba(255, 87, 34, 0.1)',
                        tension: 0.3
                    }]
                };
                recordableRateChart.update();
            }
            
            // Body Part Heat Map
            const bodyPartHeatMapChart = state.injury.charts.injuryBodyPartHeatMapChart;
            if (bodyPartHeatMapChart) {
                updateBodyPartHeatmapChart(bodyPartHeatMapChart, state.injury.filteredData);
            }
            
            // Root Cause by Site
            const rootCauseBySiteChart = state.injury.charts.injuryRootCauseBySiteChart;
            if (rootCauseBySiteChart) {
                const siteRootCause = {};
                state.injury.filteredData.forEach(row => {
                    const site = row.site || 'Unknown';
                    const cause = row.rootCause || 'Unknown';
                    if (!siteRootCause[site]) {
                        siteRootCause[site] = {};
                    }
                    siteRootCause[site][cause] = (siteRootCause[site][cause] || 0) + 1;
                });
                
                const sites = Object.keys(siteRootCause).sort();
                const allCauses = [...new Set(state.injury.filteredData.map(r => r.rootCause || 'Unknown'))];
                
                rootCauseBySiteChart.config.type = 'bar';
                rootCauseBySiteChart.data = {
                    labels: sites,
                    datasets: allCauses.slice(0, 5).map((cause, index) => ({
                        label: cause,
                        data: sites.map(site => siteRootCause[site][cause] || 0),
                        backgroundColor: [
                            'rgba(255, 153, 0, 0.8)',
                            'rgba(35, 47, 62, 0.8)',
                            'rgba(55, 71, 90, 0.8)',
                            'rgba(255, 87, 34, 0.8)',
                            'rgba(76, 175, 80, 0.8)'
                        ][index]
                    }))
                };
                rootCauseBySiteChart.options = getChartOptions('bar');
                rootCauseBySiteChart.options.scales.x.stacked = true;
                rootCauseBySiteChart.options.scales.y.stacked = true;
                rootCauseBySiteChart.update();
            }
            
            // DAFW Distribution
            const dafwDistributionChart = state.injury.charts.injuryDAFWDistributionChart;
            if (dafwDistributionChart) {
                updateDAFWAnalysisChart(dafwDistributionChart, state.injury.filteredData);
            }
        }

        function updateNearMissAdvancedAnalytics() {
            // Risk Trend
            const riskTrendChart = state.nearMiss.charts.nearMissRiskTrendChart;
            if (riskTrendChart) {
                updateRiskTrendChart(riskTrendChart, state.nearMiss.filteredData);
            }
            
            // Impact Analysis
            const impactAnalysisChart = state.nearMiss.charts.nearMissImpactAnalysisChart;
            if (impactAnalysisChart) {
                updateImpactBySeverityChart(impactAnalysisChart, state.nearMiss.filteredData);
            }
            
            // Location Risk
            const locationRiskChart = state.nearMiss.charts.nearMissLocationRiskChart;
            if (locationRiskChart) {
                updateLocationHeatmapChart(locationRiskChart, state.nearMiss.filteredData);
            }
            
            // Process Risk
            const processRiskChart = state.nearMiss.charts.nearMissProcessRiskChart;
            if (processRiskChart) {
                const processRisk = {};
                state.nearMiss.filteredData.forEach(row => {
                    const process = row.processPath || 'Unknown';
                    if (!processRisk[process]) {
                        processRisk[process] = { total: 0, highRisk: 0 };
                    }
                    processRisk[process].total++;
                    const risk = parseFloat(row.risk || calculateRiskScore(row));
                    if (risk >= 7) {
                        processRisk[process].highRisk++;
                    }
                });
                
                const topProcesses = Object.entries(processRisk)
                    .map(([process, data]) => ({
                        process,
                        riskRate: data.total > 0 ? ((data.highRisk / data.total) * 100).toFixed(1) : 0
                    }))
                    .sort((a, b) => b.riskRate - a.riskRate)
                    .slice(0, 10);
                
                processRiskChart.config.type = 'bar';
                processRiskChart.data = {
                    labels: topProcesses.map(p => p.process),
                    datasets: [{
                        label: 'High Risk Rate %',
                        data: topProcesses.map(p => parseFloat(p.riskRate)),
                        backgroundColor: 'rgba(255, 87, 34, 0.8)',
                        borderWidth: 1
                    }]
                };
                processRiskChart.options = getChartOptions('bar');
                processRiskChart.update();
            }
        }

        // Combined Analytics
        function updateCombinedAnalytics() {
            if (state.injury.rawData.length === 0 && state.nearMiss.rawData.length === 0) {
                return;
            }
            
            // Update metrics
            const totalEvents = state.injury.filteredData.length + state.nearMiss.filteredData.length;
            document.getElementById('combinedTotal').textContent = totalEvents;
            
            const highRiskEvents = [
                ...state.injury.filteredData.filter(r => r.severity === 'A' || r.severity === 'B'),
                ...state.nearMiss.filteredData.filter(r => r.severity === 'A' || r.severity === 'B')
            ].length;
            document.getElementById('combinedHighRisk').textContent = highRiskEvents;
            
            // Calculate trend
            const currentMonth = new Date().getMonth();
            const lastMonth = currentMonth - 1;
            const currentMonthEvents = [...state.injury.filteredData, ...state.nearMiss.filteredData]
                .filter(r => r.parsedDate && r.parsedDate.getMonth() === currentMonth).length;
            const lastMonthEvents = [...state.injury.filteredData, ...state.nearMiss.filteredData]
                .filter(r => r.parsedDate && r.parsedDate.getMonth() === lastMonth).length;
            
            const trend = lastMonthEvents > 0 ? 
                ((currentMonthEvents - lastMonthEvents) / lastMonthEvents * 100).toFixed(0) : '0';
            document.getElementById('combinedTrend').textContent = `${trend > 0 ? '+' : ''}${trend}%`;
            
            // Sites requiring focus
            const siteCounts = {};
            [...state.injury.filteredData, ...state.nearMiss.filteredData].forEach(row => {
                const site = row.site || 'Unknown';
                siteCounts[site] = (siteCounts[site] || 0) + 1;
            });
            const targetSites = Object.values(siteCounts).filter(count => count > 5).length;
            document.getElementById('combinedTargetSites').textContent = targetSites;
            
            updateCombinedRiskMatrix();
            updateCombinedCharts();
            updateCombinedInsights();
        }

        function updateCombinedRiskMatrix() {
            const allData = [...state.injury.filteredData, ...state.nearMiss.filteredData];
            updateRiskMatrix(allData, 'combinedRiskMatrix');
        }

        function updateCombinedCharts() {
            // Trend Chart
            const trendChart = Chart.getChart('combinedTrendChart');
            if (trendChart) {
                const monthlyData = {};
                
                [...state.injury.filteredData, ...state.nearMiss.filteredData].forEach(row => {
                    if (row.parsedDate && !isNaN(row.parsedDate)) {
                        const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyData[monthKey]) {
                            monthlyData[monthKey] = { injury: 0, nearMiss: 0, total: 0 };
                        }
                        monthlyData[monthKey].total++;
                        if (row.case_number) {
                            monthlyData[monthKey].injury++;
                        } else {
                            monthlyData[monthKey].nearMiss++;
                        }
                    }
                });
                
                const sortedMonths = Object.keys(monthlyData).sort();
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                
                trendChart.data = {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return `${monthNames[parseInt(month)-1]} ${year}`;
                    }),
                    datasets: [
                        {
                            label: 'Total Events',
                            data: sortedMonths.map(m => monthlyData[m].total),
                            borderColor: 'rgba(255, 153, 0, 1)',
                            backgroundColor: 'rgba(255, 153, 0, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Injuries',
                            data: sortedMonths.map(m => monthlyData[m].injury),
                            borderColor: 'rgba(255, 87, 34, 1)',
                            backgroundColor: 'rgba(255, 87, 34, 0.1)',
                            tension: 0.3
                        },
                        {
                            label: 'Near Misses',
                            data: sortedMonths.map(m => monthlyData[m].nearMiss),
                            borderColor: 'rgba(255, 193, 7, 1)',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.3
                        }
                    ]
                };
                trendChart.update();
            }
            
            // Site Chart
            const siteChart = Chart.getChart('combinedSiteChart');
            if (siteChart) {
                const siteData = {};
                
                state.injury.filteredData.forEach(row => {
                    const site = row.site || 'Unknown';
                    if (!siteData[site]) {
                        siteData[site] = { injury: 0, nearMiss: 0, highSeverity: 0 };
                    }
                    siteData[site].injury++;
                    if (row.severity === 'A' || row.severity === 'B') {
                        siteData[site].highSeverity++;
                    }
                });
                
                state.nearMiss.filteredData.forEach(row => {
                    const site = row.site || 'Unknown';
                    if (!siteData[site]) {
                        siteData[site] = { injury: 0, nearMiss: 0, highSeverity: 0 };
                    }
                    siteData[site].nearMiss++;
                    if (row.severity === 'A' || row.severity === 'B') {
                        siteData[site].highSeverity++;
                    }
                });
                
                const sites = Object.entries(siteData)
                    .sort((a, b) => (b[1].injury + b[1].nearMiss) - (a[1].injury + a[1].nearMiss))
                    .slice(0, 10);
                
                siteChart.config.type = 'bar';
                siteChart.data = {
                    labels: sites.map(([site]) => site),
                    datasets: [
                        {
                            label: 'Injuries',
                            data: sites.map(([, data]) => data.injury),
                            backgroundColor: 'rgba(255, 87, 34, 0.8)'
                        },
                        {
                            label: 'Near Misses',
                            data: sites.map(([, data]) => data.nearMiss),
                            backgroundColor: 'rgba(255, 193, 7, 0.8)'
                        },
                        {
                            label: 'High Severity',
                            data: sites.map(([, data]) => data.highSeverity),
                            backgroundColor: 'rgba(183, 28, 28, 0.8)'
                        }
                    ]
                };
                siteChart.options = getChartOptions('bar');
                siteChart.update();
            }
            
            // Severity Chart
            const severityChart = Chart.getChart('combinedSeverityChart');
            if (severityChart) {
                const severityData = {
                    injury: { A: 0, B: 0, C: 0, D: 0 },
                    nearMiss: { A: 0, B: 0, C: 0, D: 0 }
                };
                
                state.injury.filteredData.forEach(row => {
                    if (row.severity && severityData.injury[row.severity] !== undefined) {
                        severityData.injury[row.severity]++;
                    }
                });
                
                state.nearMiss.filteredData.forEach(row => {
                    if (row.severity && severityData.nearMiss[row.severity] !== undefined) {
                        severityData.nearMiss[row.severity]++;
                    }
                });
                
                severityChart.config.type = 'bar';
                severityChart.data = {
                    labels: ['Severity A', 'Severity B', 'Severity C', 'Severity D'],
                    datasets: [
                        {
                            label: 'Injuries',
                            data: ['A', 'B', 'C', 'D'].map(s => severityData.injury[s]),
                            backgroundColor: 'rgba(255, 87, 34, 0.8)'
                        },
                        {
                            label: 'Near Misses',
                            data: ['A', 'B', 'C', 'D'].map(s => severityData.nearMiss[s]),
                            backgroundColor: 'rgba(255, 193, 7, 0.8)'
                        }
                    ]
                };
                severityChart.options = getChartOptions('bar');
                severityChart.update();
            }
            
            // Prevention Effectiveness Chart
            const preventionChart = Chart.getChart('combinedPreventionChart');
            if (preventionChart) {
                // Calculate prevention ratio (near misses to injuries)
                const monthlyPrevention = {};
                
                [...state.injury.filteredData, ...state.nearMiss.filteredData].forEach(row => {
                    if (row.parsedDate && !isNaN(row.parsedDate)) {
                        const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                        if (!monthlyPrevention[monthKey]) {
                            monthlyPrevention[monthKey] = { injury: 0, nearMiss: 0 };
                        }
                        if (row.case_number) {
                            monthlyPrevention[monthKey].injury++;
                        } else {
                            monthlyPrevention[monthKey].nearMiss++;
                        }
                    }
                });
                
                const sortedMonths = Object.keys(monthlyPrevention).sort();
                const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                
                preventionChart.config.type = 'line';
                preventionChart.data = {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return `${monthNames[parseInt(month)-1]} ${year}`;
                    }),
                    datasets: [{
                        label: 'Prevention Ratio (Near Miss / Injury)',
                        data: sortedMonths.map(m => {
                            const data = monthlyPrevention[m];
                            return data.injury > 0 ? (data.nearMiss / data.injury).toFixed(1) : data.nearMiss;
                        }),
                        borderColor: 'rgba(76, 175, 80, 1)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.3
                    }]
                };
                preventionChart.options = getChartOptions('line');
                preventionChart.update();
            }
        }

        function updateCombinedInsights() {
            const insightsContainer = document.getElementById('combinedInsights');
            
            // Calculate insights
            const insights = [];
            
            // Injury to near miss ratio
            const injuryCount = state.injury.filteredData.length;
            const nearMissCount = state.nearMiss.filteredData.length;
            const ratio = injuryCount > 0 ? (nearMissCount / injuryCount).toFixed(1) : nearMissCount;
            
            insights.push({
                type: ratio > 10 ? 'positive' : ratio > 5 ? 'neutral' : 'negative',
                title: 'Near Miss to Injury Ratio',
                content: `Current ratio is ${ratio}:1. ${ratio > 10 ? 'Excellent' : ratio > 5 ? 'Good' : 'Needs improvement'} - higher ratios indicate better hazard identification before injuries occur.`
            });
            
            // Common patterns
            const commonBodyParts = {};
            const commonLocations = {};
            
            state.injury.filteredData.forEach(row => {
                if (row.bodyPart) commonBodyParts[row.bodyPart] = (commonBodyParts[row.bodyPart] || 0) + 1;
            });
            
            state.nearMiss.filteredData.forEach(row => {
                if (row.location) commonLocations[row.location] = (commonLocations[row.location] || 0) + 1;
            });
            
            const topBodyPart = Object.entries(commonBodyParts).sort((a, b) => b[1] - a[1])[0];
            const topLocation = Object.entries(commonLocations).sort((a, b) => b[1] - a[1])[0];
            
            if (topBodyPart) {
                insights.push({
                    type: 'warning',
                    title: 'Most Affected Body Part',
                    content: `"${topBodyPart[0]}" accounts for ${topBodyPart[1]} injuries. Consider targeted ergonomic improvements or PPE enhancements.`
                });
            }
            
            if (topLocation) {
                insights.push({
                    type: 'warning',
                    title: 'High-Risk Location',
                    content: `"${topLocation[0]}" has ${topLocation[1]} near miss reports. This location requires immediate safety assessment.`
                });
            }
            
            // Severity correlation
            const highSeverityInjuries = state.injury.filteredData.filter(r => r.severity === 'A' || r.severity === 'B').length;
            const highSeverityNearMisses = state.nearMiss.filteredData.filter(r => r.severity === 'A' || r.severity === 'B').length;
            
            if (highSeverityNearMisses > highSeverityInjuries * 2) {
                insights.push({
                    type: 'critical',
                    title: 'High Severity Risk',
                    content: `${highSeverityNearMisses} high-severity near misses detected. This indicates potential for serious injuries if not addressed immediately.`
                });
            }
            
            // Render insights
            insightsContainer.innerHTML = insights.map(insight => `
                <div style="padding: 1rem; margin-bottom: 1rem; background: ${
                    insight.type === 'positive' ? 'rgba(76, 175, 80, 0.1)' :
                    insight.type === 'warning' ? 'rgba(255, 193, 7, 0.1)' :
                    insight.type === 'critical' ? 'rgba(255, 87, 34, 0.1)' :
                    'rgba(33, 150, 243, 0.1)'
                }; border-radius: 8px; border-left: 4px solid ${
                    insight.type === 'positive' ? '#4CAF50' :
                    insight.type === 'warning' ? '#FFC107' :
                    insight.type === 'critical' ? '#FF5722' :
                    '#2196F3'
                };">
                    <h4 style="margin-bottom: 0.5rem;">${insight.title}</h4>
                    <p style="margin: 0;">${insight.content}</p>
                </div>
            `).join('');
        }

        // Action Items
        function updateActionItems() {
            const allData = [...state.injury.filteredData, ...state.nearMiss.filteredData];
            
            if (allData.length === 0) return;
            
            const actions = generateActionItems(allData);
            
            // Update immediate actions
            const immediateContainer = document.getElementById('immediateActions');
            immediateContainer.innerHTML = actions.immediate.map(action => `
                <li class="action-item">
                    <span class="action-icon immediate">!</span>
                    <div style="flex: 1;">
                        <strong>${action.title}</strong>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            ${action.description}
                        </p>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="markActionComplete('immediate', '${action.id}')">
                        Mark Complete
                    </button>
                </li>
            `).join('');
            
            // Update short-term actions
            const shortTermContainer = document.getElementById('shortTermActions');
            shortTermContainer.innerHTML = actions.shortTerm.map(action => `
                <li class="action-item">
                    <span class="action-icon short-term">üìÖ</span>
                    <div style="flex: 1;">
                        <strong>${action.title}</strong>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            ${action.description}
                        </p>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="markActionComplete('shortTerm', '${action.id}')">
                        Mark Complete
                    </button>
                </li>
            `).join('');
            
            // Update long-term actions
            const longTermContainer = document.getElementById('longTermActions');
            longTermContainer.innerHTML = actions.longTerm.map(action => `
                <li class="action-item">
                    <span class="action-icon long-term">üîÑ</span>
                    <div style="flex: 1;">
                        <strong>${action.title}</strong>
                        <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                            ${action.description}
                        </p>
                    </div>
                    <button class="btn btn-sm btn-outline" onclick="markActionComplete('longTerm', '${action.id}')">
                        Mark Complete
                    </button>
                </li>
            `).join('');
        }

        function generateActionItems(data) {
            const actions = {
                immediate: [],
                shortTerm: [],
                longTerm: []
            };
            
            // Analyze data for action items
            const highSeverityCount = data.filter(r => r.severity === 'A' || r.severity === 'B').length;
            const recordableCount = state.injury.filteredData.filter(r => r.recordable === 1).length;
            const otrCount = state.injury.filteredData.filter(r => r.otr === 'yes').length;
            
            // Immediate actions
            if (highSeverityCount > 5) {
                actions.immediate.push({
                    id: 'imm-1',
                    title: `Address ${highSeverityCount} high-severity incidents`,
                    description: 'Conduct immediate safety stand-down and review all A & B severity cases'
                });
            }
            
            if (recordableCount > 3) {
                actions.immediate.push({
                    id: 'imm-2',
                    title: `Review ${recordableCount} recordable cases`,
                    description: 'Ensure all OSHA reporting requirements are met and root causes are identified'
                });
            }
            
            if (otrCount > 2) {
                actions.immediate.push({
                    id: 'imm-3',
                    title: `Investigate ${otrCount} OTR incidents`,
                    description: 'Review driver safety protocols and implement immediate corrective actions'
                });
            }
            
            // Location-based actions
            const locationCounts = {};
            data.forEach(row => {
                const location = row.location || row.initial_info_location_event || 'Unknown';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });
            
            Object.entries(locationCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .forEach(([location, count], index) => {
                    if (count > 5) {
                        actions.shortTerm.push({
                            id: `st-${index + 1}`,
                            title: `Safety audit at ${location}`,
                            description: `${count} incidents reported. Conduct comprehensive safety assessment within 30 days`
                        });
                    }
                });
            
            // Process-based actions
            const processCounts = {};
            data.forEach(row => {
                const process = row.processPath || row.initial_info_process_path || 'Unknown';
                processCounts[process] = (processCounts[process] || 0) + 1;
            });
            
            Object.entries(processCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 2)
                .forEach(([process, count], index) => {
                    if (count > 3) {
                        actions.shortTerm.push({
                            id: `st-p-${index + 1}`,
                            title: `Review ${process} process`,
                            description: `${count} incidents in this process. Update SOPs and conduct training`
                        });
                    }
                });
            
            // Long-term actions
            actions.longTerm.push({
                id: 'lt-1',
                title: 'Implement predictive analytics',
                description: 'Develop machine learning models to predict high-risk situations based on historical data'
            });
            
            actions.longTerm.push({
                id: 'lt-2',
                title: 'Enhanced safety culture program',
                description: 'Launch comprehensive behavioral safety program focusing on near miss reporting'
            });
            
            if (data.length > 50) {
                actions.longTerm.push({
                    id: 'lt-3',
                    title: 'Quarterly trend analysis',
                    description: 'Establish regular review cycles for safety metrics and leading indicators'
                });
            }
            
            return actions;
        }

        function markActionComplete(type, actionId) {
            showStatus(`Action ${actionId} marked as complete`, 'success');
            // In a real application, this would update a database
            // For now, we'll just remove the item from the display
            event.target.closest('.action-item').style.opacity = '0.5';
            event.target.disabled = true;
            event.target.textContent = 'Completed';
        }

        function addNewAction() {
            // In a real application, this would open a form to add new actions
            showStatus('Action creation form would open here', 'info');
        }

        // View Details
        function viewDetails(type, id) {
            const data = type === 'injury' ? 
                state.injury.filteredData.find(r => r.case_number === id) :
                state.nearMiss.filteredData.find(r => r.incident_id === id);
            
            if (!data) return;
            
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const body = document.getElementById('modalBody');
            
            title.textContent = type === 'injury' ? 'Injury & Illness Details' : 'Near Miss Details';
            
            if (type === 'injury') {
                body.innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>Case Number:</strong> ${data.case_number}</div>
                        <div><strong>Date:</strong> ${data.incident_date || 'N/A'}</div>
                        <div><strong>Time:</strong> ${data.incident_time || 'N/A'}</div>
                        <div><strong>Site:</strong> ${data.site || 'N/A'}</div>
                        <div><strong>Body Part:</strong> ${data.bodyPart || 'N/A'}</div>
                        <div><strong>Type:</strong> ${data.type || 'N/A'}</div>
                        <div><strong>Severity:</strong> <span class="badge badge-${getSeverityClass(data.severity)}">${data.severity}</span></div>
                        <div><strong>Recordable:</strong> <span class="badge badge-${data.recordable === 1 ? 'danger' : 'success'}">${data.recordable === 1 ? 'Yes' : 'No'}</span></div>
                        <div><strong>OTR:</strong> <span class="badge badge-${data.otr === 'yes' ? 'warning' : 'info'}">${data.otr === 'yes' ? 'Yes' : 'No'}</span></div>
                        <div><strong>DAFW Days:</strong> ${data.total_dafw_days || 0}</div>
                        <div><strong>RWA Days:</strong> ${data.total_rwa_days || 0}</div>
                        <div><strong>Root Cause:</strong> ${data.rootCause || 'Under Investigation'}</div>
                        <div><strong>Contributing Factors:</strong> ${data.contributingFactor || 'N/A'}</div>
                        <div><strong>Process Path:</strong> ${data.processPath || 'N/A'}</div>
                        <div><strong>Description:</strong> ${data.initial_info_incident_description || 'No description available'}</div>
                        <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                        <div style="margin-top: 1rem;">
                            <a href="${data.austin_url}" target="_blank" class="btn btn-primary">
                                <span>üìö</span> View Austin Case Study
                            </a>
                        </div>
                    </div>
                `;
            } else {
                body.innerHTML = `
                    <div style="display: grid; gap: 1rem;">
                        <div><strong>ID:</strong> ${data.incident_id}</div>
                        <div><strong>Date:</strong> ${data.nearmiss_date || 'N/A'}</div>
                        <div><strong>Site:</strong> ${data.site || 'N/A'}</div>
                        <div><strong>Location:</strong> ${data.location || 'N/A'}</div>
                        <div><strong>Process Path:</strong> ${data.processPath || 'N/A'}</div>
                        <div><strong>Primary Impact:</strong> ${data.primaryImpact || 'N/A'}</div>
                        <div><strong>Potential Severity:</strong> <span class="badge badge-${getSeverityClass(data.severity)}">${data.severity}</span></div>
                        <div><strong>Likelihood:</strong> <span class="badge badge-info">${data.standardized_likelihood || 'N/A'}</span></div>
                        <div><strong>Risk Score:</strong> <span class="badge badge-${getRiskClass(data.risk)}">${data.risk || 'N/A'}</span></div>
                        <div><strong>Contributing Factors:</strong> ${data.contributingFactor || 'N/A'}</div>
                        <div><strong>Description:</strong> ${data.initial_info_incident_description || 'No description available'}</div>
                        <div><strong>Root Cause:</strong> ${data.rca_primary_cause || 'Under investigation'}</div>
                        <div><strong>Status:</strong> ${data.status || 'N/A'}</div>
                    </div>
                `;
            }
            
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
        }

        // Export Functions
        function exportInjuryData() {
            exportToExcel('injury');
        }

        function exportNearMissData() {
            exportToExcel('nearmiss');
        }

        function exportToExcel(type = 'all') {
            try {
                const wb = XLSX.utils.book_new();
                
                if (type === 'injury' || type === 'all') {
                    if (state.injury.filteredData.length > 0) {
                        const ws1 = XLSX.utils.json_to_sheet(state.injury.filteredData);
                        XLSX.utils.book_append_sheet(wb, ws1, "Injury Data");
                        
                        // Add summary sheet
                        const injurySummary = createInjurySummarySheet();
                        const ws1Summary = XLSX.utils.aoa_to_sheet(injurySummary);
                        XLSX.utils.book_append_sheet(wb, ws1Summary, "Injury Summary");
                    }
                }
                
                if (type === 'nearmiss' || type === 'all') {
                    if (state.nearMiss.filteredData.length > 0) {
                        const ws2 = XLSX.utils.json_to_sheet(state.nearMiss.filteredData);
                        XLSX.utils.book_append_sheet(wb, ws2, "Near Miss Data");
                        
                        // Add summary sheet
                        const nearMissSummary = createNearMissSummarySheet();
                        const ws2Summary = XLSX.utils.aoa_to_sheet(nearMissSummary);
                        XLSX.utils.book_append_sheet(wb, ws2Summary, "Near Miss Summary");
                    }
                }
                
                if ((type === 'injury' && state.injury.filteredData.length === 0) ||
                    (type === 'nearmiss' && state.nearMiss.filteredData.length === 0) ||
                    (type === 'all' && state.injury.filteredData.length === 0 && state.nearMiss.filteredData.length === 0)) {
                    showStatus('No data to export', 'error');
                    return;
                }
                
                const filename = type === 'all' ? 
                    `safety_analysis_complete_${new Date().toISOString().split('T')[0]}.xlsx` :
                    `${type}_analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
                
                XLSX.writeFile(wb, filename);
                showStatus('Data exported successfully!', 'success');
            } catch (error) {
                console.error('Export error:', error);
                showStatus('Error exporting data: ' + error.message, 'error');
            }
        }

        function createInjurySummarySheet() {
            const data = state.injury.filteredData;
            const recordableCount = data.filter(r => r.recordable === 1).length;
            const lostTimeCount = data.filter(r => r.total_dafw_days > 0).length;
            const totalDaysLost = data.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
            const otrCount = data.filter(r => r.otr === 'yes').length;
            
            return [
                ['Injury & Illness Analysis Summary'],
                ['Generated on:', new Date().toLocaleString()],
                ['Report by:', 'Erwin Esener - Amazon WHS Austria'],
                [''],
                ['Key Metrics:'],
                ['Total Incidents:', data.length],
                ['Recordable Cases:', recordableCount],
                ['Lost Time Cases:', lostTimeCount],
                ['Total Days Lost (DAFW):', totalDaysLost],
                ['OTR Incidents:', otrCount],
                [''],
                ['Severity Distribution:'],
                ['A - Critical:', data.filter(r => r.severity === 'A').length],
                ['B - High:', data.filter(r => r.severity === 'B').length],
                ['C - Medium:', data.filter(r => r.severity === 'C').length],
                ['D - Low:', data.filter(r => r.severity === 'D').length],
                [''],
                ['Top Body Parts Affected:'],
                ...getTopItems(data, 'bodyPart', 5).map(([part, count]) => [part, count]),
                [''],
                ['Top Root Causes:'],
                ...getTopItems(data, 'rootCause', 5).map(([cause, count]) => [cause, count])
            ];
        }

        function createNearMissSummarySheet() {
            const data = state.nearMiss.filteredData;
            const highSeverityCount = data.filter(r => r.severity === 'A' || r.severity === 'B').length;
            const avgRisk = data.length > 0 ? 
                (data.reduce((sum, r) => sum + parseFloat(r.risk || 0), 0) / data.length).toFixed(1) : 0;
            
            return [
                ['Near Miss Analysis Summary'],
                ['Generated on:', new Date().toLocaleString()],
                ['Report by:', 'Erwin Esener - Amazon WHS Austria'],
                [''],
                ['Key Metrics:'],
                ['Total Near Misses:', data.length],
                ['High Severity Cases (A & B):', highSeverityCount],
                ['Average Risk Score:', avgRisk],
                [''],
                ['Severity Distribution:'],
                ['A - Critical:', data.filter(r => r.severity === 'A').length],
                ['B - High:', data.filter(r => r.severity === 'B').length],
                ['C - Medium:', data.filter(r => r.severity === 'C').length],
                ['D - Low:', data.filter(r => r.severity === 'D').length],
                [''],
                ['Top Locations:'],
                ...getTopItems(data, 'location', 5).map(([location, count]) => [location, count]),
                [''],
                ['Top Process Paths:'],
                ...getTopItems(data, 'processPath', 5).map(([process, count]) => [process, count])
            ];
        }

        function getTopItems(data, field, limit = 5) {
            const counts = {};
            data.forEach(row => {
                const value = row[field] || 'Unknown';
                counts[value] = (counts[value] || 0) + 1;
            });
            
            return Object.entries(counts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, limit);
        }

        // Export Table
        function exportTable(type) {
            const tableId = type === 'injury' ? 'injuryTable' : 'nearMissTable';
            const table = document.getElementById(tableId);
            
            if (!table) {
                showStatus('Table not found', 'error');
                return;
            }
            
            try {
                const wb = XLSX.utils.table_to_book(table);
                XLSX.writeFile(wb, `${type}_table_export_${new Date().toISOString().split('T')[0]}.xlsx`);
                showStatus('Table exported successfully!', 'success');
            } catch (error) {
                console.error('Table export error:', error);
                showStatus('Error exporting table: ' + error.message, 'error');
            }
        }

        // Export Chart
        function exportChart(chartId) {
            const chart = Chart.getChart(chartId);
            if (!chart) {
                showStatus('Chart not found', 'error');
                return;
            }
            
            const url = chart.toBase64Image();
            const link = document.createElement('a');
            link.download = `${chartId}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = url;
            link.click();
            
            showStatus('Chart exported successfully!', 'success');
        }

        // Export Dashboard
        function exportDashboard() {
            showStatus('Capturing dashboard...', 'info');
            
            const dashboardElement = document.querySelector('.container');
            if (!dashboardElement) {
                showStatus('Dashboard element not found', 'error');
                return;
            }
            
            html2canvas(dashboardElement, {
                scale: 2,
                useCORS: true,
                logging: false
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `safety_dashboard_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL();
                link.click();
                showStatus('Dashboard exported as image!', 'success');
            }).catch(error => {
                console.error('Dashboard export error:', error);
                showStatus('Error exporting dashboard: ' + error.message, 'error');
            });
        }

        // Generate PDF Report
        function generatePDFReport(type) {
            showStatus('Generating professional PDF report...', 'info');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a4'
                });
                
                // Set up fonts and colors
                const pageWidth = 210;
                const pageHeight = 297;
                const margin = 20;
                const contentWidth = pageWidth - (margin * 2);
                
                // Amazon colors
                const amazonOrange = [255, 153, 0];
                const amazonDark = [35, 47, 62];
                const amazonGray = [55, 71, 90];
                
                // Helper functions
                const addHeader = (pageNum) => {
                    // Header background
                    doc.setFillColor(...amazonOrange);
                    doc.rect(0, 0, pageWidth, 30, 'F');
                    
                    // Amazon logo area
                    doc.setFillColor(...amazonDark);
                    doc.rect(0, 0, 60, 30, 'F');
                    
                    // Title
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text('Safety Analytics Report', pageWidth / 2, 15, { align: 'center' });
                    
                    // Subtitle
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'normal');
                    doc.text('Amazon WHS Austria', pageWidth / 2, 22, { align: 'center' });
                    
                    // Page number
                    doc.setFontSize(10);
                    doc.text(`Page ${pageNum}`, pageWidth - margin, 25, { align: 'right' });
                };
                
                const addFooter = () => {
                    doc.setFillColor(...amazonDark);
                    doc.rect(0, pageHeight - 15, pageWidth, 15, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.text('¬© 2024 Amazon.com, Inc. - Confidential', margin, pageHeight - 8);
                    doc.text('Developed by Erwin Esener', pageWidth - margin, pageHeight - 8, { align: 'right' });
                };
                
                const addSectionHeader = (title, yPos) => {
                    doc.setFillColor(...amazonOrange);
                    doc.rect(margin - 5, yPos - 8, contentWidth + 10, 12, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(title, margin, yPos);
                    return yPos + 10;
                };
                
                const addMetricBox = (x, y, width, height, label, value, color = amazonOrange) => {
                    // Box background
                    doc.setFillColor(250, 250, 250);
                    doc.setDrawColor(200, 200, 200);
                    doc.rect(x, y, width, height, 'FD');
                    
                    // Color accent
                    doc.setFillColor(...color);
                    doc.rect(x, y, width, 4, 'F');
                    
                    // Value
                    doc.setTextColor(...amazonDark);
                    doc.setFontSize(24);
                    doc.setFont(undefined, 'bold');
                    doc.text(value.toString(), x + width/2, y + height/2, { align: 'center' });
                    
                    // Label
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...amazonGray);
                    doc.text(label, x + width/2, y + height - 5, { align: 'center' });
                };
                
                let currentPage = 1;
                let yPos = 40;
                
                // Page 1 - Executive Summary
                addHeader(currentPage);
                
                // Report info
                doc.setTextColor(...amazonDark);
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Report Generated: ${new Date().toLocaleString('en-GB')}`, margin, yPos);
                doc.text(`Report Type: ${type.charAt(0).toUpperCase() + type.slice(1)} Safety Analysis`, margin, yPos + 6);
                doc.text(`Period: ${getReportPeriod()}`, margin, yPos + 12);
                
                yPos = 65;
                
                // Executive Summary
                yPos = addSectionHeader('Executive Summary', yPos);
                
                doc.setFillColor(255, 249, 240);
                doc.setDrawColor(...amazonOrange);
                doc.setLineWidth(0.5);
                doc.rect(margin, yPos, contentWidth, 60, 'FD');
                
                doc.setTextColor(...amazonDark);
                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                
                let summaryText = '';
                if (type === 'injury' || type === 'combined') {
                    const injuryData = state.injury.filteredData;
                    const recordableCount = injuryData.filter(r => r.recordable === 1).length;
                    const lostTimeCount = injuryData.filter(r => r.total_dafw_days > 0).length;
                    const totalDaysLost = injuryData.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0);
                    
                    summaryText = `Injury & Illness Analysis:\n`;
                    summaryText += `‚Ä¢ Total Incidents: ${injuryData.length}\n`;
                    summaryText += `‚Ä¢ Recordable Cases: ${recordableCount} (${((recordableCount/injuryData.length)*100).toFixed(1)}%)\n`;
                    summaryText += `‚Ä¢ Lost Time Cases: ${lostTimeCount} with ${totalDaysLost} total days lost\n`;
                    summaryText += `‚Ä¢ Key Finding: ${getKeyFinding(injuryData, 'injury')}`;
                }
                
                if (type === 'nearmiss' || type === 'combined') {
                    if (summaryText) summaryText += '\n\n';
                    const nearMissData = state.nearMiss.filteredData;
                    const highRiskCount = nearMissData.filter(r => r.severity === 'A' || r.severity === 'B').length;
                    
                    summaryText += `Near Miss Analysis:\n`;
                    summaryText += `‚Ä¢ Total Near Misses: ${nearMissData.length}\n`;
                    summaryText += `‚Ä¢ High Risk Events: ${highRiskCount} (Severity A & B)\n`;
                    summaryText += `‚Ä¢ Key Finding: ${getKeyFinding(nearMissData, 'nearmiss')}`;
                }
                
                const lines = doc.splitTextToSize(summaryText, contentWidth - 10);
                doc.text(lines, margin + 5, yPos + 8);
                
                yPos += 70;
                
                // Key Metrics Dashboard
                yPos = addSectionHeader('Key Performance Indicators', yPos);
                
                const metricsY = yPos + 5;
                const boxWidth = 40;
                const boxHeight = 30;
                const boxGap = 5;
                
                if (type === 'injury' || type === 'combined') {
                    const injuryData = state.injury.filteredData;
                    const metrics = [
                        { label: 'Total Cases', value: injuryData.length, color: amazonDark },
                        { label: 'Recordable', value: injuryData.filter(r => r.recordable === 1).length, color: [255, 87, 34] },
                        { label: 'Lost Time', value: injuryData.filter(r => r.total_dafw_days > 0).length, color: [183, 28, 28] },
                        { label: 'Days Lost', value: injuryData.reduce((sum, r) => sum + (r.total_dafw_days || 0), 0), color: amazonOrange }
                    ];
                    
                    metrics.forEach((metric, index) => {
                        const x = margin + (index * (boxWidth + boxGap));
                        addMetricBox(x, metricsY, boxWidth, boxHeight, metric.label, metric.value, metric.color);
                    });
                }
                
                yPos = metricsY + boxHeight + 15;
                
                // Severity Distribution
                yPos = addSectionHeader('Severity Distribution Analysis', yPos);
                
                const allData = type === 'injury' ? state.injury.filteredData :
                              type === 'nearmiss' ? state.nearMiss.filteredData :
                              [...state.injury.filteredData, ...state.nearMiss.filteredData];
                
                const severityData = {
                    'A - Critical': allData.filter(r => r.severity === 'A').length,
                    'B - High': allData.filter(r => r.severity === 'B').length,
                    'C - Medium': allData.filter(r => r.severity === 'C').length,
                    'D - Low': allData.filter(r => r.severity === 'D').length
                };
                
                const maxSeverity = Math.max(...Object.values(severityData));
                const barHeight = 10;
                
                Object.entries(severityData).forEach(([severity, count], index) => {
                    const barY = yPos + (index * (barHeight + 5));
                    const barWidth = maxSeverity > 0 ? (count / maxSeverity) * 120 : 0;
                    const percentage = allData.length > 0 ? ((count / allData.length) * 100).toFixed(1) : '0';
                    
                    // Label
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(...amazonDark);
                    doc.text(severity, margin, barY + 7);
                    
                    // Bar
                    const colors = {
                        'A - Critical': [183, 28, 28],
                        'B - High': [255, 87, 34],
                        'C - Medium': [255, 193, 7],
                        'D - Low': [76, 175, 80]
                    };
                    doc.setFillColor(...colors[severity]);
                    doc.rect(margin + 30, barY, barWidth, barHeight, 'F');
                    
                    // Value
                    doc.setTextColor(...amazonGray);
                    doc.text(`${count} (${percentage}%)`, margin + 155, barY + 7);
                });
                
                yPos += (4 * (barHeight + 5)) + 10;
                
                // Add footer
                addFooter();
                
                // Page 2 - Detailed Analysis
                if (type === 'injury' || type === 'combined') {
                    doc.addPage();
                    currentPage++;
                    addHeader(currentPage);
                    yPos = 40;
                    
                    yPos = addSectionHeader('Injury & Illness Detailed Analysis', yPos);
                    
                    // Top affected body parts table
                    const bodyPartCounts = {};
                    state.injury.filteredData.forEach(row => {
                        const part = row.bodyPart || 'Unknown';
                        bodyPartCounts[part] = (bodyPartCounts[part] || 0) + 1;
                    });
                    
                    const topBodyParts = Object.entries(bodyPartCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Body Part', 'Incidents', 'Percentage', 'Severity']],
                        body: topBodyParts.map(([part, count]) => [
                            part.substring(0, 40) + (part.length > 40 ? '...' : ''),
                            count,
                            ((count / state.injury.filteredData.length) * 100).toFixed(1) + '%',
                            getAverageSeverity(state.injury.filteredData.filter(r => r.bodyPart === part))
                        ]),
                        theme: 'grid',
                        headStyles: { fillColor: amazonDark },
                        margin: { left: margin, right: margin }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                    
                    // Root causes
                    yPos = addSectionHeader('Root Cause Analysis', yPos);
                    
                    const rootCauseCounts = {};
                    state.injury.filteredData.forEach(row => {
                        const cause = row.rootCause || 'Under Investigation';
                        rootCauseCounts[cause] = (rootCauseCounts[cause] || 0) + 1;
                    });
                    
                    const topCauses = Object.entries(rootCauseCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 6);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Root Cause', 'Count', 'Percentage']],
                        body: topCauses.map(([cause, count]) => [
                            cause.substring(0, 50) + (cause.length > 50 ? '...' : ''),
                            count,
                            ((count / state.injury.filteredData.length) * 100).toFixed(1) + '%'
                        ]),
                        theme: 'grid',
                        headStyles: { fillColor: amazonDark },
                        margin: { left: margin, right: margin }
                    });
                    
                    addFooter();
                }
                
                // Page 3 - Near Miss Analysis
                if (type === 'nearmiss' || type === 'combined') {
                    doc.addPage();
                    currentPage++;
                    addHeader(currentPage);
                    yPos = 40;
                    
                    yPos = addSectionHeader('Near Miss Detailed Analysis', yPos);
                    
                    // Top locations
                    const locationCounts = {};
                    state.nearMiss.filteredData.forEach(row => {
                        const location = row.location || 'Unknown';
                        locationCounts[location] = (locationCounts[location] || 0) + 1;
                    });
                    
                    const topLocations = Object.entries(locationCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Location', 'Incidents', 'Avg Risk Score']],
                        body: topLocations.map(([location, count]) => {
                            const locationData = state.nearMiss.filteredData.filter(r => r.location === location);
                            const avgRisk = locationData.reduce((sum, r) => sum + parseFloat(r.risk || 0), 0) / locationData.length;
                            return [
                                location.substring(0, 50) + (location.length > 50 ? '...' : ''),
                                count,
                                avgRisk.toFixed(1)
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: amazonDark },
                        margin: { left: margin, right: margin }
                    });
                    
                    yPos = doc.lastAutoTable.finalY + 10;
                    
                    // Process paths
                    yPos = addSectionHeader('Process Path Analysis', yPos);
                    
                    const processCounts = {};
                    state.nearMiss.filteredData.forEach(row => {
                        const process = row.processPath || 'Unknown';
                        processCounts[process] = (processCounts[process] || 0) + 1;
                    });
                    
                    const topProcesses = Object.entries(processCounts)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 5);
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Process Path', 'Near Misses', 'High Risk %']],
                        body: topProcesses.map(([process, count]) => {
                            const processData = state.nearMiss.filteredData.filter(r => r.processPath === process);
                            const highRisk = processData.filter(r => parseFloat(r.risk) >= 7).length;
                            return [
                                process,
                                count,
                                ((highRisk / count) * 100).toFixed(1) + '%'
                            ];
                        }),
                        theme: 'grid',
                        headStyles: { fillColor: amazonDark },
                        margin: { left: margin, right: margin }
                    });
                    
                    addFooter();
                }
                
                // Page 4 - Recommendations
                doc.addPage();
                currentPage++;
                addHeader(currentPage);
                yPos = 40;
                
                yPos = addSectionHeader('Recommendations & Action Plan', yPos);
                
                const allDataForActions = type === 'injury' ? state.injury.filteredData :
                                        type === 'nearmiss' ? state.nearMiss.filteredData :
                                        [...state.injury.filteredData, ...state.nearMiss.filteredData];
                
                const actions = generateActionItems(allDataForActions);
                
                // Immediate Actions
                doc.setFillColor(255, 249, 240);
                doc.setDrawColor(255, 87, 34);
                doc.setLineWidth(0.5);
                doc.rect(margin, yPos, contentWidth, 40, 'FD');
                
                doc.setTextColor(255, 87, 34);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Immediate Actions Required', margin + 5, yPos + 8);
                
                doc.setTextColor(...amazonDark);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const immediateText = actions.immediate.slice(0, 3).map((action, i) => 
                    `${i + 1}. ${action.title}: ${action.description}`
                ).join('\n');
                
                const immediateLines = doc.splitTextToSize(immediateText || 'No immediate actions required', contentWidth - 10);
                doc.text(immediateLines, margin + 5, yPos + 15);
                
                yPos += 45;
                
                // Short-term Actions
                doc.setFillColor(255, 252, 240);
                doc.setDrawColor(255, 193, 7);
                doc.rect(margin, yPos, contentWidth, 40, 'FD');
                
                doc.setTextColor(255, 152, 0);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Short-term Actions (30 days)', margin + 5, yPos + 8);
                
                doc.setTextColor(...amazonDark);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const shortTermText = actions.shortTerm.slice(0, 3).map((action, i) => 
                    `${i + 1}. ${action.title}: ${action.description}`
                ).join('\n');
                
                const shortTermLines = doc.splitTextToSize(shortTermText || 'No short-term actions identified', contentWidth - 10);
                doc.text(shortTermLines, margin + 5, yPos + 15);
                
                yPos += 45;
                
                // Long-term Improvements
                doc.setFillColor(240, 248, 255);
                doc.setDrawColor(33, 150, 243);
                doc.rect(margin, yPos, contentWidth, 40, 'FD');
                
                doc.setTextColor(33, 150, 243);
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('Long-term Improvements', margin + 5, yPos + 8);
                
                doc.setTextColor(...amazonDark);
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                
                const longTermText = actions.longTerm.slice(0, 3).map((action, i) => 
                    `${i + 1}. ${action.title}: ${action.description}`
                ).join('\n');
                
                const longTermLines = doc.splitTextToSize(longTermText || 'No long-term improvements identified', contentWidth - 10);
                doc.text(longTermLines, margin + 5, yPos + 15);
                
                yPos += 45;
                
                // Risk Matrix Summary
                yPos = addSectionHeader('Risk Matrix Summary', yPos);
                
                const riskSummary = calculateRiskMatrixSummary(allDataForActions);
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Risk Level', 'Count', 'Percentage', 'Action Priority']],
                    body: [
                        ['Critical (16-25)', riskSummary.critical, `${riskSummary.criticalPercent}%`, 'Immediate'],
                        ['High (11-15)', riskSummary.high, `${riskSummary.highPercent}%`, 'Within 7 days'],
                        ['Medium (6-10)', riskSummary.medium, `${riskSummary.mediumPercent}%`, 'Within 30 days'],
                        ['Low (1-5)', riskSummary.low, `${riskSummary.lowPercent}%`, 'Routine']
                    ],
                    theme: 'grid',
                    headStyles: { fillColor: amazonDark },
                    bodyStyles: { cellPadding: 3 },
                    columnStyles: {
                        0: { cellWidth: 40 },
                        1: { cellWidth: 30, halign: 'center' },
                        2: { cellWidth: 35, halign: 'center' },
                        3: { cellWidth: 65 }
                    },
                    margin: { left: margin, right: margin }
                });
                
                addFooter();
                
                // Executive Summary Page (if requested)
                if (type === 'executive') {
                    doc.addPage();
                    currentPage++;
                    addHeader(currentPage);
                    yPos = 40;
                    
                    yPos = addSectionHeader('Executive Summary Dashboard', yPos);
                    
                    // Create executive metrics
                    const execMetrics = calculateExecutiveMetrics();
                    
                    // Monthly trend summary
                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, yPos, contentWidth, 50, 'F');
                    
                    doc.setTextColor(...amazonDark);
                    doc.setFontSize(11);
                    const trendText = `Safety Performance Trend:\n`;
                    const trendAnalysis = analyzeTrend(execMetrics);
                    const trendLines = doc.splitTextToSize(trendText + trendAnalysis, contentWidth - 10);
                    doc.text(trendLines, margin + 5, yPos + 8);
                    
                    yPos += 60;
                    
                    // Site ranking
                    yPos = addSectionHeader('Site Performance Ranking', yPos);
                    
                    const siteRanking = calculateSiteRanking();
                    
                    doc.autoTable({
                        startY: yPos,
                        head: [['Rank', 'Site', 'Total Incidents', 'Risk Score', 'Status']],
                        body: siteRanking.slice(0, 5).map((site, index) => [
                            index + 1,
                            site.name,
                            site.incidents,
                            site.riskScore.toFixed(1),
                            site.status
                        ]),
                        theme: 'grid',
                        headStyles: { fillColor: amazonDark },
                        bodyStyles: { cellPadding: 3 },
                        margin: { left: margin, right: margin }
                    });
                    
                    addFooter();
                }
                
                // Save the PDF
                const fileName = `${type}_safety_report_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showStatus('Professional PDF report generated successfully!', 'success');
                
                // Add to report history
                addToReportHistory(type, fileName);
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showStatus('Error generating PDF: ' + error.message, 'error');
            }
        }

        function getReportPeriod() {
            const allData = [...state.injury.filteredData, ...state.nearMiss.filteredData];
            if (allData.length === 0) return 'No data available';
            
            const dates = allData
                .map(r => r.parsedDate)
                .filter(d => d && !isNaN(d))
                .sort((a, b) => a - b);
            
            if (dates.length === 0) return 'Date range not available';
            
            const startDate = dates[0].toLocaleDateString('en-GB');
            const endDate = dates[dates.length - 1].toLocaleDateString('en-GB');
            
            return `${startDate} - ${endDate}`;
        }

        function getKeyFinding(data, type) {
            if (data.length === 0) return 'No data available for analysis';
            
            if (type === 'injury') {
                const severityA = data.filter(r => r.severity === 'A').length;
                const recordable = data.filter(r => r.recordable === 1).length;
                const recordableRate = ((recordable / data.length) * 100).toFixed(1);
                
                if (severityA > 0) {
                    return `${severityA} critical severity incidents require immediate attention`;
                }
                if (recordableRate > 50) {
                    return `High recordable rate (${recordableRate}%) indicates need for enhanced safety measures`;
                }
                return `Stable safety performance with ${data.length} total incidents`;
            } else {
                const highRisk = data.filter(r => parseFloat(r.risk) >= 7).length;
                const repeatLocations = {};
                data.forEach(r => {
                    repeatLocations[r.location] = (repeatLocations[r.location] || 0) + 1;
                });
                const hotspots = Object.values(repeatLocations).filter(count => count >= 3).length;
                
                if (highRisk > 5) {
                    return `${highRisk} high-risk near misses indicate potential for serious incidents`;
                }
                if (hotspots > 0) {
                    return `${hotspots} locations with repeated near misses require targeted interventions`;
                }
                return `Good hazard identification with ${data.length} near misses reported`;
            }
        }

        function getAverageSeverity(data) {
            const severityMap = { 'A': 4, 'B': 3, 'C': 2, 'D': 1 };
            const severitySum = data.reduce((sum, r) => sum + (severityMap[r.severity] || 0), 0);
            const avgValue = data.length > 0 ? severitySum / data.length : 0;
            
            if (avgValue >= 3.5) return 'Critical';
            if (avgValue >= 2.5) return 'High';
            if (avgValue >= 1.5) return 'Medium';
            return 'Low';
        }

        function calculateRiskMatrixSummary(data) {
            const riskScores = data.map(r => {
                if (r.risk) return parseFloat(r.risk) * 2.5; // Scale to 25
                const severityMap = { 'A': 5, 'B': 4, 'C': 3, 'D': 2, 'Unknown': 1 };
                const likelihoodMap = { 
                    'Rare': 1, 
                    'Unlikely': 2, 
                    'Possible': 3, 
                    'Likely': 4, 
                    'Almost Certain': 5 
                };
                const severity = severityMap[r.severity] || 1;
                const likelihood = likelihoodMap[r.standardized_likelihood] || 3;
                return severity * likelihood;
            });
            
            const critical = riskScores.filter(s => s >= 16).length;
            const high = riskScores.filter(s => s >= 11 && s < 16).length;
            const medium = riskScores.filter(s => s >= 6 && s < 11).length;
            const low = riskScores.filter(s => s < 6).length;
            const total = riskScores.length || 1;
            
            return {
                critical,
                high,
                medium,
                low,
                criticalPercent: ((critical / total) * 100).toFixed(1),
                highPercent: ((high / total) * 100).toFixed(1),
                mediumPercent: ((medium / total) * 100).toFixed(1),
                lowPercent: ((low / total) * 100).toFixed(1)
            };
        }

        function calculateExecutiveMetrics() {
            const allData = [...state.injury.filteredData, ...state.nearMiss.filteredData];
            const monthlyData = {};
            
            allData.forEach(row => {
                if (row.parsedDate && !isNaN(row.parsedDate)) {
                    const monthKey = `${row.parsedDate.getFullYear()}-${String(row.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            total: 0,
                            injury: 0,
                            nearMiss: 0,
                            recordable: 0,
                            highSeverity: 0
                        };
                    }
                    monthlyData[monthKey].total++;
                    if (row.case_number) {
                        monthlyData[monthKey].injury++;
                        if (row.recordable === 1) monthlyData[monthKey].recordable++;
                    } else {
                        monthlyData[monthKey].nearMiss++;
                    }
                    if (row.severity === 'A' || row.severity === 'B') {
                        monthlyData[monthKey].highSeverity++;
                    }
                }
            });
            
            return monthlyData;
        }

        function analyzeTrend(monthlyData) {
            const months = Object.keys(monthlyData).sort();
            if (months.length < 2) return 'Insufficient data for trend analysis';
            
            const recent = months.slice(-3);
            const older = months.slice(-6, -3);
            
            const recentAvg = recent.reduce((sum, m) => sum + monthlyData[m].total, 0) / recent.length;
            const olderAvg = older.length > 0 ? 
                older.reduce((sum, m) => sum + monthlyData[m].total, 0) / older.length : 
                recentAvg;
            
            const trend = ((recentAvg - olderAvg) / olderAvg * 100).toFixed(0);
            
            let analysis = `Recent 3-month average: ${recentAvg.toFixed(1)} incidents/month\n`;
            
            if (trend > 10) {
                analysis += `‚ö†Ô∏è Upward trend of ${trend}% - Enhanced safety measures recommended`;
            } else if (trend < -10) {
                analysis += `‚úÖ Downward trend of ${Math.abs(trend)}% - Safety improvements showing results`;
            } else {
                analysis += `‚û°Ô∏è Stable trend (${trend > 0 ? '+' : ''}${trend}%) - Maintain current safety protocols`;
            }
            
            return analysis;
        }

        function calculateSiteRanking() {
            const siteData = {};
            
            [...state.injury.filteredData, ...state.nearMiss.filteredData].forEach(row => {
                const site = row.site || 'Unknown';
                if (!siteData[site]) {
                    siteData[site] = {
                        name: site,
                        incidents: 0,
                        injuries: 0,
                        nearMisses: 0,
                        highSeverity: 0,
                        totalRisk: 0
                    };
                }
                
                siteData[site].incidents++;
                if (row.case_number) {
                    siteData[site].injuries++;
                } else {
                    siteData[site].nearMisses++;
                }
                
                if (row.severity === 'A' || row.severity === 'B') {
                    siteData[site].highSeverity++;
                }
                
                const risk = row.risk ? parseFloat(row.risk) : calculateRiskScore(row);
                siteData[site].totalRisk += parseFloat(risk);
            });
            
            return Object.values(siteData)
                .map(site => ({
                    ...site,
                    riskScore: site.incidents > 0 ? site.totalRisk / site.incidents : 0,
                    status: site.highSeverity > 2 ? 'üî¥ Critical' : 
                           site.highSeverity > 0 ? 'üü° Warning' : 
                           'üü¢ Good'
                }))
                .sort((a, b) => b.riskScore - a.riskScore);
        }

        function addToReportHistory(type, fileName) {
            const historyContainer = document.getElementById('reportHistory');
            if (!historyContainer) return;
            
            const timestamp = new Date().toLocaleString();
            const reportEntry = `
                <div style="padding: 1rem; border-bottom: 1px solid var(--bg-secondary);">
                    <strong>${fileName}</strong><br>
                    <span style="color: var(--text-secondary); font-size: 0.9rem;">
                        Type: ${type.charAt(0).toUpperCase() + type.slice(1)} | Generated: ${timestamp}
                    </span>
                </div>
            `;
            
            if (historyContainer.innerHTML.includes('No reports generated yet')) {
                historyContainer.innerHTML = reportEntry;
            } else {
                historyContainer.innerHTML = reportEntry + historyContainer.innerHTML;
            }
        }

        // Load Sample Data
        function loadSampleData() {
            showStatus('Loading sample data...', 'info');
            
            // Sample injury data
            const sampleInjuryData = generateSampleInjuryData();
            state.injury.rawData = sampleInjuryData;
            processInjuryData();
            populateInjuryFilters();
            applyFilters('injury');
            
            // Sample near miss data
            const sampleNearMissData = generateSampleNearMissData();
            state.nearMiss.rawData = sampleNearMissData;
            processNearMissData();
            populateNearMissFilters();
            applyFilters('nearmiss');
            
            updateOverview();
            showStatus('Sample data loaded successfully!', 'success');
        }

        function generateSampleInjuryData() {
            const sites = ['VIE1', 'VIE2', 'VIE3', 'VIE4', 'VIE5'];
            const bodyParts = ['Back', 'Hand', 'Shoulder', 'Knee', 'Ankle', 'Wrist', 'Finger', 'Eye'];
            const types = ['Strain/Sprain', 'Cut/Laceration', 'Contusion', 'Fracture', 'Burn'];
            const severities = ['A', 'B', 'C', 'D'];
            const rootCauses = ['Manual Handling', 'Slip/Trip/Fall', 'Equipment Malfunction', 'Ergonomic', 'Process Deviation'];
            const processes = ['Stow', 'Pick', 'Pack', 'Receive', 'Ship', 'ICQA'];
            
            const data = [];
            const startDate = new Date('2024-01-01');
            
            for (let i = 0; i < 50; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + Math.floor(Math.random() * 365));
                
                const severity = severities[Math.floor(Math.random() * severities.length)];
                const isRecordable = severity === 'A' || severity === 'B' || Math.random() > 0.7;
                const dafwDays = isRecordable && Math.random() > 0.5 ? Math.floor(Math.random() * 30) : 0;
                
                data.push({
                    case_number: `CASE-2024-${String(i + 1).padStart(3, '0')}`,
                    incident_date: date.toISOString().split('T')[0],
                    incident_time: `${Math.floor(Math.random() * 24).toString().padStart(2, '0')}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`,
                    site: sites[Math.floor(Math.random() * sites.length)],
                    initial_info_principal_body_part: bodyParts[Math.floor(Math.random() * bodyParts.length)],
                    type: types[Math.floor(Math.random() * types.length)],
                    severity: severity,
                    potential_severity: severity,
                    recordable: isRecordable ? 1 : 0,
                    initial_info_incident_on_the_road: Math.random() > 0.9,
                    total_dafw_days: dafwDays,
                    total_rwa_days: isRecordable && Math.random() > 0.8 ? Math.floor(Math.random() * 10) : 0,
                    rca_primary_cause: rootCauses[Math.floor(Math.random() * rootCauses.length)],
                    rca_contributing_factor_category: 'Human Factors',
                    initial_info_process_path: processes[Math.floor(Math.random() * processes.length)],
                    initial_info_incident_description: 'Sample incident description for demonstration purposes',
                    status: 'Closed',
                    austin_url: DEFAULT_AUSTIN_URL
                });
            }
            
            return data;
        }

        function generateSampleNearMissData() {
            const sites = ['VIE1', 'VIE2', 'VIE3', 'VIE4', 'VIE5'];
            const locations = ['Dock Door 1', 'Aisle P-1-A', 'Break Room', 'Parking Lot', 'Conveyor Belt 3', 'Mezzanine Level 2'];
            const impacts = ['Struck By', 'Caught Between', 'Fall', 'Ergonomic', 'Environmental'];
            const severities = ['A', 'B', 'C', 'D'];
            const likelihoods = ['Rare', 'Unlikely', 'Possible', 'Likely', 'Almost Certain'];
            const processes = ['Stow', 'Pick', 'Pack', 'Receive', 'Ship', 'ICQA'];
            
            const data = [];
            const startDate = new Date('2024-01-01');
            
            for (let i = 0; i < 100; i++) {
                const date = new Date(startDate);
                date.setDate(date.getDate() + Math.floor(Math.random() * 365));
                
                const severity = severities[Math.floor(Math.random() * severities.length)];
                const likelihood = likelihoods[Math.floor(Math.random() * likelihoods.length)];
                
                data.push({
                    incident_id: `NM-${sites[i % sites.length]}-2024-${String(i + 1).padStart(3, '0')}`,
                    nearmiss_date: date.toISOString().split('T')[0],
                    site: sites[Math.floor(Math.random() * sites.length)],
                    initial_info_location_event: locations[Math.floor(Math.random() * locations.length)],
                    initial_info_process_path: processes[Math.floor(Math.random() * processes.length)],
                    initial_info_primary_impact: impacts[Math.floor(Math.random() * impacts.length)],
                    potential_severity: severity,
                    initial_risk_assessment_likeliness: likelihood,
                    risk: calculateRiskScore({ severity, standardized_likelihood: likelihood }),
                    rca_contributing_factor_category: 'Environmental Factors',
                    initial_info_incident_description: 'Sample near miss description for demonstration purposes',
                    rca_primary_cause: 'Hazardous Condition',
                    status: 'Closed'
                });
            }
            
            return data;
        }

        // Refresh Dashboard
        function refreshDashboard(type) {
            showStatus('Refreshing dashboard...', 'info');
            
            if (type === 'injury') {
                updateInjuryDashboard();
                updateInjuryTable();
                updateInjuryCharts();
            } else if (type === 'nearmiss') {
                updateNearMissDashboard();
                updateNearMissTable();
                updateNearMissCharts();
            }
            
            updateOverview();
            updateKPIs();
            
            setTimeout(() => {
                showStatus('Dashboard refreshed!', 'success');
            }, 500);
        }

        // Update All Charts (for theme change)
        function updateAllCharts() {
            // Update all injury charts
            if (state.injury.filteredData.length > 0) {
                updateInjuryCharts();
                updateInjuryAdvancedAnalytics();
            }
            
            // Update all near miss charts
            if (state.nearMiss.filteredData.length > 0) {
                updateNearMissCharts();
                updateNearMissAdvancedAnalytics();
            }
            
            // Update overview charts
            updateOverviewCharts();
            
            // Update combined charts
            if (state.currentModule === 'combined') {
                updateCombinedCharts();
            }
        }

        // Status Messages
        function showStatus(message, type = 'info') {
            const container = document.getElementById('statusContainer');
            if (!container) return;
            
            const statusDiv = document.createElement('div');
            statusDiv.className = `status-message status-${type}`;
            
            const icon = type === 'success' ? '‚úÖ' : 
                        type === 'error' ? '‚ùå' : 
                        type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            statusDiv.innerHTML = `
                <span>${icon}</span>
                <span>${message}</span>
            `;
            
            container.appendChild(statusDiv);
            
            setTimeout(() => {
                statusDiv.style.opacity = '0';
                setTimeout(() => {
                    statusDiv.remove();
                }, 300);
            }, 3000);
        }

        // Event Listeners
        function setupEventListeners() {
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('detailModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(event) {
                // Ctrl/Cmd + S to save/export
                if ((event.ctrlKey || event.metaKey) && event.key === 's') {
                    event.preventDefault();
                    exportToExcel('all');
                }
                
                // Escape to close modal
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        }

        // Initialize tooltips and other UI enhancements
        document.addEventListener('DOMContentLoaded', function() {
            // Add any additional initialization here
        });
    </script>
</body>
</html>
